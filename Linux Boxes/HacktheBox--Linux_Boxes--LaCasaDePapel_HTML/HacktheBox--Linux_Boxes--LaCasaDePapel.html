<!DOCTYPE html>
<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="content-type"/>
<title>LaCasaDePapel</title>
<meta content="CherryTree" name="generator"/>
<link href="styles.css" rel="stylesheet" type="text/css"/>
</head>
<body><div class="main"><div class="tree">
<p><a href="../HacktheBox--Linux_Boxes.html">Linux Boxes</a></p>
<p><a href="#LaCasaDePapel">LaCasaDePapel</a></p>
<ol>
<li><a href="#nmapAuto">nmapAuto</a></li>
<ol>
<li><a href="#nmap">nmap</a></li>
<ol>
<li><a href="#recon">recon</a></li>
<ol>
<li><a href="#nikto">nikto</a></li>
<li><a href="#gobuster">gobuster</a></li>
</ol>
</ol>
</ol>
<li><a href="#vsftp 2.3.4 exploit">vsftp 2.3.4 exploit</a></li>
<ol>
<li><a href="#open backdoor on port 6200 with :)">open backdoor on port 6200 with :)</a></li>
<ol>
<li><a href="#rlwrap nc to port 6200">rlwrap nc to port 6200</a></li>
<ol>
<li><a href="#phpinfo()">phpinfo()</a></li>
<li><a href="#scandir">scandir</a></li>
</ol>
</ol>
<li><a href="#interesting files">interesting files</a></li>
<ol>
<li><a href="#ls $tokyo">ls $tokyo</a></li>
<li><a href="#using vi to clean up nairobi's key">using vi to clean up nairobi's key</a></li>
<ol>
<li><a href="#nairobi's public key">nairobi's public key</a></li>
</ol>
<li><a href="#/etc/passwd">/etc/passwd</a></li>
</ol>
</ol>
<li><a href="#initial foothold">initial foothold</a></li>
<ol>
<li><a href="#dl cert">dl cert</a></li>
<ol>
<li><a href="#compare public keys of nairobi's key and webserver's key">compare public keys of nairobi's key and webserver's key</a></li>
</ol>
<li><a href="#generate client key">generate client key</a></li>
<ol>
<li><a href="#certificate sign request data">certificate sign request data</a></li>
<li><a href="#convert to PKCS12">convert to PKCS12</a></li>
<ol>
<li><a href="#info">info</a></li>
</ol>
<li><a href="#add key to firefox certificate store">add key to firefox certificate store</a></li>
<li><a href="#add ca.crt to firefox">add ca.crt to firefox</a></li>
<li><a href="#refresh page">refresh page</a></li>
</ol>
<li><a href="#Local file Inclusion Vuln">Local file Inclusion Vuln</a></li>
<ol>
<li><a href="#.ssh">.ssh</a></li>
</ol>
<li><a href="#ssh into professor acct">ssh into professor acct</a></li>
<li><a href="#user.txt">user.txt</a></li>
</ol>
<li><a href="#privesc">privesc</a></li>
<ol>
<li><a href="#pspy">pspy</a></li>
<li><a href="#memcache.ini">memcache.ini</a></li>
<li><a href="#using professor's directory ownership to our advantage">using professor's directory ownership to our advantage</a></li>
<li><a href="#revshell">revshell</a></li>
</ol>
<li><a href="#user/root">user/root</a></li>
<li><a href="#lessons learned">lessons learned</a></li>
</ol></div>
<div class="page"><h1><b><u>LaCasaDePapel</u></b></h1><img alt="images/1299-1.png" src="images/1299-1.png"/><br/><img alt="images/1299-2.png" src="images/1299-2.png"/></div>
</body></html><div class="page" id="LaCasaDePapel"><h1><b><u>LaCasaDePapel</u></b></h1><img alt="images/1299-1.png" src="images/1299-1.png"/><br/><img alt="images/1299-2.png" src="images/1299-2.png"/></div>
<div class="page" id="nmapAuto"><h1><b><u>nmapAuto</u></b></h1><span style="color:#ffa500;">nmap<br/>recon<br/></span></div>
<div class="page" id="nmap"><h1><b><u>nmap</u></b></h1><img alt="images/1301-1.png" src="images/1301-1.png"/><br/><img alt="images/1301-2.png" src="images/1301-2.png"/><br/><br/></div>
<div class="page" id="recon"><h1><b><u>recon</u></b></h1><span style="color:#ffa500;">nikto <br/>gobuster</span></div>
<div class="page" id="nikto"><h1><b><u>nikto</u></b></h1><span style="color:#ffa500;">http<br/></span><img alt="images/1331-1.png" src="images/1331-1.png"/><br/>https<br/><img alt="images/1331-2.png" src="images/1331-2.png"/></div>
<div class="page" id="gobuster"><h1><b><u>gobuster</u></b></h1><span style="color:#24ff00;">no finds on the http server</span><br/><img alt="images/1329-1.png" src="images/1329-1.png"/></div>
<div class="page" id="vsftp 2.3.4 exploit"><h1><b><u>vsftp 2.3.4 exploit</u></b></h1><span style="color:#24ff00;">doing a little googling, </span><span style="color:#ffa500;">vsftpd 2.3.4</span><span style="color:#24ff00;"> is infamous</span><br/><br/><img alt="images/1352-1.png" src="images/1352-1.png"/><br/><br/><img alt="images/1352-2.png" src="images/1352-2.png"/><br/><br/><img alt="images/1352-3.png" src="images/1352-3.png"/><br/><br/><img alt="images/1352-4.png" src="images/1352-4.png"/></div>
<div class="page" id="open backdoor on port 6200 with :)"><h1><b><u>open backdoor on port 6200 with :)</u></b></h1><img alt="images/1353-1.png" src="images/1353-1.png"/><br/><br/><span style="color:#24ff00;">typing </span><span style="color:#ffa500;">steve:)</span><span style="color:#24ff00;"> to trigger the backdoor</span><br/><img alt="images/1353-2.png" src="images/1353-2.png"/><br/><br/><span style="color:#24ff00;">and </span><span style="color:#ffa500;">nmap</span><span style="color:#24ff00;"> again:</span><br/><img alt="images/1353-3.png" src="images/1353-3.png"/><br/><span style="color:#24ff00;">port is open, lets connect</span></div>
<div class="page" id="rlwrap nc to port 6200"><h1><b><u>rlwrap nc to port 6200</u></b></h1><span style="color:#24ff00;">we can use </span><span style="color:#ffa500;">netcat</span><span style="color:#24ff00;"> to connect to our victim on port </span><span style="color:#ffa500;">6200</span><br/><br/><strong><span style="color:#ffa500;">rlwrap</span></strong> <span style="color:#24ff00;">is a script that allows our shell to arrow up to past commands which is incredibly convenient in this scenario</span><br/><br/><br/><br/></div>
<div class="page" id="phpinfo()"><h1><b><u>phpinfo()</u></b></h1><img alt="images/1355-1.png" src="images/1355-1.png"/><br/><br/><span style="color:#24ff00;">we see we're logged in as user </span><span style="color:#ffff00;">dali</span><br/><img alt="images/1355-2.png" src="images/1355-2.png"/><br/><br/></div>
<div class="page" id="scandir"><h1><b><u>scandir</u></b></h1><span style="color:#24ff00;">we can list the various folders of our victim by using the scan directory php command or </span><span style="color:#ffa500;">scandir</span><br/><img alt="images/1356-1.png" src="images/1356-1.png"/><img alt="images/1356-2.png" src="images/1356-2.png"/><img alt="images/1356-3.png" src="images/1356-3.png"/><img alt="images/1356-4.png" src="images/1356-4.png"/><img alt="images/1356-5.png" src="images/1356-5.png"/><br/><br/><br/> </div>
<div class="page" id="interesting files"><h1><b><u>interesting files</u></b></h1><span style="color:#24ff00;">1. </span><span style="color:#ffa500;">nairobi's</span><span style="color:#24ff00;"> ssh key</span><br/> <img alt="images/1357-1.png" src="images/1357-1.png"/><br/>2. </div>
<div class="page" id="ls $tokyo"><h1><b><u>ls $tokyo</u></b></h1><span style="color:#24ff00;">if we ‘</span><span style="color:#ffa500;">ls</span><span style="color:#24ff00;">’</span><br/><br/><img alt="images/1376-1.png" src="images/1376-1.png"/><br/><br/><br/><span style="color:#24ff00;">we see </span><strong><span style="color:#24ff00;">file_get_contents('</span></strong><strong><span style="color:#ffa500;">/home/nairobi/ca.key</span></strong><strong><span style="color:#24ff00;">')</span></strong><img alt="images/1376-2.png" src="images/1376-2.png"/><br/>and also the cert is in x509 format<img alt="images/1376-3.png" src="images/1376-3.png"/><br/><img alt="images/1376-4.png" src="images/1376-4.png"/><br/><br/></div>
<div class="page" id="using vi to clean up nairobi's key"><h1><b><u>using vi to clean up nairobi's key</u></b></h1><strong><span style="color:#24ff00;">1st to get rid of the ‘</span></strong><strong><span style="color:#ffa500;">\n</span></strong><strong><span style="color:#24ff00;">’s</span></strong><br/><img alt="images/1358-1.png" src="images/1358-1.png"/><br/><br/><img alt="images/1358-2.png" src="images/1358-2.png"/> <br/><span style="color:#ffa500;">:%s/\\n/g</span><br/><span style="color:#24ff00;">1. </span><span style="color:#ffa500;">%s/</span><span style="color:#24ff00;"> to initiate remove<br/>2. </span><span style="color:#ffa500;">\\n </span><span style="color:#24ff00;">is to remove ‘\n’ character<br/>3. </span><span style="color:#ffa500;">/g</span><span style="color:#24ff00;"> is to finish</span><br/><br/><span style="color:#24ff00;">Next we need to remove the leading spaces, do that manually</span><br/><br/></div>
<div class="page" id="nairobi's public key"><h1><b><u>nairobi's public key</u></b></h1><span style="color:#24ff00;">we can get </span><span style="color:#ffff00;">nairobi's</span><span style="color:#24ff00;"> public key with a simple openssl command</span><br/><br/><img alt="images/1362-1.png" src="images/1362-1.png"/><br/><br/><span style="color:#ffa500;">openssl pkey -in &lt;private key&gt; -pubout</span><br/><img alt="images/1362-2.png" src="images/1362-2.png"/></div>
<div class="page" id="/etc/passwd"><h1><b><u>/etc/passwd</u></b></h1><img alt="images/1359-1.png" src="images/1359-1.png"/></div>
<div class="page" id="initial foothold"><h1><b><u>initial foothold</u></b></h1><img alt="images/1375-1.png" src="images/1375-1.png"/></div>
<div class="page" id="dl cert"><h1><b><u>dl cert</u></b></h1><span style="color:#24ff00;">first we export the certificate to our directory, I also renamed it ca.crt</span><br/><br/><img alt="images/1361-1.png" src="images/1361-1.png"/><br/><img alt="images/1361-2.png" src="images/1361-2.png"/><br/><br/></div>
<div class="page" id="compare public keys of nairobi's key and webserver's key"><h1><b><u>compare public keys of nairobi's key and webserver's key</u></b></h1><span style="color:#24ff00;">we can compare the </span><span style="color:#ffff00;">webserver</span><span style="color:#24ff00;">'s key with </span><span style="color:#ffff00;">nairobi's</span><span style="color:#24ff00;"> key that we extracted earlier</span><br/><br/><img alt="images/1363-1.png" src="images/1363-1.png"/><br/><br/><span style="color:#24ff00;">and we generate our certificate's public key with the following (cert says its x509 on the form)</span><br/><br/><span style="color:#ffa500;">openssl x509 -in ca.crt -pubkey -noout</span><br/><img alt="images/1363-2.png" src="images/1363-2.png"/><br/><br/><span style="color:#24ff00;">we have the </span><span style="color:#ffff00;">private key </span><span style="color:#24ff00;">to the </span><span style="color:#ffff00;">certificate authority</span><span style="color:#24ff00;"> used to trust this webserver</span><br/><br/><strong><span style="color:#00ff00;">(they are the same) what does this mean? -we have the private key to the certificate authority used to trust this webserver -→ so we can generate a client key-&gt;&gt;&gt;</span></strong></div>
<div class="page" id="generate client key"><h1><b><u>generate client key</u></b></h1><span style="color:#24ff00;">we have the </span><span style="color:#ffff00;">private key </span><span style="color:#24ff00;">to the </span><span style="color:#ffff00;">certificate authority</span><span style="color:#24ff00;"> used to trust this webserver<br/>so we can generate a client key</span><br/><br/><span style="color:#ffa500;">openssl genrsa -out client.key 4096</span><br/><img alt="images/1364-1.png" src="images/1364-1.png"/><br/><img alt="images/1364-2.png" src="images/1364-2.png"/><br/><br/><span style="color:#24ff00;">now we have to create a certificate signing request:</span><br/><br/><span style="color:#ffa500;">openssl req -new -key client.key -out client.csr</span><br/><img alt="images/1364-3.png" src="images/1364-3.png"/><br/><br/><br/><span style="color:#24ff00;">now we have our certificate signing request, but now we have to sign it</span><br/><br/><span style="color:#ffa500;">openssl x509 -req -in client.csr -CA ca.crt -CAkey nairobi_ca_key -set_serial 9001 -extensions client -days 9002 -outform PEM -out client.cer</span><br/><img alt="images/1364-4.png" src="images/1364-4.png"/><br/><br/><br/><br/><span style="color:#00ff00;">now we have a </span><span style="color:#ffff00;">signed certificate</span><span style="color:#00ff00;">, but unfortunately </span><span style="color:#ffa500;">firefox</span><span style="color:#00ff00;"> cannot import it, it has to be in </span><span style="color:#ffa500;">PKCS12</span></div>
<div class="page" id="certificate sign request data"><h1><b><u>certificate sign request data</u></b></h1><img alt="images/1365-1.png" src="images/1365-1.png"/><br/><span style="color:#24ff00;">Here are my settings, feel free to input whatever you want, it makes no difference</span><br/><span style="color:#ffa500;">country:US<br/>State:OH<br/>Locality:SC<br/>ON:xiong<br/>OU name:mao<br/>CN:maoxiong<br/>email:xiong@miaomao.now<br/>pass:miao</span></div>
<div class="page" id="convert to PKCS12"><h1><b><u>convert to PKCS12</u></b></h1><strong><span style="color:#ffa500;">openssl pkcs12 -export -inkey client.key -in client.cer -out client.p12</span></strong><br/><span style="color:#ffff00;">password=miao</span><br/><img alt="images/1366-1.png" src="images/1366-1.png"/><br/><br/><br/><br/><span style="color:#24ff00;">p12 key is a combination of </span><span style="color:#ffa500;">client.cer</span><span style="color:#24ff00;"> and </span><span style="color:#ffa500;">client.key</span><br/><img alt="images/1366-2.png" src="images/1366-2.png"/><br/><br/></div>
<div class="page" id="info"><h1><b><u>info</u></b></h1><span style="color:#24ff00;">to view our certificate info:</span><br/><br/><span style="color:#ffa500;">openssl pkcs12 -info -in client.p12</span><br/><img alt="images/1367-1.png" src="images/1367-1.png"/><br/><br/><img alt="images/1367-2.png" src="images/1367-2.png"/><br/><br/><img alt="images/1367-3.png" src="images/1367-3.png"/><br/><br/><img alt="images/1367-4.png" src="images/1367-4.png"/><br/><img alt="images/1367-5.png" src="images/1367-5.png"/></div>
<div class="page" id="add key to firefox certificate store"><h1><b><u>add key to firefox certificate store</u></b></h1><span style="color:#24ff00;">search for certification in </span><span style="color:#ffa500;">firefox's</span><span style="color:#24ff00;"> settings</span><br/><img alt="images/1368-1.png" src="images/1368-1.png"/><br/><br/><img alt="images/1368-2.png" src="images/1368-2.png"/><br/><br/><img alt="images/1368-3.png" src="images/1368-3.png"/><br/><br/><img alt="images/1368-4.png" src="images/1368-4.png"/></div>
<div class="page" id="add ca.crt to firefox"><h1><b><u>add ca.crt to firefox</u></b></h1><span style="color:#24ff00;">make sure the </span><span style="color:#ffa500;">trust</span><span style="color:#24ff00;"> settings are set to identify websites</span><br/><img alt="images/1370-1.png" src="images/1370-1.png"/><br/><img alt="images/1370-2.png" src="images/1370-2.png"/><br/><br/><img alt="images/1370-3.png" src="images/1370-3.png"/><br/></div>
<div class="page" id="refresh page"><h1><b><u>refresh page</u></b></h1><img alt="images/1369-1.png" src="images/1369-1.png"/><h2><br/><br/>we see this animation move around a bit and...<br/></h2><img alt="images/1369-2.png" src="images/1369-2.png"/><br/><br/>we're in the private area<br/><img alt="images/1369-3.png" src="images/1369-3.png"/><br/>https://10.10.10.131/file/U0VBU09OLTEvMDEuYXZp</div>
<div class="page" id="Local file Inclusion Vuln"><h1><b><u>Local file Inclusion Vuln</u></b></h1><span style="color:#24ff00;">LFI: we see the path variable can load other directories on our victim as well:</span><br/><br/><span style="color:#ffa500;">https://10.10.10.131/?path=..</span><br/><img alt="images/1371-1.png" src="images/1371-1.png"/><br/><img alt="images/1371-2.png" src="images/1371-2.png"/><br/><span style="color:#24ff00;">we've successfully navigated to another directory on the box, proving it has a </span><span style="color:#ffa500;">local file inclusion</span><span style="color:#24ff00;"> vulnerability</span></div>
<div class="page" id=".ssh"><h1><b><u>.ssh</u></b></h1><img alt="images/1377-1.png" src="images/1377-1.png"/><br/><br/><img alt="images/1377-2.png" src="images/1377-2.png"/><br/><br/><img alt="images/1377-3.png" src="images/1377-3.png"/><br/><br/><img alt="images/1377-4.png" src="images/1377-4.png"/><br/><img alt="images/1377-5.png" src="images/1377-5.png"/></div>
<div class="page" id="ssh into professor acct"><h1><b><u>ssh into professor acct</u></b></h1><span style="color:#24ff00;">using the </span><span style="color:#ffff00;">rsa_id</span><span style="color:#24ff00;"> private key we downloaded, we can use trial and error to see which user owns this key and log into them via </span><span style="color:#ffa500;">ssh</span><span style="color:#24ff00;"><br/><br/>after trying each user found earlier </span><img alt="images/1378-1.png" src="images/1378-1.png"/><br/><br/><br/><img alt="images/1378-2.png" src="images/1378-2.png"/><br/><br/>we have our <span style="color:#ffff00;">foothold</span><span style="color:#24ff00;">!</span><br/><img alt="images/1378-3.png" src="images/1378-3.png"/></div>
<div class="page" id="user.txt"><h1><b><u>user.txt</u></b></h1><img alt="images/1382-1.png" src="images/1382-1.png"/><br/><br/><img alt="images/1382-2.png" src="images/1382-2.png"/></div>
<div class="page" id="privesc"><h1><b><u>privesc</u></b></h1><span style="color:#ffa500;">pspy<br/>memcache.ini<br/>using professor's directory ownership to our advantage<br/><br/><br/><br/></span></div>
<div class="page" id="pspy"><h1><b><u>pspy</u></b></h1><span style="color:#24ff00;">lets monitor the processes on the box and see what we can find out<br/><br/>1. first set up our httpserver in the same directory as our pspy script </span><img alt="images/1379-1.png" src="images/1379-1.png"/><img alt="images/1379-2.png" src="images/1379-2.png"/><br/>2. download it to our victim <img alt="images/1379-3.png" src="images/1379-3.png"/><br/>3. run it and check for interesting processes<br/><span style="color:#ffa500;">./pspy64 -f </span><br/><span style="color:#ffa500;">-f</span><span style="color:#24ff00;"> -&gt; file system events<br/></span><img alt="images/1379-4.png" src="images/1379-4.png"/><br/><br/></div>
<div class="page" id="memcache.ini"><h1><b><u>memcache.ini</u></b></h1><span style="color:#24ff00;">we see </span><span style="color:#ffa500;">memcache.ini</span><span style="color:#24ff00;"> is being called every few minutes <br/><br/></span><img alt="images/1380-1.png" src="images/1380-1.png"/><br/><br/><img alt="images/1380-2.png" src="images/1380-2.png"/><br/><br/>checking the file we see its owned by <span style="color:#ffff00;">root</span><span style="color:#24ff00;"> and that we can only read the file</span><br/><img alt="images/1380-3.png" src="images/1380-3.png"/><br/><img alt="images/1380-4.png" src="images/1380-4.png"/><br/><br/></div>
<div class="page" id="using professor's directory ownership to our advantage"><h1><b><u>using professor's directory ownership to our advantage</u></b></h1><span style="color:#00ff00;">Although we </span><span style="color:#ff0000;">do not </span><span style="color:#00ff00;">have permission to make changes to memcache.ini since root wrote it, professor DOES however, own his own /</span><span style="color:#ffa500;">home/professor </span><span style="color:#00ff00;">directory <br/><br/></span><img alt="images/1381-1.png" src="images/1381-1.png"/><br/><img alt="images/1381-2.png" src="images/1381-2.png"/><br/><br/><img alt="images/1381-3.png" src="images/1381-3.png"/><br/><br/>meaning we can simply <span style="color:#ffff00;">move/rename</span><span style="color:#00ff00;"> </span><span style="color:#ffa500;">memcache.ini </span><span style="color:#00ff00;">within our directory, allowing us to write our own </span><span style="color:#ffa500;">memcache.ini </span><span style="color:#00ff00;">that will be called in the schdeuled process we observed from </span><span style="color:#ffa500;">pspy</span><br/><img alt="images/1381-4.png" src="images/1381-4.png"/><br/><img alt="images/1381-5.png" src="images/1381-5.png"/><br/><img alt="images/1381-6.png" src="images/1381-6.png"/><br/><br/><br/><img alt="images/1381-7.png" src="images/1381-7.png"/><br/><br/><span style="color:#24ff00;">finally, we replace the </span><span style="color:#ffa500;">command</span><span style="color:#24ff00;"> variable with a reverse shell of our own</span><br/><img alt="images/1381-8.png" src="images/1381-8.png"/><br/><img alt="images/1381-9.png" src="images/1381-9.png"/><br/><img alt="images/1381-10.png" src="images/1381-10.png"/><br/><img alt="images/1381-11.png" src="images/1381-11.png"/><br/><br/><br/></div>
<div class="page" id="revshell"><h1><b><u>revshell</u></b></h1><span style="color:#24ff00;">wait for the </span><span style="color:#ffa500;">memcache.ini</span><span style="color:#24ff00;"> to run and voila!</span><br/><img alt="images/1383-1.png" src="images/1383-1.png"/></div>
<div class="page" id="user/root"><h1><b><u>user/root</u></b></h1><img alt="images/1373-1.png" src="images/1373-1.png"/><br/><span style="color:#ffff00;">4dcbd172fc9c9ef2ff65c13448d9062d<br/><br/></span><img alt="images/1373-2.png" src="images/1373-2.png"/><br/>586979c48efbef5909a23750cc07f511<br/><br/></div>
<div class="page" id="lessons learned"><h1><b><u>lessons learned</u></b></h1><span style="color:#24ff00;">Check out Rana Khalil's OSCP writeups and prep at</span> <a href="https://rana-khalil.gitbook.io/hack-the-box-oscp-preparation/">https://rana-khalil.gitbook.io/hack-the-box-oscp-preparation/</a><br/><br/><img alt="images/1374-1.png" src="images/1374-1.png"/><br/><br/></div>
</div></body></html>