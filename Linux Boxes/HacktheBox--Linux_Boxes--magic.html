<!DOCTYPE html>
<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="content-type"/>
<title>magic</title>
<meta content="CherryTree" name="generator"/>
<link href="styles.css" rel="stylesheet" type="text/css"/>
</head>
<body><div class="main"><div class="tree">
<p><a href="HacktheBox--Linux_Boxes.html">Linux Boxes</a></p>
<p><a href="#magic">magic</a></p>
<ol>
<li><a href="#nmap">nmap</a></li>
<li><a href="#gobuster">gobuster</a></li>
<li><a href="#initial foothold">initial foothold</a></li>
<ol>
<li><a href="#login.php">login.php</a></li>
<ol>
<li><a href="#manual">manual</a></li>
<li><a href="#sqlmap">sqlmap</a></li>
</ol>
<li><a href="#upload.php">upload.php</a></li>
<ol>
<li><a href="#duck.jpg">duck.jpg</a></li>
<li><a href="#cmd.php.png">cmd.php.png</a></li>
<ol>
<li><a href="#url">url</a></li>
</ol>
<li><a href="#revshell.py">revshell.py</a></li>
<ol>
<li><a href="#tcp_backconnect.py">tcp_backconnect.py</a></li>
</ol>
</ol>
</ol>
<li><a href="#priv esc to theseus">priv esc to theseus</a></li>
<ol>
<li><a href="#db.php5">db.php5</a></li>
<li><a href="#mysql">mysql</a></li>
</ol>
<li><a href="#priv esc to root">priv esc to root</a></li>
<ol>
<li><a href="#lse.sh -l 1">lse.sh -l 1</a></li>
<li><a href="#linpeas">linpeas</a></li>
<li><a href="#systemctl list-timers">systemctl list-timers</a></li>
<li><a href="#ltrace /bin/sysinfo">ltrace /bin/sysinfo</a></li>
<ol>
<li><a href="#lshw">lshw</a></li>
<li><a href="#hijack lshw PATH">hijack lshw PATH</a></li>
<li><a href="#run sysinfo">run sysinfo</a></li>
<ol>
<li><a href="#problem, no output">problem, no output</a></li>
</ol>
</ol>
</ol>
<li><a href="#user/root">user/root</a></li>
</ol></div>
<div class="page" id="magic"><h1><b><u>magic</u></b></h1><img alt="images/1903-1.png" src="images/1903-1.png"/><br/><img alt="images/1903-2.png" src="images/1903-2.png"/></div>
<div class="page" id="nmap"><h1><b><u>nmap</u></b></h1><img alt="images/1904-1.png" src="images/1904-1.png"/><br/><span style="color:#24ff00;">port </span><span style="color:#ffa500;">22</span><span style="color:#24ff00;"> is open running </span><span style="color:#ffa500;">ssh OpenSSH 7.6p1</span><span style="color:#24ff00;"><br/>port </span><span style="color:#ffa500;">80</span><span style="color:#24ff00;"> is open running </span><span style="color:#ffa500;">http Apache/2.4.29</span></div>
<div class="page" id="gobuster"><h1><b><u>gobuster</u></b></h1><img alt="images/1907-1.png" src="images/1907-1.png"/></div>
<div class="page" id="initial foothold"><h1><b><u>initial foothold</u></b></h1><span style="color:#24ff00;">to get our initial foothold we use</span> <span style="color:#ffa500;">SQL</span><span style="color:#24ff00;"> </span><span style="color:#ffa500;">injection</span><span style="color:#24ff00;"> to escape out of poorly input validated server side SQL query in order to bypass authentication past the login page and use a sql boolean blind sqlinjection to dump usernames and passwords from the database with </span><span style="color:#ffa500;">sqlmap</span><span style="color:#24ff00;"><br/><br/>from there we upload a </span><span style="color:#ffa500;">php RCE</span><span style="color:#24ff00;"> script that we will hide behind a picture file's </span><span style="color:#ffff00;">magic bytes</span><span style="color:#24ff00;"> in order to trick the server into thinking our malicious script is a harmless picture file <br/><br/>from there, we'll use burp suite to facilitate manipulating our php cmd to help us upload a python reverse shell and pop a shell on our attacking machine</span></div>
<div class="page" id="login.php"><h1><b><u>login.php</u></b></h1><img alt="images/1905-1.png" src="images/1905-1.png"/><br/><img alt="images/1905-2.png" src="images/1905-2.png"/></div>
<div class="page" id="manual"><h1><b><u>manual</u></b></h1><span style="color:#24ff00;">this script cuts off the mysql query and allows us to bypass authentication as the webserver admin without a password!</span><br/><br/><span style="color:#ffff00;">use </span><span style="color:#ffa500;">' </span><span style="color:#ffff00;">to create a quote mismatch, create a true statement with </span><span style="color:#ffa500;">OR 1=1</span><span style="color:#ffff00;"> and then comment the rest of the query out with</span><span style="color:#ffa500;"> #</span><br/><span style="color:#ffa500;">' OR 1=1 #</span><br/><img alt="images/1914-1.png" src="images/1914-1.png"/><br/><br/><span style="color:#24ff00;">later along after we get our foothold on the box we can check out login.php's source code to look at the query we're breaking:</span><br/><img alt="images/1914-2.png" src="images/1914-2.png"/><br/><br/><span style="color:#24ff00;">we see the query is literally </span><span style="color:#ffa500;">SELECT * FROM login WHERE username ='$username' AND password='$password'</span><br/><span style="color:#24ff00;">which is highly susceptable to sql injection exploitation</span><br/><img alt="images/1914-3.png" src="images/1914-3.png"/><br/><br/></div>
<div class="page" id="sqlmap"><h1><b><u>sqlmap</u></b></h1><img alt="images/1928-1.png" src="images/1928-1.png"/><br/><br/><span style="color:#ffa500;">sqlmap --user-agent="Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101" -r request.txt --level=5 =p username -risk=3 --string="alert" --dump</span><br/><span style="color:#ffff00;">Th3s3usW4sK1ng</span><br/><img alt="images/1928-2.png" src="images/1928-2.png"/></div>
<div class="page" id="upload.php"><h1><b><u>upload.php</u></b></h1><span style="color:#ffa500;">http://10.10.10.185/upload.php</span><br/><br/><img alt="images/1906-1.png" src="images/1906-1.png"/><br/><img alt="images/1906-2.png" src="images/1906-2.png"/><br/><img alt="images/1906-3.png" src="images/1906-3.png"/><br/><br/><br/><br/></div>
<div class="page" id="duck.jpg"><h1><b><u>duck.jpg</u></b></h1><span style="color:#24ff00;">here are the magic bytes from</span><span style="color:#ffa500;"> duck.jpg </span><span style="color:#24ff00;">downloaded from the website for reupload purposes</span><br/><br/><img alt="images/1918-1.png" src="images/1918-1.png"/><br/><br/><img alt="images/1918-2.png" src="images/1918-2.png"/><br/><br/><img alt="images/1918-3.png" src="images/1918-3.png"/><br/><br/></div>
<div class="page" id="cmd.php.png"><h1><b><u>cmd.php.png</u></b></h1><span style="color:#24ff00;">we can easily use the magic bytes from our duck.png upload and tack on our </span><span style="color:#ffa500;">php system call code </span><span style="color:#24ff00;">after it to trick the server into thinking it is a harmless picture file</span><br/><br/><img alt="images/1931-1.png" src="images/1931-1.png"/><br/><br/><br/><img alt="images/1931-2.png" src="images/1931-2.png"/><br/><br/><br/><br/></div>
<div class="page" id="url"><h1><b><u>url</u></b></h1><span style="color:#24ff00;">lets navigate to our uploaded file and test to see if we have remote code execution:</span><br/><br/><img alt="images/1932-1.png" src="images/1932-1.png"/><br/><br/><span style="color:#24ff00;">the executed</span> <span style="color:#ffa500;">whoami</span> <span style="color:#24ff00;">command confirms we are executing code as </span><span style="color:#ffff00;">www-data</span><br/><img alt="images/1932-2.png" src="images/1932-2.png"/></div>
<div class="page" id="revshell.py"><h1><b><u>revshell.py</u></b></h1><span style="color:#24ff00;">we'll be using</span><span style="color:#ffa500;"> tcp_pty_shell_handler.py</span> <span style="color:#24ff00;">and</span> <span style="color:#ffa500;">tcp_pty_bashconnect.py</span> <span style="color:#24ff00;">to gain our foothold because the server runs</span><span style="color:#ffa500;"> python3</span><br/><br/><img alt="images/1933-1.png" src="images/1933-1.png"/><br/><br/><img alt="images/1933-2.png" src="images/1933-2.png"/><br/><br/><img alt="images/1933-3.png" src="images/1933-3.png"/><br/><br/><span style="color:#24ff00;">to prove that it is saved on our victim we'll </span><span style="color:#ffa500;">cat</span><span style="color:#24ff00;"> the file in our request and check the server response</span><br/><img alt="images/1933-4.png" src="images/1933-4.png"/><br/><br/><span style="color:#24ff00;">because we see our </span><span style="color:#ffa500;">revshell's</span><span style="color:#24ff00;"> source code in the server response we can confirm it has been saved onto our victim</span><br/><img alt="images/1933-5.png" src="images/1933-5.png"/></div>
<div class="page" id="tcp_backconnect.py"><h1><b><u>tcp_backconnect.py</u></b></h1><span style="color:#24ff00;">all that is left is to call our python based revshell with python </span><span style="color:#ffa500;">/dev/shm/revshell.py</span><span style="color:#24ff00;"> and catch it with out </span><span style="color:#ffa500;">tcp_pty_shell_handler.py </span><br/><br/><img alt="images/1934-1.png" src="images/1934-1.png"/><br/><br/><span style="color:#24ff00;">and we have our foothold!</span><br/><img alt="images/1934-2.png" src="images/1934-2.png"/></div>
<div class="page" id="priv esc to theseus"><h1><b><u>priv esc to theseus</u></b></h1><span style="color:#24ff00;">to priv esc to </span><span style="color:#ffff00;">thesius</span><span style="color:#24ff00;"> we have to check the webserver files </span><span style="color:#ffff00;">(</span><span style="color:#ffa500;">db.php5</span><span style="color:#ffff00;">)</span><span style="color:#24ff00;"> for leaked mysql creds and then use mysqldump to dump his terminal password to privesc</span></div>
<div class="page" id="db.php5"><h1><b><u>db.php5</u></b></h1><span style="color:#24ff00;">mysql database = </span><span style="color:#ffff00;">Magic</span><span style="color:#24ff00;"><br/>mysql username = </span><span style="color:#ffff00;">theseus</span><span style="color:#24ff00;"> <br/>mysql password = </span><span style="color:#ffff00;">iamkingtheseus</span><br/><br/><img alt="images/1917-1.png" src="images/1917-1.png"/></div>
<div class="page" id="mysql"><h1><b><u>mysql</u></b></h1><span style="color:#24ff00;">we can grab theseus' creds in the mysql database on the server by dumping its contents if we did not use sqlmap to dump his password earlier</span><br/><br/><span style="color:#ffa500;">mysqldump Magic -u theseus -p </span><br/>use <span style="color:#ffff00;">iamkingtheseus</span> for pw <br/><img alt="images/1915-1.png" src="images/1915-1.png"/><br/><br/><br/><span style="color:#24ff00;">the login table dumps Thesius's password </span><span style="color:#ffff00;">Th3s3usW4sK1ng</span><br/><img alt="images/1915-2.png" src="images/1915-2.png"/></div>
<div class="page" id="priv esc to root"><h1><b><u>priv esc to root</u></b></h1><span style="color:#24ff00;">here we run a couple of linux enumeration scripts to check for abnormalities on our victim box</span><br/><br/><span style="color:#ffff00;">lse.sh<br/>linpeas</span><br/><br/></div>
<div class="page" id="lse.sh -l 1"><h1><b><u>lse.sh -l 1</u></b></h1><span style="color:#24ff00;">we see here we have 2 very uncommon setuid binaries we ought to look into </span><br/><br/><img alt="images/1909-1.png" src="images/1909-1.png"/><br/><br/><span style="color:#24ff00;">SUID binaries</span><br/><img alt="images/1909-2.png" src="images/1909-2.png"/><br/><br/><span style="color:#24ff00;">cron jobs show some uncommon cron jobs on the box that may be worth looking into:</span><br/><img alt="images/1909-3.png" src="images/1909-3.png"/><br/><br/><span style="color:#24ff00;">lastly, looking at the process being run as root may reveal some potential vulnerabilities as well, but lets focus on that /bin/sysinfo binary first</span><br/><img alt="images/1909-4.png" src="images/1909-4.png"/><br/></div>
<div class="page" id="linpeas"><h1><b><u>linpeas</u></b></h1><span style="color:#24ff00;">running linpeas also catches the strange binary </span><span style="color:#ffa500;">/bin/sysinfo </span><span style="color:#24ff00;">and indicates it as a critical vulnerability due to its red font coloring</span><br/><img alt="images/1920-1.png" src="images/1920-1.png"/><br/><br/></div>
<div class="page" id="systemctl list-timers"><h1><b><u>systemctl list-timers</u></b></h1><span style="color:#24ff00;">nothing seems to stick out here for this CTF since the cron jobs run once every half hour at the earliest, if a cron job ran every few minutes that would be more of an indication that this is where we ought to look<br/></span><br/><img alt="images/1913-1.png" src="images/1913-1.png"/></div>
<div class="page" id="ltrace /bin/sysinfo"><h1><b><u>ltrace /bin/sysinfo</u></b></h1><img alt="images/1922-1.png" src="images/1922-1.png"/><br/><span style="color:#ffa500;">setuid 0 and setguid 0</span><br/><span style="color:#ffa500;">popen</span><span style="color:#24ff00;"> - to open a process -&gt;&gt;&gt;thats a thing we can absolutely abuse <br/>becasue it juse runs this command without any</span><span style="color:#ffff00;"> absolute path</span><br/><br/><span style="color:#24ff00;">this is HUGE because </span><span style="color:#ffa500;">lshw</span><span style="color:#24ff00;"> is being run without an absolute path in the code, meaning we can </span><span style="color:#ffff00;">hijack</span><span style="color:#24ff00;"> it </span></div>
<div class="page" id="lshw"><h1><b><u>lshw</u></b></h1><span style="color:#24ff00;">we're going to create our own </span><span style="color:#ffa500;">lshw</span><span style="color:#24ff00;"> command and </span><span style="color:#ffff00;">update the its PATH </span><span style="color:#24ff00;">variable so that whenever </span><span style="color:#ffa500;">/bin/sysinfo</span><span style="color:#24ff00;"> is called it will run our </span><span style="color:#ffa500;">lshw</span><span style="color:#24ff00;"> command instead of the intended one which we can have spawn a shell for us!</span><br/><br/><img alt="images/1923-1.png" src="images/1923-1.png"/><br/><br/><span style="color:#24ff00;">edit lshw in our new/ directory to run a bash shell with root privilieges<br/></span><img alt="images/1923-2.png" src="images/1923-2.png"/><br/><img alt="images/1923-3.png" src="images/1923-3.png"/><br/><br/><br/><br/></div>
<div class="page" id="hijack lshw PATH"><h1><b><u>hijack lshw PATH</u></b></h1><span style="color:#24ff00;">now we set our </span><span style="color:#ffa500;">/home/theseus/new</span><span style="color:#24ff00;">: path into our </span><span style="color:#ffff00;">PATH</span><span style="color:#24ff00;"> variable so our </span><span style="color:#ffa500;">lshw</span><span style="color:#24ff00;"> will run on default without an absolute path<br/></span><br/><img alt="images/1924-1.png" src="images/1924-1.png"/><br/><span style="color:#24ff00;">now when we run</span><span style="color:#ffa500;"> sysinfo</span><span style="color:#24ff00;">...</span></div>
<div class="page" id="run sysinfo"><h1><b><u>run sysinfo</u></b></h1><span style="color:#24ff00;">now when we run our sysinfo command we elevate our privileges to root! </span><br/><img alt="images/1925-1.png" src="images/1925-1.png"/></div>
<div class="page" id="problem, no output"><h1><b><u>problem, no output</u></b></h1><span style="color:#24ff00;">problem now is because sysinfo was a giant binary that had a lot of other functions running with lshw, we don't see we have <br/></span><img alt="images/1926-1.png" src="images/1926-1.png"/><br/><br/><span style="color:#24ff00;">but we can work around this error since we have root privileges in this shell to make </span><span style="color:#ffa500;">/bin/bash </span><span style="color:#24ff00;">an </span><span style="color:#ffff00;">SUID executable</span><span style="color:#24ff00;"> so theseus can run it with </span><span style="color:#ffff00;">root</span><span style="color:#24ff00;"> privileges</span><br/><img alt="images/1926-2.png" src="images/1926-2.png"/><br/><br/><img alt="images/1926-3.png" src="images/1926-3.png"/><br/><br/><br/><span style="color:#24ff00;">now we see</span><span style="color:#ffa500;"> /bin/bash</span><span style="color:#24ff00;"> now has its </span><span style="color:#ffff00;">SUID</span><span style="color:#24ff00;"> bit </span><br/><img alt="images/1926-4.png" src="images/1926-4.png"/><br/>]<br/><span style="color:#24ff00;">and we can properly elevate our privileges with </span><span style="color:#ffa500;">/bin/bash -p</span><br/><img alt="images/1926-5.png" src="images/1926-5.png"/></div>
<div class="page" id="user/root"><h1><b><u>user/root</u></b></h1><img alt="images/1908-1.png" src="images/1908-1.png"/><br/><span style="color:#ffff00;">7044731b1af10b98fe4992c60e6f0578</span><br/><br/><img alt="images/1908-2.png" src="images/1908-2.png"/><br/><br/><span style="color:#ffff00;">deec2a744f5192c1de2510a0ba4996a4</span></div>
</div></body></html>